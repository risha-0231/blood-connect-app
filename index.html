<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Connect Pro (Bengaluru Area Donor Matching)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
   
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script> 
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        /* Custom red button styling for primary actions */
        .btn-primary {
            background-color: #e53e3e;
            transition: background-color 0.15s ease, transform 0.1s ease;
        }
        .btn-primary:hover {
            background-color: #c53030;
            transform: translateY(-1px);
        }
        /* Main card styling - now fills more width */
        .main-card {
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            /* New: Wider card up to md screen, then constrained */
            width: 95%;
            max-width: 900px;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* MAP CONTAINER STYLE */
        #donorMap {
            height: 350px;
            width: 100%;
            border-radius: 0.75rem;
            border: 2px solid #e53e3e;
            margin-bottom: 1.5rem;
            z-index: 1;
        }
       
        /* NEW: Bubble/Card Styling for Role Selection (using standard CSS to avoid editor warning) */
        .role-bubble-card {
            /* Full shadow and hover effect */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-xl */
            min-height: 180px;
        }
        .role-bubble-card:hover {
             box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); /* shadow-2xl */
             transform: scale(1.03);
        }
        .donor-bubble {
            background-color: #fee2e2; /* Red-100 */
            border: 3px solid #f87171; /* Red-400 */
        }
        .hospital-bubble {
            background-color: #eff6ff; /* Blue-100 */
            border: 3px solid #60a5fa; /* Blue-400 */
        }
        .admin-bubble {
            background-color: #f3f4f6; /* Gray-100 */
            border: 3px solid #9ca3af; /* Gray-400 */
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8 flex justify-center items-start pt-6 sm:pt-10">
    <div class="main-card rounded-2xl p-6 sm:p-10 border-t-8 border-red-600">

        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-red-700">ü©∏ Blood Connect Pro (Bengaluru)</h1>
            <p class="text-gray-500 mt-2 text-xl font-semibold">Local Emergency Donor Matching System</p>
        </header>

       
        <div id="global-message-box" class="fixed inset-x-0 top-0 z-50 p-4 transition-all duration-300 transform -translate-y-full opacity-0">
            <div id="global-message-content" class="p-3 rounded-lg shadow-xl text-center font-medium max-w-lg mx-auto"></div>
        </div>

        <div id="loading-state" class="text-center p-12">
             <svg class="animate-spin h-10 w-10 text-red-600 mx-auto mb-4"
                  xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
             </svg>
             <p class="text-red-500 font-semibold">Initializing app components...</p>
        </div>
       
        <div id="role-selection" class="text-center p-6 sm:p-8 space-y-6">
             <h2 class="text-3xl font-bold text-red-700 mb-8">Select Your Role</h2>
             
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
               
                 <button data-role="Donor" class="select-role-btn role-bubble-card donor-bubble flex flex-col items-center justify-center p-6 text-red-700">
                      <svg class="w-12 h-12 mb-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.214-.076-.423-.22-.584m0 0a3.003 3.003 0 00-7.864-1.857M17 10v2a3 3 0 005.356 1.857M17 10v-2c0-.214-.076-.423-.22-.584M17 10v2a3 3 0 005.356 1.857M12 21a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2z"></path></svg>
                      <span class="text-xl font-extrabold">I am a Donor</span>
                      <span class="text-sm mt-1 text-gray-600">Volunteer to save lives locally.</span>
                 </button>
                 
                 <button data-role="Hospital" class="select-role-btn role-bubble-card hospital-bubble flex flex-col items-center justify-center p-6 text-blue-700">
                      <svg class="w-12 h-12 mb-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10h16V7a2 2 0 00-2-2H6a2 2 0 00-2 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v4m-2-2h4"></path></svg>
                      <span class="text-xl font-extrabold">I am a Hospital</span>
                      <span class="text-sm mt-1 text-gray-600">Submit urgent blood requirements.</span>
                 </button>
                 
                 <button id="select-admin-role-btn" class="role-bubble-card admin-bubble flex flex-col items-center justify-center p-6 text-gray-800">
                      <svg class="w-12 h-12 mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2v2m-4-2H7a2 2 0 00-2 2v4a2 2 0 002 2h4m2-4v4a2 2 0 01-2 2H7a2 2 0 01-2-2v-4a2 2 0 012-2h4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v2m0 0h.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18v2m0 0h.01"></path></svg>
                      <span class="text-xl font-extrabold">Administrator Login</span>
                      <span class="text-sm mt-1 text-gray-600">Manage users and requests.</span>
                 </button>
                 
             </div>
        </div>
       
        <div id="auth-selection" class="hidden text-center space-y-6 p-6 card shadow-none border-0 rounded-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome, <span id="auth-role-display" class="text-red-600"></span></h2>
            <p class="text-gray-600 text-base">Choose an action to proceed.</p>
           
            <button id="auth-login-btn" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">
                Login
            </button>
           
            <button id="auth-register-btn" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-4 focus:ring-red-300">
                Register
            </button>
           
            <p class="text-sm text-gray-500 pt-2">Login is only possible after admin verification.</p>
           
            <button type="button" id="auth-back-to-role" class="w-full text-sm text-gray-500 hover:text-red-500 mt-4">‚Üê Back to Role Selection</button>
        </div>

        <div id="user-login" class="hidden">
             <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3"><span id="login-role-display">User</span> Login</h2>
            <form id="user-login-form" class="space-y-4">
                 <div class="space-y-1">
                     <label for="login-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                     <input type="text" id="login-name" required placeholder="John Doe" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                 </div>
                 <div class="space-y-1">
                     <label for="login-phone" class="block text-sm font-medium text-gray-700">Phone Number (10 Digits)</label>
                     <input type="number" id="login-phone" required minlength="10" maxlength="10" placeholder="e.g., 9876543210" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                 </div>
                 <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">
                     Login to Dashboard
                 </button>
                 <button type="button" id="login-back-to-auth" class="w-full text-sm text-gray-500 hover:text-red-500 mt-2">‚Üê Back to Auth Menu</button>
                 <button type="button" id="login-back-to-role" class="hidden">‚Üê Back to Main Menu</button>
            </form>
        </div>


        <div id="admin-login" class="hidden">
             <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Administrator Login</h2>
            <form id="admin-login-form" class="space-y-4">
                 <div class="space-y-1">
                     <label for="admin-pin" class="block text-sm font-medium text-gray-700">Admin Key (Pin Code)</label>
                     <input type="password" id="admin-pin" required placeholder="Enter 6-digit Admin Key" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                 </div>
                 <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">
                     Login as Administrator
                 </button>
                 <button type="button" id="admin-back-to-role" class="w-full text-sm text-gray-500 hover:text-red-500 mt-2">‚Üê Back to Main Menu</button>
            </form>
        </div>

        <div id="profile-setup" class="hidden">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                 <h2 class="text-2xl font-bold text-gray-800"><span id="registration-role">New User</span> Registration</h2>
                 <button id="back-to-dashboard-from-edit" class="hidden text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100 flex items-center">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                      Back to Dashboard
                 </button>
            </div>
           
            <form id="profile-form" class="space-y-4">
                 <input type="hidden" id="userRoleHidden" value="Donor">

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div class="space-y-1">
                         <label for="name" class="block text-sm font-medium text-gray-700"><span id="name-label-text">Full Name</span></label>
                         <input type="text" id="name" required data-original-required="true" placeholder="John Doe" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                     <div class="space-y-1">
                         <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number (10 Digits)</label>
                         <input type="number" id="phone" required data-original-required="true" minlength="10" maxlength="10" placeholder="e.g., 9876543210" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                 </div>

                 <div class="grid grid-cols-3 gap-4 donor-only-field">
                     <div class="space-y-1">
                         <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                         <input type="number" id="age" required data-original-required="true" placeholder="e.g., 30" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                     <div class="space-y-1">
                         <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                         <select id="gender" required data-original-required="true" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 bg-white focus:ring-red-500 focus:border-red-500">
                             <option value="">Select</option>
                             <option value="Male">Male</option>
                             <option value="Female">Female</option>
                             <option value="Other">Other</option>
                         </select>
                     </div>
                     <div class="space-y-1">
                         <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                         <input type="number" id="weight" required data-original-required="true" placeholder="e.g., 65" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                 </div>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div class="space-y-1">
                         <label for="pinCode" class="block text-sm font-medium text-gray-700">Pin Code (6-Digit - Your Home Area)</label>
                         <input type="number" id="pinCode" required data-original-required="true" min="100000" max="999999" placeholder="e.g., 560078 (JP Nagar)" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                     <div class="space-y-1 donor-only-field">
                         <label for="bloodType" class="block text-sm font-medium text-gray-700">Blood Type</label>
                         <select id="bloodType" required data-original-required="true" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 bg-white focus:ring-red-500 focus:border-red-500">
                             <option value="">Select Blood Type</option>
                             <option value="A+">A+</option><option value="A-">A-</option>
                             <option value="B+">B+</option><option value="B-">B-</option>
                             <option value="AB+">AB+)</option><option value="AB-">AB-</option>
                             <option value="O+">O+</option><option value="O-">O-</option>
                         </select>
                     </div>
                 </div>

                 <div class="space-y-1">
                     <label for="address" class="block text-sm font-medium text-gray-700">Full Address (Street/Locality)</label>
                     <textarea id="address" required data-original-required="true" placeholder="Apartment name, street, locality" rows="2" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500"></textarea>
                 </div>
                 
                 <h3 class="text-lg font-bold text-red-700 pt-4 border-t border-red-200"><span id="verification-title">Verification & Donation History</span></h3>
                 
                 <div class="space-y-1 p-3 bg-red-50 rounded-lg border border-red-200 donor-only-field">
                     <label for="bloodReportFile" class="block text-sm font-bold text-red-800">
                         Upload Latest Blood Report (PDF only) <span class="text-xs font-normal text-gray-600">(Mandatory for Admin Verification)</span>
                     </label>
                     <input type="file" id="bloodReportFile" required data-original-required="true" accept="application/pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-100 file:text-red-700 hover:file:bg-red-200">
                 </div>

                 <div class="space-y-1 donor-only-field">
                     <label for="lastDonationDate" class="block text-sm font-medium text-gray-700">Last Blood Donation Date (If never donated, leave empty)</label>
                     <input type="date" id="lastDonationDate" max="" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                 </div>
                 
                 <div class="flex items-center space-x-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                     <input type="checkbox" id="verification-check" required data-original-required="true" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                     <label for="verification-check" class="text-sm font-medium text-blue-800">
                         I verify all provided data is accurate and can be shared for emergency contact.
                     </label>
                 </div>
                 
                 <button type="submit" id="save-profile-btn" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">
                     Register & Await Verification
                 </button>
                 <button type="button" id="signup-back-to-role" class="w-full text-sm text-gray-500 hover:text-red-500 mt-2">‚Üê Back to Main Menu</button>
            </form>
        </div>
       
        <div id="user-blocked" class="hidden text-center p-10 space-y-4">
             <div class="p-6 bg-red-50 rounded-xl border border-red-300">
                 <h2 class="text-2xl font-bold text-red-700 mb-2">üö´ Account Pending Verification</h2>
                 <p class="text-gray-600">Your profile is awaiting verification by an administrator. This includes checking your uploaded blood report/hospital details.</p>
                 <p class="text-sm text-gray-500 mt-2">Please check back later, or try to login again once verified.</p>
             </div>
             <button id="blocked-logout-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100">
                 Back to Main Menu
             </button>
        </div>
       
        <div id="admin-dashboard" class="hidden">
             <div class="flex justify-between items-center mb-6 border-b pb-3">
                 <h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
                 <button id="admin-logout-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100">
                     Logout
                 </button>
             </div>
             
             <div class="flex space-x-2 mb-6 border-b border-gray-200">
                 <button id="admin-tab-users" class="py-2 px-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition duration-150">User Verification</button>
                 <button id="admin-tab-management" class="py-2 px-4 text-sm font-bold text-gray-600 hover:text-blue-600 border-b-2 border-transparent transition duration-150">All Users / Management</button>
                 <button id="admin-tab-requests" class="py-2 px-4 text-sm font-bold text-gray-600 hover:text-blue-600 border-b-2 border-transparent transition duration-150">Pending Requests</button>
             </div>

             <div id="admin-view-users">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Pending User Verifications</h3>
                 <div id="pending-users-list" class="space-y-4">
                     <p id="no-pending-users" class="text-gray-500 text-center p-6 bg-green-50 rounded-lg border border-green-200 hidden">
                         ‚úÖ All current users are verified.
                     </p>
                 </div>
             </div>
             
             <div id="admin-view-management" class="hidden">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Donor and Hospital Accounts</h3>
                 <div id="all-users-list" class="space-y-4">
                      <p id="no-users-to-manage" class="text-gray-500 text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                          No users...
                      </p>
                 </div>
             </div>
             
             <div id="admin-view-requests" class="hidden">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Requests Awaiting Approval</h3>
                 <div id="pending-requests-list" class="space-y-4">
                      <p id="no-pending-requests" class="text-gray-500 text-center p-6 bg-green-50 rounded-lg border border-green-200 hidden">
                          ‚úÖ No requests are currently pending administrative approval.
                      </p>
                 </div>
             </div>
        </div>
       
        <div id="main-dashboard" class="hidden">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                 <h2 class="text-2xl font-bold text-gray-800">
                     <span id="dashboard-role-display" class="text-red-600"></span> Dashboard
                 </h2>
                 <div class="flex items-center space-x-3">
                    <button id="edit-profile-btn" class="text-sm text-blue-600 hover:text-blue-800 transition duration-150 p-2 rounded-full hover:bg-blue-50 flex items-center">
                         <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                         Edit Profile
                    </button>
                    <button id="delete-account-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-red-50">
                         Delete Account
                    </button>
                    <button id="dashboard-logout-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100">
                         Logout
                    </button>
                 </div>
            </div>

            <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <p class="text-lg font-semibold text-gray-700">Profile Details:</p>
                <p class="text-sm text-gray-600">Pin Code: <span id="user-pin-display" class="font-bold text-red-700">N/A</span></p>
                <p class="text-sm text-gray-600">Blood Type: <span id="user-blood-display" class="font-bold text-red-700">N/A</span></p>
                
                <div id="donor-status-section" class="mt-3 donor-only-field">
                     <p class="text-sm font-semibold text-gray-800">Donation Eligibility Status:</p>
                     <p id="donor-status" class="text-base font-bold text-green-600">VERIFIED & ELIGIBLE</p>
                </div>
            </div>

            <div class="flex space-x-2 mb-6 border-b border-gray-200">
                 <button id="tab-request" class="py-2 px-4 text-sm font-bold text-red-600 border-b-2 border-red-600 transition duration-150">Submit/Track Request</button>
                 <button id="tab-donor" class="py-2 px-4 text-sm font-bold text-gray-600 hover:text-red-600 border-b-2 border-transparent transition duration-150">Requests Near Me</button>
            </div>

            <div id="view-request">
                 <div id="my-requests-section">
                     <h3 class="text-xl font-semibold mb-4 text-gray-800">My Open Requests (Tracking)</h3>
                     <div id="my-requests-list" class="space-y-4">
                         <p id="no-open-requests" class="text-gray-500 text-center p-6 bg-blue-50 rounded-lg border border-blue-200 hidden">
                             No open requests currently being tracked.
                         </p>
                     </div>
                 </div>
                 
                 <div id="new-request-section" class="mt-8 border-t pt-6">
                     <h3 class="text-xl font-semibold mb-2 text-red-700">Submit A New Request</h3>
                     <p class="text-sm text-gray-600 mb-4"><span id="request-location-text">Specify **blood type** and **current pin code** where blood is needed.</span></p>
                     
                     <form id="request-form" class="space-y-4 p-6 bg-gray-50 rounded-xl">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div id="request-pin-group">
                                 <label for="request-pinCode" class="block text-sm font-medium text-gray-700">Current Area Pin Code (Where Blood is Needed)</label>
                                 <input type="number" id="request-pinCode" required data-original-required="true" min="100000" max="999999" placeholder="e.g., 560078" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                             </div>
                             <div>
                                 <label for="bloodTypeNeeded" class="block text-sm font-medium text-gray-700">Blood Type Needed</label>
                                 <select id="bloodTypeNeeded" required data-original-required="true" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 bg-white focus:ring-red-500 focus:border-red-500">
                                     <option value="">Select Blood Type</option>
                                     <option value="A+">A+</option><option value="A-">A-</option>
                                     <option value="B+">B+</option><option value="B-">B-</option>
                                     <option value="AB+">AB+)</option><option value="AB-">AB-</option>
                                     <option value="O+">O+</option><option value="O-">O-</option>
                                     <option value="Any">Any Type (Universal)</option>
                                 </select>
                             </div>
                         </div>
                         <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">
                             Submit Request & Find Nearby Donors
                         </button>
                     </form>
                 </div>
                 
                 <div id="matching-donors-section" class="mt-8 border-t pt-6 hidden">
                     <h3 class="text-xl font-semibold mb-4 text-gray-800">Matching Donors Near Request Location</h3>
                     <div id="map-container" class="mb-4">
                        <div id="donorMap"></div>
                     </div>
                     <p class="text-sm text-gray-500 mb-4">Click "Contact Donor" to send them an alert and their details will appear here.</p>
                     <div id="donors-list" class="space-y-4">
                          <p id="no-matching-donors" class="text-gray-500 text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                              Searching... No matching eligible donors found near the requested pin code (yet).
                          </p>
                     </div>
                 </div>
            </div>
            
            <div id="view-donor" class="hidden">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Urgent Requests in Your Area</h3>
                 <div id="map-container-donor" class="mb-4">
                    <div id="donorMapRequests"></div>
                 </div>
                 <div id="requests-list" class="space-y-4">
                     <p id="not-donor-message" class="text-gray-500 text-center p-6 bg-red-100 rounded-lg border border-red-300 hidden"></p>
                     <p id="no-requests" class="text-gray-500 text-center p-6 bg-green-50 rounded-lg border border-green-200 hidden">
                         üòä No urgent, admin-approved blood requests in your area or compatible with your blood type right now.
                     </p>
                 </div>
            </div>

        </div>
    </div>
</div>

<div id="map-legend" class="fixed bottom-0 right-0 p-3 m-3 bg-white rounded-lg shadow-xl text-xs space-y-1 z-10" style="z-index: 1000; width: 150px;">
    <p class="font-bold">Map Legend</p>
    <div class="flex items-center space-x-2">
        <span class="inline-block w-3 h-3 rounded-full bg-red-600"></span>
        <span>Your Location (Donor)</span>
    </div>
    <div class="flex items-center space-x-2">
        <span class="inline-block w-3 h-3 rounded-full bg-blue-600"></span>
        <span>Request Location</span>
    </div>
</div>

<script>
    // =========================================================================
    // FRONTEND APPLICATION LOGIC (NOW CONNECTED TO MONGO DB/EXPRESS BACKEND)
    // = ALL localStorage LOGIC HAS BEEN REPLACED BY ASYNC API FETCH CALLS
    // =========================================================================

    // --- START: BACKEND CONFIGURATION & API HELPERS ---
    
    const BACKEND_BASE_URL = 'https://blood-connect-api-67g9.onrender.com'; // *** IMPORTANT: REPLACE WITH YOUR DEPLOYED URL ***
    const API_URL = `${BACKEND_BASE_URL}/api`;

    // Initialize Socket.IO connection
    const socket = io(BACKEND_BASE_URL); 

    let userProfile = null;
    // We keep a local ID for persistent login and API tracking
    let userId = localStorage.getItem('local_user_id'); 
    let allUsers = []; // Data structure to hold all users fetched by Admin
    let pendingRequests = []; // Data structure to hold all pending requests fetched by Admin


    // Helper: Pin Code Coordinates (Simulated for Map)
    const PIN_COORDINATES = {
        '560078': [12.9103, 77.5818], // JP Nagar
        '560037': [12.9698, 77.7500], // Whitefield/Hoodi
        '560041': [12.9165, 77.6101], // BTM Layout
        '560001': [12.9716, 77.5946], // Majestic/CBD
        '560010': [12.9348, 77.6253], // Koramangala
        '560093': [12.9244, 77.6750], // Marathahalli
        // Add more for better simulation
        '560002': [12.9900, 77.6000], // Shivajinagar
        '560005': [13.0000, 77.5700], // Vasanth Nagar
        '560008': [13.0100, 77.5600], // Malleswaram
        '560066': [12.9500, 77.7600], // Kadugodi
        '560048': [12.9700, 77.7700], // EPIP Area
        '560076': [12.9000, 77.5700], // Jayanagar
        '560068': [12.9400, 77.7000], // Kundalahalli
    };

    // Helper: Find Nearby Pin Codes (Simulated)
    const NEARBY_PINS = {
        '560078': ['560078', '560041', '560076', '560010'], // JP Nagar, BTM, Jayanagar, K'mangala
        '560037': ['560037', '560066', '560048', '560093'], // Hoodi, Kadugodi, EPIP, Marathahalli
        '560041': ['560041', '560076', '560078', '560010'], // BTM Layout, JP Nagar
        '560001': ['560001', '560002', '560005', '560008'], // CBD, Shivajinagar, Vasanth Nagar
        '560010': ['560010', '560041', '560078'], // Koramangala
        '560093': ['560093', '560037', '560068'], // Marathahalli
    };


    // --- API FETCH HELPERS (Replaces localStorage functions) ---

    // Helper for POST requests
    async function postData(endpoint, data) {
        const response = await fetch(`${API_URL}${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-ID': userId 
            },
            body: JSON.stringify(data)
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `API call failed for ${endpoint}: ${response.statusText}`);
        }
        return response.json();
    }

    // Helper for GET requests
    async function getData(endpoint, params = {}) {
        const url = new URL(`${API_URL}${endpoint}`);
        url.search = new URLSearchParams(params).toString();
        const response = await fetch(url, {
            headers: { 'X-User-ID': userId } 
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `API call failed for ${endpoint}: ${response.statusText}`);
        }
        return response.json();
    }

    // 1. Initial Profile Sync/Load
    async function fetchAndSyncProfile() {
        try {
            if (!userId) {
                // Generate a local ID if one doesn't exist
                userId = crypto.randomUUID();
                localStorage.setItem('local_user_id', userId);
                userProfile = null;
                return false;
            }

            // Endpoint to check for a registered user by local ID
            const data = await getData(`/auth/sync-profile/${userId}`);
            
            if (data.user) {
                 userProfile = data.user;
                 return true;
            } else {
                 userProfile = null;
                 // If the server doesn't know this userId, clear it and generate a new one next time.
                 localStorage.removeItem('local_user_id'); 
                 userId = crypto.randomUUID();
                 localStorage.setItem('local_user_id', userId);
                 return false;
            }

        } catch (error) {
            console.error("Profile sync failed:", error.message);
            userProfile = null;
            return false;
        }
    }

    // 2. Registration
    async function registerProfile(profileData) {
        return postData('/auth/register', profileData);
    }

    // 3. Login
    async function loginUser(phone) {
        const data = await postData('/auth/login', { phone });
        // On successful login, update local state
        if (data.user) {
            // Use the userId from the returned user
            userId = data.user.userId; 
            localStorage.setItem('local_user_id', userId);
            userProfile = data.user;
        }
        return data;
    }

    // 4. Update Profile (used for Edit Profile)
    async function updateProfile(profileData) {
        const data = await postData('/users/update', profileData);
        userProfile = data.user; 
        return data;
    }

    // 5. Submit Request
    async function submitRequest(requestData) {
        const data = await postData('/requests/submit', requestData);
        userProfile = data.user; 
        return data;
    }

    // 6. Close/Cancel Request (used by Hospital/Admin)
    async function cancelRequest(requestId) {
        const data = await postData('/requests/cancel', { requestId });
        userProfile = data.user; 
        return data;
    }

    // 7. Match Donor (used by Donor)
    async function matchDonorToRequest(requestId) {
         const data = await postData('/requests/match-donor', { requestId });
         userProfile = data.user; 
         return data;
    }

    // 8. Close Request after Donor Match (used by Requester/Hospital)
    async function completeRequest(requestId) {
        const data = await postData('/requests/complete', { requestId });
        userProfile = data.user; 
        return data;
    }


    // --- ADMIN API FUNCTIONS ---

    async function fetchAllAdminData() {
         try {
             const data = await getData('/sync-storage');
             allUsers = data.users || [];
             pendingRequests = data.requests || [];
             renderPendingUsers();
             renderAllUsers();
             renderPendingRequests();
         } catch (error) {
             console.error("Failed to sync admin data:", error.message);
             showNotification("Failed to fetch admin data. Check backend connection.", 'red');
         }
    }

    // Admin Action: Verify User
    async function verifyUser(id) {
        const data = await postData('/users/verify', { userId: id });
        return data.user;
    }

    // Admin Action: Deny User
    async function denyUser(id) {
        const data = await postData('/users/deny', { userId: id });
        return data.user;
    }

    // Admin Action: Delete User
    async function deleteUser(id) {
        const data = await postData('/users/delete', { userId: id });
        return data;
    }

    // Admin Action: Approve Request
    async function approveRequest(id) {
        const data = await postData('/requests/approve', { requestId: id, status: 'APPROVED' });
        return data.request;
    }

    // Admin Action: Deny Request
    async function denyRequest(id) {
        const data = await postData('/requests/approve', { requestId: id, status: 'DENIED' });
        return data.request;
    }


    // --- SOCKET.IO LISTENERS (Real-time updates) ---

    socket.on('connect', () => {
        console.log('Socket.IO connected to backend.');
    });
    
    // Listen for general admin data updates (for user/request lists)
    socket.on('dataUpdate', (data) => {
        if (userProfile && userProfile.userRole === 'Admin') {
            // A change occurred, re-fetch and re-render the admin dashboard
            fetchAllAdminData(); 
        }
    });

    socket.on('userStatusUpdate', (updatedUser) => {
         // Check if the update is for the current user
        if (userProfile && userProfile.userId === updatedUser.userId) {
             userProfile = updatedUser;
             if (updatedUser.status === 'VERIFIED') {
                 showNotification(`üéâ Your account has been VERIFIED! Redirecting to dashboard.`, 'green');
                 showDashboard();
             } else if (updatedUser.status === 'DENIED') {
                 showNotification(`üö® Account DENIED. Please check details.`, 'red');
                 showUserBlocked();
             }
        }
    });

    socket.on('newRequest', (request) => {
        if (userProfile && userProfile.userRole === 'Donor' && userProfile.status === 'VERIFIED') {
            showNotification(`üö® Urgent Request: ${request.bloodTypeNeeded} needed in pin ${request.pinCode}!`, 'red', 10000);
            updateDashboardData(); // Refresh donor's requests view
        }
    });
    
    socket.on('requestApproved', (approvedRequest) => {
         if (userProfile && userProfile.userRole === 'Donor' && userProfile.status === 'VERIFIED') {
             updateDashboardData(); // Refreshes requests for donor
         }
         if (userProfile && userProfile.userId === approvedRequest.requesterId) {
              // Update local state and dashboard
              userProfile.isRequestActive = true;
              updateDashboardData(); 
              showNotification(`‚úÖ Your request for ${approvedRequest.bloodTypeNeeded} has been APPROVED!`, 'green');
         }
    });

    socket.on('requestCompleted', (data) => {
        // Data contains { userId: donorId, requesterId: hospitalId, bloodTypeNeeded: ... }
         if (userProfile && userProfile.userId === data.requesterId) {
            // Hospital who submitted the request
             userProfile.isRequestActive = false;
             userProfile.donorMatch = null;
             updateDashboardData();
             showNotification(`ü©∏ Request for ${data.bloodTypeNeeded} is marked COMPLETE!`, 'blue');
         }
         if (userProfile && userProfile.userId === data.donorId) {
             // Donor who accepted
             userProfile.donorMatch = null;
             // The server handles updating lastDonationTime, but we update locally for immediate display
             userProfile.lastDonationTime = Date.now(); 
             updateDashboardData();
             showNotification(`THANK YOU! You completed a donation. Cooldown started.`, 'green');
         }
    });

    // --- END: BACKEND CONFIGURATION & API HELPERS ---
    
    // Global map instance
    let donorMap = null; 
    let donorMapRequests = null;

    // --- UI HELPERS ---
    const ui = {
        loading: document.getElementById('loading-state'),
        roleSelection: document.getElementById('role-selection'),
        authSelection: document.getElementById('auth-selection'),
        authRoleDisplay: document.getElementById('auth-role-display'),
        authLoginBtn: document.getElementById('auth-login-btn'),
        authRegisterBtn: document.getElementById('auth-register-btn'),
        userLogin: document.getElementById('user-login'),
        adminLogin: document.getElementById('admin-login'),
        adminDashboard: document.getElementById('admin-dashboard'),
        userBlocked: document.getElementById('user-blocked'),
        profileSetup: document.getElementById('profile-setup'),
        mainDashboard: document.getElementById('main-dashboard'),
        profileForm: document.getElementById('profile-form'),
        requestForm: document.getElementById('request-form'),
        donorStatus: document.getElementById('donor-status'), 
        // Admin Views
        adminViewUsers: document.getElementById('admin-view-users'),
        adminViewManagement: document.getElementById('admin-view-management'),
        adminViewRequests: document.getElementById('admin-view-requests'),
        adminTabUsers: document.getElementById('admin-tab-users'),
        adminTabManagement: document.getElementById('admin-tab-management'),
        adminTabRequests: document.getElementById('admin-tab-requests'),
        pendingUsersList: document.getElementById('pending-users-list'),
        allUsersList: document.getElementById('all-users-list'),
        pendingRequestsList: document.getElementById('pending-requests-list'),
        noPendingUsers: document.getElementById('no-pending-users'),
        noUsersToManage: document.getElementById('no-users-to-manage'),
        noPendingRequests: document.getElementById('no-pending-requests'),
        // Dashboard Views
        tabRequest: document.getElementById('tab-request'),
        tabDonor: document.getElementById('tab-donor'),
        viewRequest: document.getElementById('view-request'),
        viewDonor: document.getElementById('view-donor'),
        requestsList: document.getElementById('requests-list'),
        noRequests: document.getElementById('no-requests'),
        notDonorMessage: document.getElementById('not-donor-message'),
        myRequestsList: document.getElementById('my-requests-list'),
        noOpenRequests: document.getElementById('no-open-requests'),
        matchingDonorsSection: document.getElementById('matching-donors-section'),
        donorsList: document.getElementById('donors-list'),
        noMatchingDonors: document.getElementById('no-matching-donors'),
        // Profile Setup Fields
        nameInput: document.getElementById('name'),
        phoneInput: document.getElementById('phone'),
        ageInput: document.getElementById('age'),
        genderInput: document.getElementById('gender'),
        weightInput: document.getElementById('weight'),
        pinCodeInput: document.getElementById('pinCode'),
        bloodTypeInput: document.getElementById('bloodType'),
        addressInput: document.getElementById('address'),
        lastDonationDateInput: document.getElementById('lastDonationDate'),
        bloodReportFile: document.getElementById('bloodReportFile'),
        backToDashboardFromEditBtn: document.getElementById('back-to-dashboard-from-edit'),
        deleteAccountBtn: document.getElementById('delete-account-btn'),
        // Login Fields
        userLoginForm: document.getElementById('user-login-form'),
        adminLoginForm: document.getElementById('admin-login-form'),
        adminPinInput: document.getElementById('admin-pin'),
        // Dashboard displays
        dashboardRoleDisplay: document.getElementById('dashboard-role-display'),
        userPinDisplay: document.getElementById('user-pin-display'),
        userBloodDisplay: document.getElementById('user-blood-display'),
    };

    function showNotification(message, type = 'green', duration = 3000) {
        const box = document.getElementById('global-message-box');
        const content = document.getElementById('global-message-content');
        
        let bgColor, textColor;
        if (type === 'green') {
            bgColor = 'bg-green-100 border border-green-400';
            textColor = 'text-green-800';
        } else if (type === 'red') {
            bgColor = 'bg-red-100 border border-red-400';
            textColor = 'text-red-800';
        } else if (type === 'yellow') {
            bgColor = 'bg-yellow-100 border border-yellow-400';
            textColor = 'text-yellow-800';
        } else if (type === 'blue') {
            bgColor = 'bg-blue-100 border border-blue-400';
            textColor = 'text-blue-800';
        } else {
            bgColor = 'bg-gray-100 border border-gray-400';
            textColor = 'text-gray-800';
        }

        content.className = `p-3 rounded-lg shadow-xl text-center font-medium max-w-lg mx-auto ${bgColor} ${textColor}`;
        content.textContent = message;
        
        box.classList.remove('-translate-y-full', 'opacity-0');
        box.classList.add('translate-y-0', 'opacity-100');

        setTimeout(() => {
            box.classList.remove('translate-y-0', 'opacity-100');
            box.classList.add('-translate-y-full', 'opacity-0');
        }, duration);
    }
    
    function hideAllViews() {
        [ui.roleSelection, ui.authSelection, ui.userLogin, ui.adminLogin, ui.profileSetup, ui.mainDashboard, ui.adminDashboard, ui.userBlocked].forEach(view => {
            view.classList.add('hidden');
        });
    }

    function logoutUser() {
        userProfile = null;
        // Keep local_user_id to prevent re-generating if the user just closed the tab,
        // but let the API determine if it's a valid ID on next load.
        showRoleSelection();
    }

    // Role Selection
    let currentSelectedRole = '';
    function showRoleSelection() {
        hideAllViews();
        ui.roleSelection.classList.remove('hidden');
    }

    function showAuthSelection(role) {
        currentSelectedRole = role;
        hideAllViews();
        ui.authRoleDisplay.textContent = role;
        ui.authSelection.classList.remove('hidden');
    }

    function showUserLogin(role) {
        hideAllViews();
        document.getElementById('login-role-display').textContent = role;
        ui.userLogin.classList.remove('hidden');
    }

    function showAdminLogin() {
        hideAllViews();
        ui.adminLogin.classList.remove('hidden');
    }

    function showUserBlocked() {
        hideAllViews();
        const role = userProfile.userRole;
        const status = userProfile.status;
        
        ui.userBlocked.classList.remove('hidden');
        const contentBox = ui.userBlocked.querySelector('div');
        const title = ui.userBlocked.querySelector('h2');
        const message = ui.userBlocked.querySelector('p:nth-child(3)');

        if (status === 'DENIED') {
             title.textContent = '‚ùå Account Verification Denied';
             contentBox.className = 'p-6 bg-red-50 rounded-xl border border-red-300';
             message.textContent = `Your ${role} profile was permanently denied by the administrator. Please contact the administrator or re-register with accurate data.`;
        } else {
             title.textContent = 'üö´ Account Pending Verification';
             contentBox.className = 'p-6 bg-yellow-50 rounded-xl border border-yellow-300';
             message.textContent = `Your ${role} profile is awaiting verification by an administrator. This includes checking your uploaded blood report/hospital details.`;
        }
    }


    function initializeProfileSetupForm(isEdit = false) {
        const role = document.getElementById('userRoleHidden').value;
        const isDonor = role === 'Donor';
        
        document.getElementById('registration-role').textContent = isEdit ? 'Edit Profile' : `New ${role}`;
        
        // Toggle donor-specific fields visibility
        document.querySelectorAll('.donor-only-field').forEach(el => {
            el.classList.toggle('hidden', !isDonor);
        });
        
        // Handle required attributes
        document.querySelectorAll('#profile-form input[required], #profile-form select[required], #profile-form textarea[required]').forEach(input => {
            if (input.closest('.donor-only-field') && !isDonor) {
                input.removeAttribute('required');
            } else if (input.dataset.originalRequired === 'true') {
                input.setAttribute('required', 'required');
            }
        });

        // Toggle back button visibility
        ui.backToDashboardFromEditBtn.classList.toggle('hidden', !isEdit);
        document.getElementById('signup-back-to-role').classList.toggle('hidden', isEdit);
        
        // Update button text
        ui.saveProfileBtn.textContent = isEdit ? 'Save Profile Changes' : 'Register & Await Verification';
        
        if (isEdit && userProfile) {
            ui.nameInput.value = userProfile.name || '';
            ui.phoneInput.value = userProfile.phone || '';
            ui.ageInput.value = userProfile.age || '';
            ui.genderInput.value = userProfile.gender || '';
            ui.weightInput.value = userProfile.weight || '';
            ui.pinCodeInput.value = userProfile.pinCode || '';
            ui.bloodTypeInput.value = userProfile.bloodType || '';
            ui.addressInput.value = userProfile.address || '';
            ui.lastDonationDateInput.value = userProfile.lastDonationDate || '';
            ui.bloodReportFile.value = ''; // Clear file input on edit to prevent accidental re-submission
        } else {
            ui.profileForm.reset();
        }
    }
    
    // Main Dashboard View
    function showDashboard() {
        if (!userProfile || userProfile.userRole === 'Admin' || userProfile.status !== 'VERIFIED') {
             // If the user logs in but isn't VERIFIED, send them to the blocked view
            if (userProfile && userProfile.userRole !== 'Admin') {
                showUserBlocked();
                return;
            }
            logoutUser();
            return;
        } 
        
        hideAllViews();
        ui.mainDashboard.classList.remove('hidden');
        
        const isDonor = userProfile.userRole === 'Donor';
        const isHospital = userProfile.userRole === 'Hospital';
        
        ui.dashboardRoleDisplay.textContent = userProfile.userRole;
        ui.userPinDisplay.textContent = userProfile.pinCode || 'N/A';
        ui.userBloodDisplay.textContent = userProfile.bloodType || 'N/A';

        // Toggle donor-specific sections
        document.getElementById('donor-status-section').classList.toggle('hidden', !isDonor);
        
        // Hide/show relevant tabs and views based on role
        ui.tabRequest.classList.toggle('hidden', isDonor);
        ui.tabDonor.classList.toggle('hidden', isHospital);
        
        // Set active tab (Request for Hospital, Donor for Donor)
        if (isHospital) {
            setActiveDashboardTab(ui.tabRequest, ui.viewRequest);
            document.getElementById('request-pin-group').classList.add('hidden'); // Hospital uses its own pin
            document.getElementById('request-location-text').textContent = `Submit the request for your hospital pin: ${userProfile.pinCode}.`;
            ui.matchingDonorsSection.classList.remove('hidden');
        } else {
            setActiveDashboardTab(ui.tabDonor, ui.viewDonor);
            ui.matchingDonorsSection.classList.add('hidden');
        }

        updateDashboardData();
    }

    // Function to fetch data and update dashboard content
    async function updateDashboardData() {
        if (!userProfile) return;
        
        // 1. Get the latest profile from the server for real-time status/eligibility
        try {
            const syncData = await getData(`/auth/sync-profile/${userProfile.userId}`);
            userProfile = syncData.user;
            
            // Re-check verification status
            if (userProfile.status !== 'VERIFIED' && userProfile.userRole !== 'Admin') {
                 showUserBlocked();
                 return;
            }
            
        } catch (error) {
            console.error("Error syncing profile for dashboard update:", error);
            return;
        }

        // 2. Update Role-Specific Dashboard Views
        if (userProfile.userRole === 'Donor') {
             // Fetch Eligibility Status
             const eligibility = await getData(`/users/eligibility/${userProfile.userId}`); 
             ui.donorStatus.textContent = eligibility.status;
             ui.donorStatus.className = `text-base font-bold ${eligibility.color}`;
             
             // Donor sees requests near them
             await renderRequestsForDonor();
        } else if (userProfile.userRole === 'Hospital') {
            // Hospital sees their request status/match
            await renderMyRequests();

            // Hospital sees matching donors if a request is active
            if (userProfile.isRequestActive) {
                try {
                    const data = await getData('/donors/match', { pinCode: userProfile.requestPinCode, bloodType: userProfile.bloodTypeNeeded });
                    renderDonors(data.donors || []);
                } catch (err) {
                    console.error("Error fetching matching donors:", err);
                    renderDonors([]);
                }
            } else {
                renderDonors([]); // Clear donors if no active request
            }
        }
    }

    // Helper: Map initialization
    function initMap(center, mapElementId = 'donorMapRequests') {
        if (mapElementId === 'donorMapRequests' && donorMapRequests) {
             donorMapRequests.setView(center, 12);
             return donorMapRequests;
        }
        if (mapElementId === 'donorMap' && donorMap) {
             donorMap.setView(center, 12);
             return donorMap;
        }
        
        const newMap = L.map(mapElementId).setView(center, 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(newMap);
        
        if (mapElementId === 'donorMapRequests') {
            donorMapRequests = newMap;
        } else {
            donorMap = newMap;
        }
        return newMap;
    }

    function setActiveDashboardTab(activeButton, activeView) {
        [ui.tabRequest, ui.tabDonor].forEach(btn => {
            btn.classList.remove('border-red-600', 'text-red-600');
            btn.classList.add('text-gray-600', 'border-transparent');
        });
        activeButton.classList.add('border-red-600', 'text-red-600');
        activeButton.classList.remove('text-gray-600', 'border-transparent');

        [ui.viewRequest, ui.viewDonor].forEach(view => view.classList.add('hidden'));
        activeView.classList.remove('hidden');

        // Refresh data on tab switch
        updateDashboardData();
    }
    
    function setActiveAdminTab(activeButton, activeView) {
        [ui.adminTabUsers, ui.adminTabManagement, ui.adminTabRequests].forEach(btn => {
            btn.classList.remove('border-blue-600', 'text-blue-600');
            btn.classList.add('text-gray-600', 'border-transparent');
        });
        activeButton.classList.add('border-blue-600', 'text-blue-600');
        activeButton.classList.remove('text-gray-600', 'border-transparent');

        [ui.adminViewUsers, ui.adminViewManagement, ui.adminViewRequests].forEach(view => view.classList.add('hidden'));
        activeView.classList.remove('hidden');
        
        // Ensure data is refreshed
        fetchAllAdminData();
    }

    // --- RENDER FUNCTIONS (Uses global `allUsers` and `pendingRequests` from API sync) ---

    // Admin: Render Users Awaiting Verification
    function renderPendingUsers() {
        ui.pendingUsersList.innerHTML = '';
        const pendingUsers = allUsers.filter(user => user.status === 'PENDING_VERIFICATION' || user.status === 'PENDING');

        ui.noPendingUsers.classList.toggle('hidden', pendingUsers.length > 0);

        pendingUsers.forEach(user => {
            const isDonor = user.userRole === 'Donor';
            const verificationInfo = isDonor ? 
                `Type: ${user.bloodType}, Age: ${user.age}, Weight: ${user.weight}kg` : 
                `Pin: ${user.pinCode}, Address: ${user.address.substring(0, 30)}...`;
            const reportStatus = isDonor ? 
                (user.bloodReportLink ? 'Report Uploaded' : 'Report MISSING') : 
                'N/A';
            const reportAction = isDonor && user.bloodReportLink ? 
                `<a href="#" class="view-report-link text-blue-600 hover:text-blue-800 underline text-sm font-semibold" data-report-link="${user.bloodReportLink}">View Report (Simulated)</a>` : 
                (isDonor ? `<span class="text-gray-500 text-sm">Cannot Verify without Report</span>` : `<span class="text-gray-500 text-sm">Review Address/Pin</span>`);

            const userCard = document.createElement('div');
            userCard.className = 'bg-white p-4 rounded-xl border border-blue-200 shadow-sm flex justify-between items-center flex-wrap gap-4';
            userCard.innerHTML = `
                <div class="space-y-1">
                    <p class="text-lg font-bold text-gray-800">${user.name} (<span class="text-red-600">${user.userRole}</span>)</p>
                    <p class="text-sm text-gray-600">Pin: ${user.pinCode} | Phone: ${user.phone}</p>
                    <p class="text-xs text-gray-500">${verificationInfo}</p>
                    <p class="text-sm mt-2">${reportStatus} | ${reportAction}</p>
                </div>
                <div class="flex flex-col space-y-2">
                    <button class="verify-user-btn bg-green-600 text-white hover:bg-green-700 text-sm font-bold py-2 px-4 rounded-full shadow-md transition duration-150" data-user-id="${user.userId}">
                        Verify User
                    </button>
                    <button class="deny-user-btn bg-red-100 text-red-700 hover:bg-red-200 text-sm font-bold py-1 px-4 rounded-full transition duration-150" data-user-id="${user.userId}">
                        Deny
                    </button>
                </div>
            `;
            ui.pendingUsersList.appendChild(userCard);
        });

        // Add event listeners for verify/deny buttons (using API)
        document.querySelectorAll('.verify-user-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = e.target.dataset.userId;
                e.target.textContent = 'Verifying...';
                e.target.disabled = true;
                try {
                    await verifyUser(id); 
                    showNotification(`User ${id} verified. Status updated on dashboard.`, 'green');
                    fetchAllAdminData(); 
                } catch (err) {
                     showNotification(`Verification failed: ${err.message}`, 'red');
                }
            });
        });
        document.querySelectorAll('.deny-user-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = e.target.dataset.userId;
                if (window.confirm(`Are you sure you want to PERMANENTLY DENY this account?`)) {
                     e.target.textContent = 'Denying...';
                     e.target.disabled = true;
                     try {
                         await denyUser(id); 
                         showNotification(`User ${id} denied. Status updated on dashboard.`, 'red');
                         fetchAllAdminData(); 
                     } catch (err) {
                          showNotification(`Denial failed: ${err.message}`, 'red');
                     }
                }
            });
        });
    }

    // Admin: Render All Users for Management
    function renderAllUsers() {
        ui.allUsersList.innerHTML = '';
        const managedUsers = allUsers.filter(user => user.userRole !== 'Admin');

        ui.noUsersToManage.classList.toggle('hidden', managedUsers.length > 0);

        managedUsers.forEach(user => {
            let statusColor = 'text-gray-500';
            let statusBadge = user.status;
            if (user.status === 'VERIFIED') {
                statusColor = 'text-green-600';
            } else if (user.status === 'DENIED') {
                statusColor = 'text-red-600';
            } else {
                statusColor = 'text-yellow-600';
                statusBadge = 'PENDING';
            }
            
            const detailInfo = user.userRole === 'Donor' ? 
                `Blood: ${user.bloodType || 'N/A'}, Last Donated: ${user.lastDonationDate || 'Never'}` : 
                `Pin: ${user.pinCode}, Address: ${user.address.substring(0, 30)}...`;

            const userCard = document.createElement('div');
            userCard.className = 'bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex justify-between items-start flex-wrap gap-4';
            userCard.innerHTML = `
                <div class="space-y-1">
                    <p class="text-lg font-bold text-gray-800">${user.name} (<span class="text-red-600">${user.userRole}</span>)</p>
                    <p class="text-sm ${statusColor} font-bold">Status: ${statusBadge}</p>
                    <p class="text-xs text-gray-500">${detailInfo}</p>
                    <p class="text-xs text-gray-500">Phone: ${user.phone}</p>
                </div>
                <div class="flex flex-col space-y-2">
                    <button class="delete-user-btn bg-red-50 text-red-700 hover:bg-red-200 text-sm font-bold py-2 px-4 rounded-full shadow-sm transition duration-150" data-user-id="${user.userId}">
                        Delete User
                    </button>
                </div>
            `;
            ui.allUsersList.appendChild(userCard);
        });

        // Add event listeners for delete buttons (using API)
        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = e.target.dataset.userId;
                const userToDelete = allUsers.find(u => u.userId === id);
                if (window.confirm(`Are you sure you want to PERMANENTLY DELETE ${userToDelete.name} (${userToDelete.userRole})? This action cannot be undone.`)) {
                    e.target.textContent = 'Deleting...';
                    e.target.disabled = true;
                    try {
                         await deleteUser(id); 
                         showNotification(`User deleted.`, 'red');
                         fetchAllAdminData(); 
                         if (id === userProfile.userId) logoutUser(); // If admin deletes self
                    } catch (err) {
                         showNotification(`Deletion failed: ${err.message}`, 'red');
                    }
                }
            });
        });
    }
    
    // Admin: Render Requests Awaiting Approval
    function renderPendingRequests() {
        ui.pendingRequestsList.innerHTML = '';
        const pendingReqs = pendingRequests.filter(req => req.status === 'PENDING');

        ui.noPendingRequests.classList.toggle('hidden', pendingReqs.length > 0);

        pendingReqs.forEach(req => {
            const reqCard = document.createElement('div');
            reqCard.className = 'bg-white p-4 rounded-xl border border-yellow-300 shadow-sm flex justify-between items-center flex-wrap gap-4';
            reqCard.innerHTML = `
                <div class="space-y-1">
                    <p class="text-lg font-bold text-gray-800">Need: <span class="text-red-700">${req.bloodTypeNeeded}</span></p>
                    <p class="text-sm text-gray-600">Pin: ${req.pinCode} | Requester: ${req.name} (${req.userRole})</p>
                    <p class="text-xs text-gray-500">Phone: ${req.phone} | Status: PENDING</p>
                </div>
                <div class="flex flex-col space-y-2">
                    <button class="approve-request-btn bg-green-600 text-white hover:bg-green-700 text-sm font-bold py-2 px-4 rounded-full shadow-md transition duration-150" data-request-id="${req._id}">
                        Approve & Broadcast
                    </button>
                    <button class="deny-request-btn bg-red-100 text-red-700 hover:bg-red-200 text-sm font-bold py-1 px-4 rounded-full transition duration-150" data-request-id="${req._id}">
                        Deny
                    </button>
                </div>
            `;
            ui.pendingRequestsList.appendChild(reqCard);
        });

        // Add event listeners for approve/deny buttons (using API)
        document.querySelectorAll('.approve-request-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = e.target.dataset.requestId;
                e.target.textContent = 'Approving...';
                e.target.disabled = true;
                try {
                    await approveRequest(id); 
                    showNotification(`Request approved and broadcasted.`, 'green');
                    fetchAllAdminData(); 
                } catch (err) {
                    showNotification(`Approval failed: ${err.message}`, 'red');
                }
            });
        });

        document.querySelectorAll('.deny-request-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = e.target.dataset.requestId;
                e.target.textContent = 'Denying...';
                e.target.disabled = true;
                try {
                    await denyRequest(id); 
                    showNotification(`Request denied.`, 'red');
                    fetchAllAdminData(); 
                } catch (err) {
                    showNotification(`Denial failed: ${err.message}`, 'red');
                }
            });
        });
    }

    // Hospital: Render Matching Donors
    function renderDonors(donors) {
        ui.donorsList.innerHTML = '';
        ui.noMatchingDonors.classList.toggle('hidden', donors.length > 0);

        donors.forEach(donor => {
            const donorCard = document.createElement('div');
            donorCard.className = 'bg-white p-4 rounded-xl border border-green-200 shadow-sm flex justify-between items-center flex-wrap gap-4';
            
            const matchPinText = donor.pinCode === userProfile.requestPinCode 
                ? `<span class="text-green-600 font-bold">Exact Match Pin</span>` 
                : `<span class="text-yellow-600 font-bold">Nearby Pin</span>`;

            donorCard.innerHTML = `
                <div class="space-y-1">
                    <p class="text-lg font-bold text-gray-800">${donor.name}</p>
                    <p class="text-sm text-gray-600">Blood Type: <span class="text-red-700 font-bold">${donor.bloodType}</span> | ${matchPinText}</p>
                    <p class="text-xs text-gray-500">Age: ${donor.age}, Weight: ${donor.weight}kg</p>
                </div>
                <div class="flex flex-col space-y-2">
                    <button class="contact-donor-btn bg-blue-600 text-white hover:bg-blue-700 text-sm font-bold py-2 px-4 rounded-full shadow-md transition duration-150" 
                        data-donor-id="${donor.userId}" data-request-id="${userProfile.requestId}">
                        Contact Donor
                    </button>
                </div>
            `;
            ui.donorsList.appendChild(donorCard);
        });

        // Add event listeners for 'Contact Donor' (Match Donor to Request via API)
        document.querySelectorAll('.contact-donor-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const donorId = e.target.dataset.donorId;
                const requestId = e.target.dataset.requestId; // Assuming the Hospital's active request ID is available (it should be on userProfile)
                if (window.confirm(`Are you sure you want to send a match alert to this donor? This will close the request for other donors and alert them to contact you.`)) {
                    e.target.textContent = 'Matching...';
                    e.target.disabled = true;
                    try {
                        await postData('/requests/match', { donorId, requestId }); 
                        showNotification(`Match alert sent to donor! They will be directed to contact you.`, 'green');
                        // Refresh dashboard to show the match notification
                        updateDashboardData();
                    } catch (err) {
                        showNotification(`Matching failed: ${err.message}`, 'red');
                        e.target.textContent = 'Contact Donor';
                        e.target.disabled = false;
                    }
                }
            });
        });
    }

    // Donor: Render Requests Near Me
    async function renderRequestsForDonor() {
        ui.requestsList.innerHTML = '';
        ui.notDonorMessage.classList.add('hidden');
        ui.noRequests.classList.add('hidden');

        // 1. Fetch Donor Eligibility Status from Server
        const eligibility = await getData(`/users/eligibility/${userProfile.userId}`); 

        // Update UI status for immediate feedback
        ui.donorStatus.textContent = eligibility.status;
        ui.donorStatus.className = `text-base font-bold ${eligibility.color}`;
        
        if (!eligibility.eligible) {
             ui.notDonorMessage.textContent = `üö´ ${eligibility.status}. You cannot receive urgent alerts while ineligible.`;
             ui.notDonorMessage.classList.remove('hidden');
             return;
        }

        // 2. Fetch Requests near the donor's pin code (Server handles compatibility/distance)
        const data = await getData('/requests/open', { pinCode: userProfile.pinCode, bloodType: userProfile.bloodType });
        const requests = data.requests || [];
        
        if (requests.length === 0) {
            ui.noRequests.classList.remove('hidden');
            return;
        }

        // Setup map: Center on donor's home pin
        const donorCoords = PIN_COORDINATES[userProfile.pinCode];
        if (!donorMapRequests) donorMapRequests = initMap(donorCoords, 'donorMapRequests');
        donorMapRequests.setView(donorCoords, 12);
        
        // Clear all markers from map
        donorMapRequests.eachLayer(layer => {
             if (layer instanceof L.Marker) {
                 donorMapRequests.removeLayer(layer);
             }
        });

        // Add Donor's Marker (Red Icon)
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });
        L.marker(donorCoords, { icon: redIcon })
            .bindPopup(`<b>Your Home Area (Donor):</b><br>Pin ${userProfile.pinCode}<br>Type: ${userProfile.bloodType}`)
            .addTo(donorMapRequests);
            
        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const requestMarkers = [];
        requests.forEach(req => {
            const isExactMatch = req.pinCode === userProfile.pinCode;
            const matchPinText = isExactMatch 
                ? `<span class="text-green-600 font-bold">Exact Match Pin</span>` 
                : `<span class="text-yellow-600 font-bold">Nearby Pin</span>`;

            const reqCard = document.createElement('div');
            reqCard.className = `bg-white p-4 rounded-xl border ${isExactMatch ? 'border-red-400' : 'border-yellow-300'} shadow-sm flex justify-between items-center flex-wrap gap-4`;
            reqCard.innerHTML = `
                <div class="space-y-1">
                    <p class="text-lg font-bold text-gray-800">URGENT: <span class="text-red-700">${req.bloodTypeNeeded}</span> needed</p>
                    <p class="text-sm text-gray-600">${matchPinText} - Pin: ${req.pinCode}</p>
                    <p class="text-xs text-gray-500">Requester: ${req.name}</p>
                </div>
                <div>
                    <button class="accept-request-btn bg-green-600 text-white hover:bg-green-700 text-sm font-bold py-2 px-4 rounded-full shadow-md transition duration-150" data-request-id="${req._id}">
                        Accept Request
                    </button>
                </div>
            `;
            ui.requestsList.appendChild(reqCard);
            
            // Add marker to map
            const requestCoords = PIN_COORDINATES[req.pinCode];
            if (requestCoords) {
                const requestMarker = L.marker(requestCoords, { icon: blueIcon })
                    .bindPopup(`<b>URGENT BLOOD NEEDED: ${req.bloodTypeNeeded}</b><br>Request Location: Pin ${req.pinCode}`)
                    .addTo(donorMapRequests);
                requestMarkers.push(requestMarker);
            }
        });

        // Add event listeners for 'Accept Request' (Match Donor to Request via API)
        document.querySelectorAll('.accept-request-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const requestId = e.target.dataset.requestId;
                if (window.confirm("Confirm you are eligible and ready to donate. Accepting sends your contact info to the requester.")) {
                    e.target.textContent = 'Accepting...';
                    e.target.disabled = true;
                    try {
                        await matchDonorToRequest(requestId); 
                        showNotification("ü§ù You have accepted the request! Requester notified. Check your dashboard.", 'green');
                        updateDashboardData(); 
                    } catch (err) {
                        showNotification(`Failed to accept request: ${err.message}`, 'red');
                        e.target.textContent = 'Accept Request';
                        e.target.disabled = false;
                    }
                }
            });
        });
        
        // Fit map bounds to include the donor and all requests
        if (requestMarkers.length > 0 && donorCoords) {
            const donorMarker = L.marker(donorCoords);
            const group = new L.featureGroup([donorMarker, ...requestMarkers]);
            donorMapRequests.fitBounds(group.getBounds().pad(0.5));
        }
    }
    
    // Hospital: Render My Open Request Status
    async function renderMyRequests() {
        ui.myRequestsList.innerHTML = '';
        ui.noOpenRequests.classList.add('hidden');
        
        // Always sync the profile just before rendering to get the latest match status
        try {
            const data = await getData(`/auth/sync-profile/${userProfile.userId}`);
            userProfile = data.user;
        } catch (error) {
             console.error("Failed to sync profile for myRequests:", error);
             showNotification("Error syncing profile status for request tracking.", 'red');
             return;
        }

        // 1. Check for a Donor Match Notification (Highest Priority)
        if (userProfile && userProfile.donorMatch) {
            const match = userProfile.donorMatch;
            const timeString = new Date(match.matchTime).toLocaleTimeString();
            
            const matchCard = document.createElement('div');
            matchCard.className = 'bg-green-100 p-6 rounded-xl border border-green-400 shadow-md space-y-3';
            matchCard.innerHTML = `
                <h4 class="text-xl font-bold text-green-800">üéâ Donor Match Found!</h4>
                <p class="text-sm text-gray-700">A donor has accepted your urgent request. Please contact them immediately:</p>
                <div class="bg-white p-4 rounded-lg border border-green-300">
                    <p class="text-lg font-bold text-gray-900">${match.donorName} (${match.donorBloodType})</p>
                    <p class="text-md text-red-700 font-semibold">Phone: ${match.donorPhone}</p>
                    <p class="text-xs text-gray-500 mt-1">Matched at ${timeString}. This request is now closed to other donors.</p>
                </div>
                <button class="match-complete-btn w-full bg-blue-600 text-white hover:bg-blue-700 text-base font-bold py-3 px-4 rounded-xl shadow-md transition duration-150" data-request-id="${match.requestId}">
                    Mark Request Complete & Close
                </button>
            `;
            ui.myRequestsList.appendChild(matchCard);
            
            // Add event listeners for 'Close Request' after match
            document.querySelector('.match-complete-btn').addEventListener('click', async (e) => {
                 if (window.confirm("Are you sure the donation is complete and you want to close the request?")) {
                     e.target.textContent = 'Completing...';
                     e.target.disabled = true;
                     try {
                         await completeRequest(match.requestId); 
                         showNotification(`Request closed. Thank you!`, 'blue');
                         updateDashboardData(); 
                     } catch (err) {
                          showNotification(`Failed to close request: ${err.message}`, 'red');
                          e.target.textContent = 'Mark Request Complete & Close';
                          e.target.disabled = false;
                     }
                 }
            });
            
            return;
        }
        
        // 2. Check for an open request that hasn't been matched
        if (userProfile && userProfile.isRequestActive) {
            // Fetch the details of the open request
            const requestDetails = await getData(`/requests/details/${userProfile.userId}`); 
            const request = requestDetails.request;
            
            const reqCard = document.createElement('div');
            reqCard.className = 'bg-yellow-50 p-6 rounded-xl border border-yellow-400 shadow-md space-y-3';
            reqCard.innerHTML = `
                <h4 class="text-xl font-bold text-yellow-800">üü° Open Request Status</h4>
                <p class="text-sm text-gray-700">Type: <span class="font-bold text-red-700">${request.bloodTypeNeeded}</span> needed in Pin: ${request.pinCode}</p>
                <p class="text-md font-semibold text-gray-700">Admin Status: <span class="text-green-600">${request.status} (Broadcasted)</span></p>
                <p class="text-xs text-gray-500">Matching donors are listed below. Click 'Contact Donor' to send an alert.</p>
                <button id="cancel-request-btn" class="w-full bg-red-100 text-red-700 hover:bg-red-200 text-sm font-bold py-3 px-4 rounded-xl shadow-sm transition duration-150">
                    Cancel Request
                </button>
            `;
            ui.myRequestsList.appendChild(reqCard);
            
            // Add event listener for 'Cancel Request'
            document.getElementById('cancel-request-btn').addEventListener('click', async (e) => {
                if (window.confirm("Are you sure you want to cancel this open request?")) {
                     e.target.textContent = 'Cancelling...';
                     e.target.disabled = true;
                     try {
                        await cancelRequest(request._id); 
                        showNotification(`Request successfully cancelled.`, 'blue');
                        updateDashboardData(); 
                     } catch (err) {
                          showNotification(`Failed to cancel request: ${err.message}`, 'red');
                          e.target.textContent = 'Cancel Request';
                          e.target.disabled = false;
                     }
                }
            });
        } else {
            // No open requests logic
            ui.noOpenRequests.classList.remove('hidden');
        }
    }


    // --- EVENT LISTENERS ---

    document.querySelectorAll('.select-role-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const role = e.currentTarget.dataset.role;
            document.getElementById('userRoleHidden').value = role;
            showAuthSelection(role);
        });
    });

    document.getElementById('select-admin-role-btn').addEventListener('click', showAdminLogin);
    
    document.getElementById('auth-login-btn').addEventListener('click', () => showUserLogin(currentSelectedRole));
    document.getElementById('auth-register-btn').addEventListener('click', () => {
        initializeProfileSetupForm(false);
        hideAllViews();
        ui.profileSetup.classList.remove('hidden');
    });
    
    document.getElementById('auth-back-to-role').addEventListener('click', showRoleSelection);

    document.getElementById('admin-back-to-role').addEventListener('click', showRoleSelection);
    
    document.getElementById('signup-back-to-role').addEventListener('click', showRoleSelection);

    document.getElementById('back-to-dashboard-from-edit').addEventListener('click', showDashboard);

    // Admin Login (Modified to use fixed secret key for simulation)
    ui.adminLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const pin = ui.adminPinInput.value.trim();
        // NOTE: Admin Key should match the one in your .env (ADMIN_SECRET="hellowrld")
        if (pin !== 'hellowrld') { 
             showNotification("Invalid Admin Key.", 'red');
             return;
        }
        
        // Simulate admin login profile
        userProfile = {
            userId: 'admin_user',
            name: 'Administrator',
            userRole: 'Admin',
            status: 'VERIFIED',
            // Minimal data required for Admin
        };
        
        showNotification("Admin login successful.", 'green');
        showAdminDashboard();
    });


    // User Login (Modified to use loginUser API)
    ui.userLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const phone = document.getElementById('login-phone').value.trim();
        
        try {
            const loginBtn = e.target.querySelector('button[type="submit"]');
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;

            const data = await loginUser(phone);
            const matchedUser = data.user;
            
            if (matchedUser.userRole === 'Admin') {
                // If a standard user tries to login with an admin's phone (not typical, but safe guard)
                showNotification("This account is an Administrator account. Use the Admin Login portal.", 'red');
                logoutUser();
                return;
            }

            // The loginUser call sets userProfile. Check status locally and redirect.
            if (matchedUser.status !== 'VERIFIED') {
                 showUserBlocked();
                 return;
            }
            
            // Successful Login for a verified user
            showNotification(`${matchedUser.userRole} login successful! Welcome, ${matchedUser.name}.`, 'green');
            showDashboard();

        } catch (error) {
            console.error("Login Error:", error);
            showNotification(error.message || "Login failed. Check phone number and if you are registered.", 'red');
        } finally {
            const loginBtn = e.target.querySelector('button[type="submit"]');
            loginBtn.textContent = 'Login to Dashboard';
            loginBtn.disabled = false;
        }
    });

    document.getElementById('login-back-to-auth').addEventListener('click', () => showAuthSelection(currentSelectedRole)); 
    document.getElementById('blocked-logout-btn').addEventListener('click', logoutUser); 
    document.getElementById('admin-logout-btn').addEventListener('click', () => {
        if (window.confirm("Are you sure you want to log out as Admin?")) {
            logoutUser();
        }
    }); 
    document.getElementById('dashboard-logout-btn').addEventListener('click', logoutUser); 


    // Admin Tab Listeners 
    ui.adminTabUsers.addEventListener('click', () => setActiveAdminTab(ui.adminTabUsers, ui.adminViewUsers));
    ui.adminTabManagement.addEventListener('click', () => setActiveAdminTab(ui.adminTabManagement, ui.adminViewManagement));
    ui.adminTabRequests.addEventListener('click', () => setActiveAdminTab(ui.adminTabRequests, ui.adminViewRequests));

    // Dashboard Tab Listeners
    ui.tabRequest.addEventListener('click', () => setActiveDashboardTab(ui.tabRequest, ui.viewRequest));
    ui.tabDonor.addEventListener('click', () => setActiveDashboardTab(ui.tabDonor, ui.viewDonor));
    
    // Edit Profile Listener
    document.getElementById('edit-profile-btn').addEventListener('click', () => {
         initializeProfileSetupForm(true);
         hideAllViews();
         ui.profileSetup.classList.remove('hidden');
    });

    // Profile Form (Signup/Edit) Listener (Modified to use registerProfile/updateProfile API)
    ui.profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const role = document.getElementById('userRoleHidden').value;
        const isDonor = role === 'Donor';
        const isEdit = !!userProfile; 
        
        // Only include optional fields if the user is a Donor
        if (isDonor) {
             if (ui.ageInput.value === '') { showNotification("Please enter your age.", 'red'); return; }
             if (ui.weightInput.value === '') { showNotification("Please enter your weight.", 'red'); return; }
             if (ui.bloodTypeInput.value === '') { showNotification("Please select your blood type.", 'red'); return; }
        }

        const lastDonationDateStr = ui.lastDonationDateInput.value;
        const lastDonationTime = isDonor && lastDonationDateStr ? new Date(lastDonationDateStr).getTime() : null;
        
        // If a verified user edits their profile, set status to PENDING_VERIFICATION to force re-approval
        const status = isEdit && userProfile.status === 'VERIFIED' ? 'PENDING_VERIFICATION' : 'PENDING_VERIFICATION';
        
        const newProfile = {
            userId: isEdit ? userProfile.userId : userId, 
            name: ui.nameInput.value.trim(),
            phone: ui.phoneInput.value.trim(),
            userRole: role,
            pinCode: ui.pinCodeInput.value.trim(),
            address: ui.addressInput.value.trim(),
            status: status, 
            // Donor specific fields
            bloodType: isDonor ? ui.bloodTypeInput.value : null,
            age: isDonor ? parseInt(ui.ageInput.value) : null,
            weight: isDonor ? parseInt(ui.weightInput.value) : null,
            gender: isDonor ? ui.genderInput.value : null,
            lastDonationTime: lastDonationTime,
            bloodReportLink: isDonor ? 'UPLOAD_SIMULATED' : null, // Simulate report upload
        };

        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.textContent = isEdit ? 'Updating Profile...' : 'Registering...';
        submitBtn.disabled = true;
        
        try {
            if (isEdit) {
                await updateProfile(newProfile);
                showNotification("Profile updated successfully. Re-verification may be required.", 'green');
                showDashboard();
            } else {
                const data = await registerProfile(newProfile);
                userProfile = data.user;
                showNotification(`${role} registration submitted! Awaiting admin verification.`, 'green');
                showUserBlocked();
            }
        } catch (error) {
            console.error("Registration/Update Error:", error);
            showNotification(error.message || `Failed to ${isEdit ? 'update' : 'register'} profile.`, 'red');
        } finally {
            submitBtn.textContent = isEdit ? 'Save Profile Changes' : 'Register & Await Verification';
            submitBtn.disabled = false;
        }
    });


    // Request Form Listener (Modified to use submitRequest API)
    ui.requestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (userProfile.status !== 'VERIFIED') {
            showNotification("Request cannot be submitted. Your account is not yet verified by an administrator.", 'red');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Submitting...';
        submitBtn.disabled = true;

        const bloodTypeNeeded = document.getElementById('bloodTypeNeeded').value;
        const requestPinCode = userProfile.userRole === 'Hospital' 
            ? userProfile.pinCode 
            : document.getElementById('request-pinCode').value.trim();
            
        const requestData = {
             requesterId: userProfile.userId,
             name: userProfile.name,
             phone: userProfile.phone,
             userRole: userProfile.userRole,
             pinCode: requestPinCode,
             bloodTypeNeeded: bloodTypeNeeded,
        };

        try {
            await submitRequest(requestData);
            showNotification("Urgent request submitted! Awaiting admin approval...", 'yellow');
            updateDashboardData();
            setActiveDashboardTab(ui.tabRequest, ui.viewRequest); 

        } catch (error) {
            console.error("Request Submission Error:", error);
            showNotification(error.message || "Failed to submit request.", 'red');
        } finally {
            submitBtn.textContent = 'Submit Request & Find Nearby Donors';
            submitBtn.disabled = false;
        }
    });

    // Delete Account Listener (Modified to use deleteUser API)
    ui.deleteAccountBtn.addEventListener('click', async () => {
        if (window.confirm("Are you ABSOLUTELY SURE you want to delete your account? This action is permanent.")) {
            ui.deleteAccountBtn.textContent = 'Deleting...';
            ui.deleteAccountBtn.disabled = true;
            try {
                await deleteUser(userProfile.userId); 
                showNotification("Profile successfully deleted. Returning to main menu.", 'red');
                logoutUser();
            } catch (error) {
                showNotification(`Deletion failed: ${error.message}`, 'red');
            } finally {
                ui.deleteAccountBtn.textContent = 'Permanently Delete My Account';
                ui.deleteAccountBtn.disabled = false;
            }
        }
    });


    // --- START APPLICATION ---
    async function initializeApp() {
        ui.lastDonationDateInput.max = new Date().toISOString().split('T')[0];
        document.querySelectorAll('#profile-form input[required], #profile-form select[required], #profile-form textarea[required]').forEach(input => {
             input.dataset.originalRequired = 'true';
        });

        // 1. Attempt to sync profile from server using local ID
        const profileLoaded = await fetchAndSyncProfile(); 
        
        ui.loading.classList.add('hidden'); // Hide loading screen
        
        // 2. Determine initial view based on synced profile
        if (profileLoaded) {
            if (userProfile.userRole === 'Admin') {
                showAdminDashboard();
            } else if (userProfile.status === 'VERIFIED') {
                showDashboard();
            } else {
                 // PENDING_VERIFICATION or DENIED
                 showUserBlocked();
            }
        } else {
            showRoleSelection();
        }
    }

    window.onload = initializeApp;
</script>
</body>
</html>