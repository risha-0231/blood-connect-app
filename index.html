<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Connect Pro (Bengaluru Area Donor Matching)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
   
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js" integrity="" crossorigin="anonymous"></script>
   
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .btn-primary { background-color: #e53e3e; transition: background-color 0.15s ease,wf transform 0.1s ease; }
        .btn-primary:hover { background-color: #c53030; transform: translateY(-1px); }
        .main-card { background-color: #ffffff; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 95%; max-width: 900px; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        #donorMap { height: 350px; width: 100%; border-radius: 0.75rem; border: 2px solid #e53e3e; margin-bottom: 1.5rem; z-index: 1; }
        .role-bubble-card { transition: all 0.2s ease-in-out; cursor: pointer; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); min-height: 180px; }
        .role-bubble-card:hover { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); transform: scale(1.03); }
        .donor-bubble { background-color: #fee2e2; border: 3px solid #f87171; }
        .hospital-bubble { background-color: #eff6ff; border: 3px solid #60a5fa; }
        .admin-bubble { background-color: #f3f4f6; border: 3px solid #9ca3af; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8 flex justify-center items-start pt-6 sm:pt-10">
    <div class="main-card rounded-2xl p-6 sm:p-10 border-t-8 border-red-600">

        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-red-700">ü©∏ Blood Connect Pro (Bengaluru)</h1>
            <p class="text-gray-500 mt-2 text-xl font-semibold">Local Emergency Donor Matching System</p>
        </header>

        <div id="global-message-box" class="fixed inset-x-0 top-0 z-50 p-4 transition-all duration-300 transform -translate-y-full opacity-0">
            <div id="global-message-content" class="p-3 rounded-lg shadow-xl text-center font-medium max-w-lg mx-auto"></div>
        </div>

        <div id="loading-state" class="text-center p-12">
             <svg class="animate-spin h-10 w-10 text-red-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
               <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
             </svg>
             <p class="text-red-500 font-semibold">Initializing app components...</p>
        </div>
   
        <div id="role-selection" class="text-center p-6 sm:p-8 space-y-6">
             <h2 class="text-3xl font-bold text-red-700 mb-8">Select Your Role</h2>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <button data-role="Donor" class="select-role-btn role-bubble-card donor-bubble flex flex-col items-center justify-center p-6 text-red-700">
                      <svg class="w-12 h-12 mb-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.214-.076-.423-.22-.584m0 0a3.003 3.003 0 00-7.864-1.857M17 10v2a3 3 0 005.356 1.857M17 10v-2c0-.214-.076-.423-.22-.584M17 10v2a3 3 0 005.356 1.857M12 21a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2z"></path></svg>
                      <span class="text-xl font-extrabold">I am a Donor</span>
                      <span class="text-sm mt-1 text-gray-600">Volunteer to save lives locally.</span>
                 </button>
                 <button data-role="Hospital" class="select-role-btn role-bubble-card hospital-bubble flex flex-col items-center justify-center p-6 text-blue-700">
                      <svg class="w-12 h-12 mb-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10h16V7a2 2 0 00-2-2H6a2 2 0 00-2 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v4m-2-2h4"></path></svg>
                      <span class="text-xl font-extrabold">I am a Hospital</span>
                      <span class="text-sm mt-1 text-gray-600">Submit urgent blood requirements.</span>
                 </button>
                 <button id="select-admin-role-btn" class="role-bubble-card admin-bubble flex flex-col items-center justify-center p-6 text-gray-800">
                      <svg class="w-12 h-12 mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2v2m-4-2H7a2 2 0 00-2 2v4a2 2 0 002 2h4m2-4v4a2 2 0 01-2 2H7a2 2 0 01-2-2v-4a2 2 0 012-2h4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v2m0 0h.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18v2m0 0h.01"></path></svg>
                      <span class="text-xl font-extrabold">Administrator Login</span>
                      <span class="text-sm mt-1 text-gray-600">Manage users and requests.</span>
                 </button>
             </div>
        </div>
       
        <div id="auth-selection" class="hidden text-center space-y-6 p-6 card shadow-none border-0 rounded-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome, <span id="auth-role-display" class="text-red-600"></span></h2>
            <p class="text-gray-600 text-base">Choose an action to proceed.</p>
            <button id="auth-login-btn" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">Login</button>
            <button id="auth-register-btn" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-4 focus:ring-red-300">Register</button>
            <p class="text-sm text-gray-500 pt-2">Login is only possible after admin verification.</p>
            <button type="button" id="auth-back-to-role" class="w-full text-sm text-gray-500 hover:text-red-500 mt-4">‚Üê Back to Role Selection</button>
        </div>

        <div id="user-login" class="hidden">
             <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3"><span id="login-role-display">User</span> Login</h2>
            <form id="user-login-form" class="space-y-4">
                 <div class="space-y-1">
                   <label for="login-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                     <input type="text" id="login-name" required placeholder="John Doe" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                 </div>
                 <div class="space-y-1">
                     <label for="login-phone" class="block text-sm font-medium text-gray-700">Phone Number (10 Digits)</label>
                     <input type="number" id="login-phone" required minlength="10" maxlength="10" placeholder="e.g., 9876543210" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                 </div>
                 <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">Login to Dashboard</button>
                 <button type="button" id="login-back-to-auth" class="w-full text-sm text-gray-500 hover:text-red-500 mt-2">‚Üê Back to Auth Menu</button>
                 <button type="button" id="login-back-to-role" class="hidden">‚Üê Back to Main Menu</button>
            </form>
        </div>

        <div id="admin-login" class="hidden">
             <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Administrator Login</h2>
            <form id="admin-login-form" class="space-y-4">
                 <div class="space-y-1">
                     <label for="admin-pin" class="block text-sm font-medium text-gray-700">Admin Key (Pin Code)</label>
                     <input type="password" id="admin-pin" required placeholder="Enter 6-digit Admin Key" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                 </div>
                 <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">Login as Administrator</button>
                 <button type="button" id="admin-back-to-role" class="w-full text-sm text-gray-500 hover:text-red-500 mt-2">‚Üê Back to Main Menu</button>
            </form>
        </div>

        <div id="profile-setup" class="hidden">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                 <h2 class="text-2xl font-bold text-gray-800"><span id="registration-role">New User</span> Registration</h2>
                 <button id="back-to-dashboard-from-edit" class="hidden text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100 flex items-center">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                      Back to Dashboard
                 </button>
            </div>
           
            <form id="profile-form" class="space-y-4">
                 <input type="hidden" id="userRoleHidden" value="Donor">

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div class="space-y-1">
                         <label for="name" class="block text-sm font-medium text-gray-700"><span id="name-label-text">Full Name</span></label>
                         <input type="text" id="name" required data-original-required="true" placeholder="John Doe" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                     <div class="space-y-1">
                         <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number (10 Digits)</label>
                         <input type="number" id="phone" required data-original-required="true" minlength="10" maxlength="10" placeholder="e.g., 9876543210" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                 </div>

                 <div class="grid grid-cols-3 gap-4 donor-only-field">
                     <div class="space-y-1">
                         <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                         <input type="number" id="age" required data-original-required="true" placeholder="e.g., 30" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                     <div class="space-y-1">
                         <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                         <select id="gender" required data-original-required="true" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 bg-white focus:ring-red-500 focus:border-red-500">
                             <option value="">Select</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option>
                         </select>
                     </div>
                     <div class="space-y-1">
                         <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                         <input type="number" id="weight" required data-original-required="true" placeholder="e.g., 65" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                 </div>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div class="space-y-1">
                         <label for="pinCode" class="block text-sm font-medium text-gray-700">Pin Code (6-Digit - Your Home Area)</label>
                         <input type="number" id="pinCode" required data-original-required="true" min="100000" max="999999" placeholder="e.g., 560078" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                     </div>
                     <div class="space-y-1 donor-only-field">
                         <label for="bloodType" class="block text-sm font-medium text-gray-700">Blood Type</label>
                         <select id="bloodType" required data-original-required="true" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 bg-white focus:ring-red-500 focus:border-red-500">
                             <option value="">Select Blood Type</option>
                             <option value="A+">A+</option><option value="A-">A-</option>
                             <option value="B+">B+</option><option value="B-">B-</option>
                             <option value="AB+">AB+</option><option value="AB-">AB-</option>
                             <option value="O+">O+</option><option value="O-">O-</option>
                         </select>
                     </div>
                 </div>

                 <div class="space-y-1">
                     <label for="address" class="block text-sm font-medium text-gray-700">Full Address (Street/Locality)</label>
                     <textarea id="address" required data-original-required="true" placeholder="Apartment name, street, locality" rows="2" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500"></textarea>
                 </div>
                 
                 <h3 class="text-lg font-bold text-red-700 pt-4 border-t border-red-200"><span id="verification-title">Verification & Donation History</span></h3>
                 <div class="space-y-1 p-3 bg-red-50 rounded-lg border border-red-200 donor-only-field">
                     <label for="bloodReportFile" class="block text-sm font-bold text-red-800">Upload Latest Blood Report (PDF only) <span class="text-xs font-normal text-gray-600">(Mandatory for Admin Verification)</span></label>
                     <input type="file" id="bloodReportFile" required data-original-required="true" accept="application/pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-100 file:text-red-700 hover:file:bg-red-200">
                 </div>

                 <div class="space-y-1 donor-only-field">
                     <label for="lastDonationDate" class="block text-sm font-medium text-gray-700">Last Blood Donation Date (If never donated, leave empty)</label>
                     <input type="date" id="lastDonationDate" max="" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                 </div>
                 
                 <div class="flex items-center space-x-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                     <input type="checkbox" id="verification-check" required data-original-required="true" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                     <label for="verification-check" class="text-sm font-medium text-blue-800">I verify all provided data is accurate and can be shared for emergency contact.</label>
                 </div>
                 
                 <button type="submit" id="save-profile-btn" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">Register & Await Verification</button>
                 <button type="button" id="signup-back-to-role" class="w-full text-sm text-gray-500 hover:text-red-500 mt-2">‚Üê Back to Main Menu</button>
            </form>
        </div>
       
        <div id="user-blocked" class="hidden text-center p-10 space-y-4">
             <div class="p-6 bg-red-50 rounded-xl border border-red-300">
                 <h2 class="text-2xl font-bold text-red-700 mb-2">üö´ Account Pending Verification</h2>
                 <p class="text-gray-600">Your profile is awaiting verification by an administrator. This includes checking your uploaded blood report/hospital details.</p>
                 <p class="text-sm text-gray-500 mt-2">Please check back later, or try to login again once verified.</p>
             </div>
             <button id="blocked-logout-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100">Back to Main Menu</button>
        </div>
       
        <div id="admin-dashboard" class="hidden">
             <div class="flex justify-between items-center mb-6 border-b pb-3">
                 <h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
                 <button id="admin-logout-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100">Logout</button>
             </div>
             
             <div class="flex space-x-2 mb-6 border-b border-gray-200">
                 <button id="admin-tab-users" class="py-2 px-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition duration-150">User Verification</button>
                 <button id="admin-tab-management" class="py-2 px-4 text-sm font-bold text-gray-600 hover:text-blue-600 border-b-2 border-transparent transition duration-150">All Users / Management</button>
                 <button id="admin-tab-requests" class="py-2 px-4 text-sm font-bold text-gray-600 hover:text-blue-600 border-b-2 border-transparent transition duration-150">Pending Requests</button>
             </div>

             <div id="admin-view-users">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Pending User Verifications</h3>
                 <div id="pending-users-list" class="space-y-4">
                     <p id="no-pending-users" class="text-gray-500 text-center p-6 bg-green-50 rounded-lg border border-green-200 hidden">‚úÖ All current users are verified.</p>
                 </div>
             </div>
             
             <div id="admin-view-management" class="hidden">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Donor and Hospital Accounts</h3>
                 <div id="all-users-list" class="space-y-4">
                      <p id="no-users-to-manage" class="text-gray-500 text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200 hidden">No users found (excluding admin).</p>
                 </div>
             </div>

             <div id="admin-view-requests" class="hidden">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Urgent Requests Pending Approval</h3>
                 <div id="pending-requests-list" class="space-y-4">
                     <p id="no-pending-requests" class="text-gray-500 text-center p-6 bg-green-50 rounded-lg border border-green-200 hidden">‚úÖ No blood requests are currently awaiting approval.</p>
                 </div>
             </div>
        </div>
       
        <div id="main-dashboard" class="hidden">
           
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h2 class="text-2xl font-bold text-gray-800">Dashboard (<span id="dashboard-role-display">Donor</span>)</h2>
                <div class="flex space-x-3">
                    <button id="edit-profile-btn" class="text-sm text-gray-500 hover:text-blue-500 transition duration-150 p-2 rounded-full hover:bg-gray-100">Edit Profile</button>
                    <button id="delete-account-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100">Delete Profile</button>
                    <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-full hover:bg-gray-100">Logout</button>
                </div>
            </div>

            <div class="mt-6">
              <h2 class="text-lg font-bold mb-2">My Requests</h2>
              <div id="no-open-requests" class="text-gray-500 text-sm my-2 hidden">You have no active blood requests.</div>
              <div id="my-requests-list" class="flex flex-col gap-3"></div>
            </div>
           
            <div id="donor-status-section" class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-200">
                <p class="text-lg font-bold text-red-700 flex items-center">
                    <span class="mr-2">Donor Status:</span>
                    <span id="donor-status"></span>
                </p>
                <p class="text-sm text-gray-700 mt-1">Home Pin Code: <code id="user-pin-display" class="font-mono text-base text-red-600 font-bold"></code></p>
                <p class="text-xs text-gray-500">Blood Type: <code id="user-blood-display" class="font-mono text-xs font-semibold"></code></p>
            </div>

            <div class="flex space-x-2 mb-6 border-b border-gray-200">
                <button id="tab-request" class="py-2 px-4 text-sm font-bold text-red-600 border-b-2 border-red-600 transition duration-150">Request Blood & Find Donors</button>
                <button id="tab-donor" class="py-2 px-4 text-sm font-bold text-gray-600 hover:text-red-600 border-b-2 border-transparent transition duration-150">Available Donor Requests</button>
            </div>

            <div id="view-request">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Submit Urgent Blood Need</h3>
                <p class="text-sm text-gray-600 mb-6"><span id="request-pin-instruction">Enter the blood type and **current pin code** where blood is needed.</span></p>

                <form id="request-form" class="space-y-4 p-6 bg-gray-50 rounded-xl">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div id="request-pin-group">
                             <label for="request-pinCode" class="block text-sm font-medium text-gray-700">Current Area Pin Code (Where Blood is Needed)</label>
                             <input type="number" id="request-pinCode" required data-original-required="true" min="100000" max="999999" placeholder="e.g., 560078" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 focus:ring-red-500 focus:border-red-500">
                         </div>
                         <div>
                             <label for="bloodTypeNeeded" class="block text-sm font-medium text-gray-700">Blood Type Needed</label>
                             <select id="bloodTypeNeeded" required data-original-required="true" class="mt-1 block w-full rounded-md shadow-sm p-3 border border-gray-300 bg-white focus:ring-red-500 focus:border-red-500">
                                 <option value="">Select Blood Type</option>
                                 <option value="A+">A+</option><option value="A-">A-</option>
                                 <option value="B+">B+</option><option value="B-">B-</option>
                                 <option value="AB+">AB+</option><option value="AB-">AB-</option>
                                 <option value="O+">O+</option><option value="O-">O-</option>
                             </select>
                         </div>
                     </div>
                     <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary focus:outline-none focus:ring-4 focus:ring-red-300">Submit Request & Find Nearby Donors</button>
                </form>

                <div class="mt-8 pt-4 border-t border-gray-300">
                    <h4 class="text-lg font-bold mb-4 text-blue-700">Matching Donors Near Requested Area (<span id="matched-pin-display">...</span>)</h4>
                    <div id="donorMap"></div>
                    <div id="donors-list" class="space-y-4">
                        <p id="no-donors" class="text-gray-500 text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200">üîç Submit a request above to find compatible donors in the area.</p>
                    </div>
                </div>
            </div>

            <div id="view-donor" class="hidden">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Emergency Matches in Your Area</h3>
                <div id="requests-list" class="space-y-4">
                    <p id="no-requests" class="text-gray-500 text-center p-6 bg-green-50 rounded-lg border border-green-200 hidden">‚úÖ No active matching requests in your vicinity right now.</p>
                    <p id="not-donor-message" class="text-gray-700 text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200 hidden">You are currently marked as **Ineligible to Donate**. Update your profile for eligibility status.</p>
                </div>
            </div>
           
            <div id="my-requests-section" class="mt-8 pt-4 border-t border-gray-300 hidden">
                <h4 class="text-lg font-semibold mb-3">Your Open Requests / Match Notifications</h4>
                <div id="my-requests-list" class="space-y-3">
                    <p class="text-sm text-gray-500" id="no-open-requests">You have no open requests or pending match notifications.</p>
                </div>
            </div>
        </div>
        <div id="profile-management" class="hidden"></div>
    </div>
</div>

<script>
    // --- APP LOGIC ---
    
    // ==========================================
    // ‚ö†Ô∏è IMPORTANT: UPDATE THIS URL! ‚ö†Ô∏è
    // ==========================================
    // If you are running locally, use "http://localhost:4000"
    // If you have deployed to Render, put your URL here (e.g., "https://blood-connect-api.onrender.com")
    // Do NOT include a trailing slash at the end.
    const BACKEND_URL = "https://blood-connect-api-67g9.onrender.com"; 
    // ==========================================

    const API = {
      async post(path, body) {
        try {
          const res = await fetch(`${BACKEND_URL}${path}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          if (!res.ok) { console.warn(`API POST ${path} failed:`, res.status); return null; }
          return await res.json();
        } catch (e) { console.warn('API POST error', e); return null; }
      },
      async put(path, body) {
        try {
          const res = await fetch(`${BACKEND_URL}${path}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          if (!res.ok) { console.warn(`API PUT ${path} failed:`, res.status); return null; }
          return await res.json();
        } catch (e) { console.warn('API PUT error', e); return null; }
      },
      async get(path) {
        try {
          constGV = await fetch(`${BACKEND_URL}${path}`);
          const res = await fetch(`${BACKEND_URL}${path}`);
          if (!res.ok) { console.warn(`API GET ${path} failed:`, res.status); return null; }
          return await res.json();
        } catch (e) { console.warn('API GET error', e); return null; }
      }
    };

    let socket = null;
    function initSocket() {
      try {
        if (!window.io) { console.warn('Socket.io client not loaded.'); return; }
        socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });
        socket.on('connect', () => console.log('Socket connected:', socket.id));
        
        socket.on('newRequest', (data) => {
          console.log('socket newRequest', data);
          showNotification('New emergency request received (from server).', 'blue');
          fetchAndSyncUsers();
        });

        // --- NEW LISTENERS FOR SYNC ---
        socket.on('requestApproved', (data) => {
            console.log('socket requestApproved', data);
            showNotification('A blood request was just APPROVED!', 'green');
            fetchAndSyncUsers(); // Reload data immediately
        });
        socket.on('requestDenied', (data) => {
            console.log('socket requestDenied', data);
            fetchAndSyncUsers(); // Reload data immediately
        });
        // -----------------------------

        socket.on('userVerified', (data) => {
          console.log('socket userVerified', data);
          showNotification('User verification changed by admin.', 'green');
          fetchAndSyncUsers();
        });
        socket.on('userRegistered', (data) => {
          console.log('socket userRegistered', data);
          fetchAndSyncUsers();
        });
      } catch (e) { console.warn('initSocket error', e); }
    }

    // --- REWRITTEN SYNC FUNCTION ---
    // This fetches ALL users and ALL requests and "stitches" them together
    // so your frontend logic (which expects user objects to have request info) works correctly.
    async function fetchAndSyncUsers() {
      console.log("Syncing data from backend...");
      
      // 1. Call the new endpoint
      const resp = await API.get('/api/sync-storage');
      
      if (resp && resp.users) {
        const serverUsers = resp.users;
        const serverRequests = resp.requests || [];

        // 2. Map users and set default request state
        let mergedList = serverUsers.map(u => {
            return {
                ...u,
                // Default request state to false
                isRequestActive: false,
                isPendingAdminApproval: false,
                bloodTypeNeeded: '',
                requestPinCode: '',
                donorMatch: null, 
                userId: u.userId || u._id 
            };
        });

        // 3. Stitch Requests into the Users
        serverRequests.forEach(req => {
            // Find the user who made this request
            const userIndex = mergedList.findIndex(u => u.userId === req.requesterId);
            
            if (userIndex > -1) {
                // Determine active status based on request status
                // If it is PENDING or APPROVED, we consider it "Active" for the dashboard
                const isActive = (req.status === 'APPROVED' || req.status === 'PENDING');
                
                mergedList[userIndex].isRequestActive = isActive;
                mergedList[userIndex].isPendingAdminApproval = (req.status === 'PENDING');
                mergedList[userIndex].bloodTypeNeeded = req.bloodTypeNeeded;
                mergedList[userIndex].requestPinCode = req.pinCode;
                mergedList[userIndex].updatedAt = req.updatedAt || Date.now();
                mergedList[userIndex]._requestId = req._id; // Store request ID
            }
        });

        // 4. Save to LocalStorage to update UI
        localStorage.setItem(ALL_USERS_KEY, JSON.stringify(mergedList));
        console.log('Sync complete. Users updated:', mergedList.length);
        
        // 5. Trigger UI Refresh
        if (typeof updateDashboardData === 'function') {
            updateDashboardData();
        }
        if (ui && ui.pendingRequestsList && !ui.pendingRequestsList.closest('.hidden')) {
             renderPendingRequests();
        }
         if (ui && ui.pendingUsersList && !ui.pendingUsersList.closest('.hidden')) {
             renderPendingUsers();
        }
      }
    }

    async function apiRegisterProfile(profile) {
      const body = { ...profile };
      const resp = await API.post('/api/auth/register', body);
      if (resp && resp.user) {
        updateAllUsersList(resp.user);
        console.log('Profile merged with backend user.');
      }
    }

    async function apiCreateRequest(requestObj) {
      const resp = await API.post('/api/request', requestObj);
      if (resp && resp.request) {
        console.log('Request created on backend:', resp.request);
        showNotification('Request sent to backend.', 'green');
      }
    }

    setTimeout(initSocket, 800);

    const USER_PROFILE_KEY = 'blood_connect_user_profile';
    const ALL_USERS_KEY = 'blood_connect_all_users';
    const DONATION_COOLDOWN_DAYS = 90;
    const DONATION_COOLDOWN_MS = DONATION_COOLDOWN_DAYS * 24 * 60 * 60 * 1000;
    const ADMIN_KEY = '999999';

    let userProfile = null;
    let userId = localStorage.getItem('local_user_id') || crypto.randomUUID();
    localStorage.setItem('local_user_id', userId);
    let currentSelectedRole = null;
   
    const BANGALORE_PROXIMITY_MAP = {
        '560078': ['560078', '560076', '560041', '560083'],
        '560066': ['560066', '560037', '560048', '560087'],
        '560001': ['560001', '560002', '560005', '560008'],
        '560037': ['560037', '560066', '560048'],
        '560041': ['560041', '560076', '560078'],
        '560076': ['560076', '560078', '560041'],
    };
    const PIN_COORDINATES = {
        '560078': [12.903, 77.580],
        '560041': [12.915, 77.603],
        '560066': [12.978, 77.753],
        '560001': [12.980, 77.595],
        '560076': [12.923, 77.585],
        '560083': [12.890, 77.570],
        '560037': [12.985, 77.700],
    };
   
    let donorMap = null;

    const seedSampleData = () => {
      const existing = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
      if (!existing || existing.length === 0) {
        localStorage.setItem(ALL_USERS_KEY, JSON.stringify([]));
      }
      console.log('Local cache initialized.');
      // Attempt initial sync
      fetchAndSyncUsers();
    };

    const showNotification = (message, type = 'blue') => {
        const box = document.getElementById('global-message-box');
        const content = document.getElementById('global-message-content');
        content.className = 'p-3 rounded-lg shadow-xl text-center font-medium max-w-lg mx-auto';
        content.classList.add(`bg-${type}-600`, 'text-white');
        content.textContent = message;
        box.classList.remove('-translate-y-full', 'opacity-0');
        box.classList.add('translate-y-0', 'opacity-100');
        setTimeout(() => {
            box.classList.remove('translate-y-0', 'opacity-100');
            box.classList.add('-translate-y-full', 'opacity-0');
        }, 5000);
    };

    const canDonateTo = {
        'O-': ['O-', 'O+', 'A-', 'A+', 'B-', 'B+', 'AB-', 'AB+'],
        'O+': ['O+', 'A+', 'B+', 'AB+'],
        'A-': ['A-', 'A+', 'AB-', 'AB+'],
        'A+': ['A+', 'AB+'],
        'B-': ['B-', 'B+', 'AB-', 'AB+'],
        'B+': ['B+', 'AB+'],
        'AB-': ['AB-', 'AB+'],
        'AB+': ['AB+']
    };
    const isCompatible = (donorType, neededType) => canDonateTo[donorType]?.includes(neededType) || false;

    const getNearbyPinCodes = (pinCode) => {
        return BANGALORE_PROXIMITY_MAP[pinCode] || [pinCode];
    };
   
    const getDonorsInArea = (requestedPinCode, neededBloodType) => {
        const allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        constKv = getNearbyPinCodes(requestedPinCode);
        const nearbyPins = getNearbyPinCodes(requestedPinCode);
        const now = Date.now();

        const matchingDonors = allUsers.filter(donor => {
            if (donor.userId === userId || donor.userRole !== 'Donor') return false;
            if (donor.status !== 'VERIFIED') return false;
            const isEligible = (donor.weight >= 50 && donor.age >= 18 && donor.age <= 65) &&
                             (donor.lastDonationTime + DONATION_COOLDOWN_MS < now);
            return isEligible &&
                   isCompatible(donor.bloodType, neededBloodType) &&
                   nearbyPins.includes(donor.pinCode);
        });
        matchingDonors.sort((a, b) => {
            const aIsExact = a.pinCode === requestedPinCode;
            const bIsExact = b.pinCode === requestedPinCode;
            if (aIsExact && !bIsExact) return -1;
            if (!aIsExact && bIsExact) return 1;  
            return a.name.localeCompare(b.name);
        });
        return matchingDonors;
    };


    const updateAllUsersList = (newProfile) => {
        let allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        const index = allUsers.findIndex(user => user.userId === newProfile.userId);
        if (index > -1) {
            allUsers[index] = newProfile;
        } else {
            allUsers.push(newProfile);
        }
        localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers));
    };

    const saveProfile = (profile) => {
        if (profile) {
            localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profile));
            userProfile = profile;
            userId = profile.userId; 
            localStorage.setItem('local_user_id', userId);
            updateAllUsersList(profile);
        } else {
            localStorage.removeItem(USER_PROFILE_KEY);
            localStorage.removeItem('local_user_id');
            userProfile = null;
            userId = null;
        }
    };

    const loadProfile = () => {
        const profileData = localStorage.getItem(USER_PROFILE_KEY);
        if (profileData) {
            userProfile = JSON.parse(profileData);
            userId = userProfile.userId;
        }
    };

    const hideAllViews = () => {
        [ui.loading, ui.roleSelection, ui.userLogin, ui.adminLogin, ui.adminDashboard,
         ui.userBlocked, ui.profileSetup, ui.mainDashboard, ui.authSelection].forEach(view => {
            view.classList.add('hidden');
        });
    };

    const logoutUser = () => {
        saveProfile(null);
        showRoleSelection();
    };
    const showRoleSelection = () => {
        hideAllViews();
        currentSelectedRole = null;
        ui.roleSelection.classList.remove('hidden');
    };
    function showAuthSelection(role) {
        hideAllViews();
        currentSelectedRole = role;
        ui.authRoleDisplay.textContent = role;
        ui.authSelection.classList.remove('hidden');
    }

    function showUserLogin() {
        hideAllViews();
        ui.loginRoleDisplay.textContent = currentSelectedRole;
        ui.userLogin.classList.remove('hidden');
    }

    function showAdminLogin() {
        hideAllViews();
        ui.adminLogin.classList.remove('hidden');
    }

    function showUserBlocked() {
        hideAllViews();
        ui.userBlocked.classList.remove('hidden');
        const messageBox = ui.userBlocked.querySelector('.p-6');
       
        if (userProfile.status === 'DENIED') {
            messageBox.innerHTML = `
                <h2 class="text-2xl font-bold text-red-700 mb-2">‚ùå Account Denied</h2>
                <p class="text-gray-600">Your registration was reviewed and **denied** by the administrator. This account cannot be used.</p>
                <p class="text-sm text-gray-500 mt-2">Please contact support or re-register with accurate information.</p>
            `;
        } else { // PENDING_VERIFICATION
            messageBox.innerHTML = `
                <h2 class="text-2xl font-bold text-red-700 mb-2">üö´ Account Pending Verification</h2>
                <p class="text-gray-600">Your profile is awaiting verification by an administrator. This includes checking your uploaded blood report/hospital details.</p>
                <p class="text-sm text-gray-500 mt-2">Please check back later, or try to login again once verified.</p>
            `;
        }
    }

    function showAdminDashboard() {
        hideAllViews();
        ui.adminDashboard.classList.remove('hidden');
        setActiveAdminTab(ui.adminTabUsers, ui.adminViewUsers);
        renderPendingUsers();
        renderPendingRequests();
    }

    const calculateDonorEligibility = (profile) => {
        const now = Date.now();
        if (profile.userRole !== 'Donor') {
            return { eligible: false, status: 'N/A: Not a Donor Profile', color: 'text-gray-500' };
        }
        if (profile.status === 'DENIED') {
             return { eligible: false, status: 'DENIED: Registration Permanently Rejected', color: 'text-red-700' };
        }
        if (profile.status !== 'VERIFIED') {
            return { eligible: false, status: 'UNVERIFIED: Awaiting Admin Approval', color: 'text-red-500' };
        }
        if (!(profile.weight >= 50 && profile.age >= 18 && profile.age <= 65)) {
            return { eligible: false, status: `INELIGIBLE: Age/Weight Restrictions (Min 18, Max 65, Min 50kg)`, color: 'text-red-600' };
        }
        if (profile.lastDonationTime) {
            const nextDonationTime = profile.lastDonationTime + DONATION_COOLDOWN_MS;
            if (nextDonationTime > now) {
                const daysRemaining = Math.ceil((nextDonationTime - now) / (24 * 60 * 60 * 1000));
                return { eligible: false, status: `COOLDOWN: ${daysRemaining} days remaining (Eligible: ${new Date(nextDonationTime).toLocaleDateString()})`, color: 'text-yellow-600' };
            }
        }
        return { eligible: true, status: 'AVAILABLE for Donation', color: 'text-green-600' };
    };

    function showProfileSetup(isEdit = false) {
        hideAllViews();
        ui.profileSetup.classList.remove('hidden');
        ui.backToDashboardFromEditBtn.classList.toggle('hidden', !isEdit);
        document.getElementById('save-profile-btn').textContent = isEdit ? 'Update Profile' : 'Register & Await Verification';
        document.getElementById('signup-back-to-role').classList.toggle('hidden', isEdit);
        const role = currentSelectedRole || (userProfile ? userProfile.userRole : "Donor");
        const isDonor = role === 'Donor';
       
        document.getElementById('registration-role').textContent = isEdit ? "Edit " + role + " Profile" : "New " + role;
        document.getElementById('userRoleHidden').value = role;
        document.getElementById('name-label-text').textContent = isDonor ? "Full Name" : "Hospital Name";
        document.getElementById('verification-title').textContent = isDonor ? "Verification & Donation History" : "Hospital Verification Details";
        ui.bloodReportFile.required = !isEdit && isDonor;

        document.querySelectorAll('.donor-only-field').forEach(el => {
            el.classList.toggle('hidden', !isDonor);
            el.querySelectorAll('input, select, textarea').forEach(input => {
                input.required = isDonor ? input.dataset.originalRequired === 'true' : false;
            });
        });
        if (isEdit && userProfile) {
            ui.nameInput.value = userProfile.name || '';
            ui.phoneInput.value = userProfile.phone || '';
            ui.ageInput.value = userProfile.age || '';
            ui.genderInput.value = userProfile.gender || '';
            ui.weightInput.value = userProfile.weight || '';
            ui.pinCodeInput.value = userProfile.pinCode || '';
            ui.bloodTypeInput.value = userProfile.bloodType || '';
            ui.addressInput.value = userProfile.address || '';
            ui.lastDonationDateInput.value = userProfile.lastDonationDate || '';
            ui.bloodReportFile.value = '';
        } else {
            ui.profileForm.reset();
            userId = crypto.randomUUID();
            localStorage.setItem('local_user_id', userId);
            userProfile = null;
        }
    }

    function showDashboard() {
        // Must refresh data to ensure we see latest requests
        fetchAndSyncUsers();

        if (!userProfile || userProfile.userRole === 'Admin' || userProfile.status !== 'VERIFIED') {
            if (userProfile && userProfile.userRole !== 'Admin') {
                showUserBlocked();
                return;
            }
            logoutUser();
            return;
        }
       
        hideAllViews();
        ui.mainDashboard.classList.remove('hidden');
        const isDonor = userProfile.userRole === 'Donor';
        const isHospital = userProfile.userRole === 'Hospital';
       
        ui.dashboardRoleDisplay.textContent = userProfile.userRole;
        ui.userPinDisplay.textContent = userProfile.pinCode;
        ui.userBloodDisplay.textContent = userProfile.bloodType || 'N/A';
       
        document.getElementById('donor-status-section').classList.toggle('hidden', !isDonor);
        ui.tabDonor.classList.toggle('hidden', !isDonor);
        ui.viewDonor.classList.toggle('hidden', !isDonor);

        const requestPinGroup = document.getElementById('request-pin-group');
        const requestPinInput = document.getElementById('request-pinCode');
        const requestPinInstruction = document.getElementById('request-pin-instruction');
        if (isHospital) {
            requestPinGroup.classList.add('hidden');
            requestPinInput.required = false;
            requestPinInput.value = userProfile.pinCode;
            requestPinInstruction.innerHTML = `Enter the blood type. **Your registered Pin Code (${userProfile.pinCode})** will be used for matching.`;
        } else {
            requestPinGroup.classList.remove('hidden');
            requestPinInput.required = true;
            requestPinInput.value = '';
            requestPinInstruction.innerHTML = `Enter the blood type and **current pin code** where blood is needed.`;
        }
       
        if (isDonor) {
            const eligibility = calculateDonorEligibility(userProfile);
            ui.donorStatus.textContent = eligibility.status;
            ui.donorStatus.className = `font-bold ${eligibility.color}`;
        }

        initMap();
        if (isDonor && document.querySelector('#tab-donor.border-red-600')) {
            setActiveTab(ui.tabDonor, ui.viewDonor);
        } else {
            setActiveTab(ui.tabRequest, ui.viewRequest);
        }
       
        renderMyRequests();
        ui.myRequestsSection.classList.toggle('hidden', !userProfile.isRequestActive && !userProfile.donorMatch);
    }
   
    function setActiveAdminTab(activeButton, activeView) {
        [ui.adminTabUsers, ui.adminTabRequests, ui.adminTabManagement].forEach(btn => {
            btn.classList.remove('border-blue-600', 'text-blue-600');
            btn.classList.add('text-gray-600', 'border-transparent');
        });
        activeButton.classList.add('border-blue-600', 'text-blue-600');
        activeButton.classList.remove('text-gray-600', 'border-transparent');

        [ui.adminViewUsers, ui.adminViewRequests, ui.adminViewManagement].forEach(view => view.classList.add('hidden'));
        activeView.classList.remove('hidden');
        if (activeView === ui.adminViewManagement) {
            renderAllUsers();
        }
    }
   
    function setActiveTab(activeButton, activeView) {
        [ui.tabRequest, ui.tabDonor].forEach(btn => {
            btn.classList.remove('border-red-600', 'text-red-600');
            btn.classList.add('text-gray-600', 'border-transparent');
        });
        activeButton.classList.add('border-red-600', 'text-red-600');
        activeButton.classList.remove('text-gray-600', 'border-transparent');

        [ui.viewRequest, ui.viewDonor].forEach(view => view.classList.add('hidden'));
        activeView.classList.remove('hidden');
       
        if (activeView === ui.viewDonor) {
            updateDashboardData();
            if (userProfile && userProfile.pinCode &&PIN_COORDINATES[userProfile.pinCode]) {
                const donorCoords = PIN_COORDINATES[userProfile.pinCode];
                initMap(donorCoords);
                donorMap.eachLayer(layer => { if (layer instanceof L.Marker) { donorMap.removeLayer(layer); } });
                const redIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                L.marker(donorCoords, { icon: redIcon })
                 .bindPopup(`<b>Your Home Area (Donor):</b><br>Pin ${userProfile.pinCode}<br>Type: ${userProfile.bloodType}`)
                 .addTo(donorMap);
            }
        } else {
             if (donorMap) {
                 donorMap.eachLayer(layer => { if (layer instanceof L.Marker) { donorMap.removeLayer(layer); } });
             }
             ui.donorsList.innerHTML = '';
             ui.noDonors.textContent = "üîç Submit a request above to find compatible donors in the area.";
             ui.noDonors.classList.remove('hidden');
             ui.matchedPinDisplay.textContent = '...';
        }
    }


    function initMap(coords = [12.9716, 77.5946]) { 
        if (!donorMap) {
            donorMap = L.map('donorMap').setView(coords, 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(donorMap);
        } else {
             donorMap.setView(coords, 12);
        }
    }
   
    function updateDashboardData() {
        if (!userProfile) return;
        
        // 1. Get all users and filter for those with ACTIVE requests
        const allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        
        // Debugging: Check if we can see the requests at all
        console.log("Total Users loaded:", allUsers.length);
        
        const allApprovedRequests = allUsers.filter(user => {
            // Must have active request, NOT be pending admin, and NOT be the current user
            return user.isRequestActive === true && 
                   user.isPendingAdminApproval === false && 
                   String(user.userId) !== String(userId);
        });

        console.log("Active Approved Requests found:", allApprovedRequests.length);

        const eligibility = calculateDonorEligibility(userProfile);
        let matchingRequests = [];
        
        // 2. Normalize Donor Data (Force to String)
        const donorPinCode = String(userProfile.pinCode);
        const nearbyPins = getNearbyPinCodes(donorPinCode); // This returns strings like ['560076', '560078']

        if (eligibility.eligible) {
            matchingRequests = allApprovedRequests
                .filter(request => {
                    // 3. Robust Matching Logic
                    
                    // Blood Type Match
                    const bloodMatch = isCompatible(userProfile.bloodType, request.bloodTypeNeeded);
                    
                    // Pin Code Match (Force Request Pin to String so 'includes' works)
                    const requestPin = String(request.requestPinCode);
                    const pinMatch = nearbyPins.includes(requestPin);

                    // Debugging specific mismatches
                    if (!bloodMatch) console.log(`Skipping req ${request.name}: Blood mismatch (${request.bloodTypeNeeded})`);
                    if (!pinMatch) console.log(`Skipping req ${request.name}: Pin mismatch (${requestPin} not in ${nearbyPins})`);
                    
                    return bloodMatch && pinMatch;
                });

            // Sort by proximity (Exact match first)
            matchingRequests.sort((a, b) => {
                const aIsExact = String(a.requestPinCode) === donorPinCode;
                const bIsExact = String(b.requestPinCode) === donorPinCode;

                if (aIsExact && !bIsExact) return -1;
                if (!aIsExact && bIsExact) return 1;
                
                // Fallback to sort by time
                return (b.updatedAt || 0) - (a.updatedAt || 0);
            });
        }
        
        console.log("Final Matching Requests for display:", matchingRequests.length);
        renderDonorRequests(matchingRequests, eligibility);
    }

    function deleteAccount(userIdToDelete, isPermanent = false) {
        if (!isPermanent && !window.confirm("WARNING: Are you absolutely sure you want to permanently delete this account? This cannot be undone.")) {
            return;
        }
        let allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        const userToDelete = allUsers.find(user => user.userId === userIdToDelete);
        if (!userToDelete) return;

        allUsers = allUsers.filter(user => user.userId !== userIdToDelete);
        localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers));
        if (userIdToDelete === userId) {
            saveProfile(null);
            showNotification("Profile successfully deleted. Returning to main menu.", 'red');
            setTimeout(() => { showRoleSelection(); }, 1500);
        } else {
             showNotification(`${userToDelete.name} (${userToDelete.userRole}) has been permanently deleted.`, 'red');
             renderPendingUsers();
             renderAllUsers();
        }
    }

    const ui = {
        loading: document.getElementById('loading-state'),
        roleSelection: document.getElementById('role-selection'),
        authSelection: document.getElementById('auth-selection'),
        authRoleDisplay: document.getElementById('auth-role-display'),
        authLoginBtn: document.getElementById('auth-login-btn'),
        authRegisterBtn: document.getElementById('auth-register-btn'),
        userLogin: document.getElementById('user-login'),
        adminLogin: document.getElementById('admin-login'),
        adminDashboard: document.getElementById('admin-dashboard'),
        userBlocked: document.getElementById('user-blocked'),
        profileSetup: document.getElementById('profile-setup'),
        mainDashboard: document.getElementById('main-dashboard'),
        profileForm: document.getElementById('profile-form'),
        requestForm: document.getElementById('request-form'),
        donorStatus: document.getElementById('donor-status'),
       
        nameInput: document.getElementById('name'),
        phoneInput: document.getElementById('phone'),
        ageInput: document.getElementById('age'),
        genderInput: document.getElementById('gender'),
        weightInput: document.getElementById('weight'),
        pinCodeInput: document.getElementById('pinCode'),
        bloodTypeInput: document.getElementById('bloodType'),
        addressInput: document.getElementById('address'),
        lastDonationDateInput: document.getElementById('lastDonationDate'),
        bloodReportFile: document.getElementById('bloodReportFile'),
        backToDashboardFromEditBtn: document.getElementById('back-to-dashboard-from-edit'),
        deleteAccountBtn: document.getElementById('delete-account-btn'),
        loginRoleDisplay: document.getElementById('login-role-display'),
        dashboardRoleDisplay: document.getElementById('dashboard-role-display'),

        pendingUsersList: document.getElementById('pending-users-list'),
        pendingRequestsList: document.getElementById('pending-requests-list'),
        adminTabUsers: document.getElementById('admin-tab-users'),
        adminTabManagement: document.getElementById('admin-tab-management'),
        adminTabRequests: document.getElementById('admin-tab-requests'),
        adminViewUsers: document.getElementById('admin-view-users'),
        adminViewManagement: document.getElementById('admin-view-management'),
        adminViewRequests: document.getElementById('admin-view-requests'),
        noPendingUsers: document.getElementById('no-pending-users'),
        noPendingRequests: document.getElementById('no-pending-requests'),
        allUsersList: document.getElementById('all-users-list'),
        noUsersToManage: document.getElementById('no-users-to-manage'),

        loginName: document.getElementById('login-name'),
        loginPhone: document.getElementById('login-phone'),
        userLoginForm: document.getElementById('user-login-form'),

        donorsList: document.getElementById('donors-list'),
        noDonors: document.getElementById('no-donors'),
        matchedPinDisplay: document.getElementById('matched-pin-display'),
        requestsList: document.getElementById('requests-list'),
        noRequests: document.getElementById('no-requests'),
        notDonorMessage: document.getElementById('not-donor-message'),
        userPinDisplay: document.getElementById('user-pin-display'),
        userBloodDisplay: document.getElementById('user-blood-display'),
        tabRequest: document.getElementById('tab-request'),
        tabDonor: document.getElementById('tab-donor'),
        viewRequest: document.getElementById('view-request'),
        viewDonor: document.getElementById('view-donor'),
        logoutBtn: document.getElementById('logout-btn'),
        editProfileBtn: document.getElementById('edit-profile-btn'),
        myRequestsList: document.getElementById('my-requests-list'),
        myRequestsSection: document.getElementById('my-requests-section'),
        noOpenRequests: document.getElementById('no-open-requests'),
    };

    document.querySelectorAll('.select-role-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const role = e.currentTarget.dataset.role;
            showAuthSelection(role);
        });
    });
    ui.authLoginBtn.addEventListener('click', showUserLogin);
    ui.authRegisterBtn.addEventListener('click', () => showProfileSetup(false));
    document.getElementById('auth-back-to-role').addEventListener('click', showRoleSelection);
    document.getElementById('select-admin-role-btn').addEventListener('click', showAdminLogin);
    ui.adminLogin.addEventListener('submit', (e) => {
        e.preventDefault();
        const inputPin = document.getElementById('admin-pin').value.trim();
        if (inputPin === ADMIN_KEY) {
            const adminProfile = { userId: 'admin-id-123', name: "Local Admin", userRole: "Admin", pinCode: ADMIN_KEY, isVerified: true, status: 'VERIFIED', bloodReportLink: null };
            saveProfile(adminProfile);
            showNotification("Admin login successful!", 'green');
            showAdminDashboard();
        } else {
            showNotification("Admin Key is incorrect.", 'red');
        }
    });
    document.getElementById('admin-back-to-role').addEventListener('click', showRoleSelection);

    ui.userLoginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const inputName = ui.loginName.value.trim();
        const inputPhone = ui.loginPhone.value.trim();
       
        let allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        const matchedUser = allUsers.find(u =>
            u.userRole === currentSelectedRole &&
            u.name.toLowerCase() === inputName.toLowerCase() &&
            u.phone === inputPhone
        );

        if (!matchedUser) {
            showNotification(`Login failed: ${currentSelectedRole} not found. Please check details or register.`, 'red');
            return;
        }
        if (matchedUser.status !== 'VERIFIED') {
            saveProfile(matchedUser);
            showUserBlocked();
            return;
        }
        saveProfile(matchedUser);
        showNotification(`${matchedUser.userRole} login successful! Welcome, ${matchedUser.name}.`, 'green');
        showDashboard();
    });
    document.getElementById('login-back-to-auth').addEventListener('click', () => showAuthSelection(currentSelectedRole));
    document.getElementById('blocked-logout-btn').addEventListener('click', logoutUser);

    document.getElementById('admin-logout-btn').addEventListener('click', () => {
        if (window.confirm("Are you sure you want to log out as Admin?")) {
            logoutUser();
        }
    });
    ui.adminTabUsers.addEventListener('click', () => setActiveAdminTab(ui.adminTabUsers, ui.adminViewUsers));
    ui.adminTabManagement.addEventListener('click', () => setActiveAdminTab(ui.adminTabManagement, ui.adminViewManagement));
    ui.adminTabRequests.addEventListener('click', () => setActiveAdminTab(ui.adminTabRequests, ui.adminViewRequests));
    ui.profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
       
        const role = document.getElementById('userRoleHidden').value;
        constQP = document.getElementById('userRoleHidden').value;
        const isDonor = role === 'Donor';
       
        const lastDonationDateStr = ui.lastDonationDateInput.value;
        const lastDonationTime = isDonor && lastDonationDateStr ? new Date(lastDonationDateStr).getTime() : 0;
        
        const ageInt = isDonor ? parseInt(ui.ageInput.value) : null;
        const weightInt = isDonor ? parseInt(ui.weightInput.value) : null;
       
        const inputName = ui.nameInput.value.trim();
        const inputPhone = ui.phoneInput.value.trim();
        const isEdit = !!userProfile;
       
        if (inputPhone.length !== 10) {
            showNotification("Phone number must be exactly 10 digits.", 'red');
            return;
        }
        if (!document.getElementById('verification-check').checked) {
            showNotification("You must check the verification box to proceed.", 'red');
            return;
        }
       
        letWQ = userProfile ? userProfile.bloodReportLink : null;
        let bloodReportLink = userProfile ? userProfile.bloodReportLink : null;
        const uploadedFile = ui.bloodReportFile.files[0];
       
        if (!isEdit && isDonor && !uploadedFile) {
            showNotification("Please upload your latest Blood Report (PDF) to register as a Donor.", 'red');
            return;
        }
       
        if (isDonor && uploadedFile) {
            bloodReportLink = `simulated-report-link/${inputName.replace(/\s/g, '-')}-${new Date().getTime()}-${uploadedFile.name}`;
            if (isEdit) { showNotification("New report uploaded. Admin will need to re-verify.", 'blue'); }
        }

        let newStatus = 'PENDING_VERIFICATION';
        if (isEdit) {
            newStatus = uploadedFile ? 'PENDING_VERIFICATION' : userProfile.status;
        }

        const newProfile = {
            userId: userProfile ? userProfile.userId : userId,
            userRole: role,
            name: inputName,
            phone: inputPhone,
            pinCode: ui.pinCodeInput.value.trim(),
            address: ui.addressInput.value.trim(),
            updatedAt: Date.now(),
            age: ageInt,
            gender: isDonor ? ui.genderInput.value : null,
            weight: weightInt,
            bloodType: isDonor ? ui.bloodTypeInput.value : null,
            lastDonationDate: isDonor ? lastDonationDateStr : null,
            lastDonationTime: lastDonationTime,
            bloodReportLink: isDonor ? bloodReportLink : null,
            isVerified: newStatus === 'VERIFIED', 
            status: newStatus, 
            isRequestActive: isEdit ? userProfile.isRequestActive : false,
            isPendingAdminApproval: isEdit ? (uploadedFile ? false : userProfile.isPendingAdminApproval) : false,
            bloodTypeNeeded: isEdit ? userProfile.bloodTypeNeeded : '',
            requestPinCode: isEdit ? userProfile.requestPinCode : '',
            donorMatch: isEdit ? userProfile.donorMatch : null,
        };
        if (isEdit) {
             saveProfile(newProfile);
             showNotification("Profile updated successfully. Re-verification may be required.", 'green');
             showDashboard();
        } else {
             saveProfile(newProfile);
             apiRegisterProfile(newProfile);
             showNotification(`${role} registration submitted! Awaiting admin verification.`, 'green');
             showUserBlocked();
        }
    });
    document.getElementById('signup-back-to-role').addEventListener('click', showRoleSelection);
    ui.requestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const bloodTypeNeeded = document.getElementById('bloodTypeNeeded').value;
       
        const requestPinCode = userProfile.userRole === 'Hospital'
                                 ? userProfile.pinCode
                                 : document.getElementById('request-pinCode').value.trim();
       
        if (userProfile.status !== 'VERIFIED') {
             showNotification("Request cannot be submitted. Your account is not yet verified by an administrator.", 'red');
             submitBtn.disabled = false;
             submitBtn.textContent = 'Submit Request & Find Nearby Donors';
             return;
        }

        const updatedProfile = {
            ...userProfile,
            isRequestActive: true,
            isPendingAdminApproval: true,
            bloodTypeNeeded: bloodTypeNeeded,
            requestPinCode: requestPinCode,
            donorMatch: null,
            updatedAt: Date.now()
        };
        saveProfile(updatedProfile);
        userProfile = updatedProfile;

        // Sync to backend
        await apiCreateRequest({
          requesterId: updatedProfile.userId || 'guest',
          name: updatedProfile.name || updatedProfile.userRole || 'Unknown',
          phone: updatedProfile.phone || '',
          userRole: updatedProfile.userRole || 'Hospital',
          pinCode: updatedProfile.requestPinCode || requestPinCode,
          bloodTypeNeeded: updatedProfile.bloodTypeNeeded || bloodTypeNeeded
        });

        // Force a sync to ensure we have the ID back if possible, though socket usually handles it
        // We render immediately for UX
        renderDonors([], requestPinCode, bloodTypeNeeded);
        ui.noDonors.textContent = "‚ö†Ô∏è Your request is pending admin approval. Donors will be notified once approved.";
        ui.noDonors.classList.remove('hidden');

        renderMyRequests();
        ui.myRequestsSection.classList.remove('hidden');
        showNotification(`Request submitted! Awaiting Admin approval for ${bloodTypeNeeded} near Pin ${requestPinCode}.`, 'blue');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Request & Find Nearby Donors';
    });

    ui.tabRequest.addEventListener('click', () => { setActiveTab(ui.tabRequest, ui.viewRequest); });
    ui.tabDonor.addEventListener('click', () => { setActiveTab(ui.tabDonor, ui.viewDonor); });
    ui.editProfileBtn.addEventListener('click', () => showProfileSetup(true));
    ui.backToDashboardFromEditBtn.addEventListener('click', showDashboard);
    ui.deleteAccountBtn.addEventListener('click', () => deleteAccount(userId));
    ui.logoutBtn.addEventListener('click', () => {
        if (window.confirm("Are you sure you want to log out?")) {
            logoutUser();
        }
    });

    function renderPendingUsers() {
        ui.pendingUsersList.innerHTML = '';
        const allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        const pendingUsers = allUsers.filter(user => user.userRole !== 'Admin' && user.status === 'PENDING_VERIFICATION');
        ui.noPendingUsers.classList.toggle('hidden', pendingUsers.length > 0);

        pendingUsers.forEach(user => {
            const isDonor = user.userRole === 'Donor';
            const reportStatus = isDonor
                ? (user.bloodReportLink ? `<span class="text-green-600 font-bold">Report Attached</span>` : `<span class="text-red-600 font-bold">No Report Uploaded</span>`)
                : `<span class="text-blue-600 font-bold">Hospital Details Submitted</span>`;

            const verificationInfo = isDonor
                ? `Age: ${user.age}, Weight: ${user.weight}kg, Blood Type: ${user.bloodType}`
                : `Organization Pin: ${user.pinCode}`;
           
            const reportAction = isDonor && user.bloodReportLink
                ? `<a href="#" class="view-report-link text-blue-600 hover:text-blue-800 underline text-sm font-semibold" data-report-link="${user.bloodReportLink}">View Report (Simulated)</a>`
                : (isDonor ? `<span class="text-xs text-red-500">&#x26A0; No report</span>` : '');
           
            const userCard = document.createElement('div');
            userCard.className = 'bg-white p-4 rounded-lg border border-gray-200 flex justify-between items-center flex-wrap gap-2';
            userCard.innerHTML = `
                <div>
                    <div class="font-bold text-lg text-gray-800">${user.name} <span class="text-sm font-medium text-gray-500">(${user.userRole})</span></div>
                    <div class="text-sm text-gray-600">${verificationInfo}</div>
                    <div class="text-sm mt-1">${reportAction}</div>
                </div>
                <div class="flex gap-2 items-center">
                    <button class="approve-btn py-2 px-3 bg-green-100 text-green-700 rounded-full text-sm font-semibold" data-id="${user.userId}">Approve</button>
                    <button class="deny-btn py-2 px-3 bg-red-100 text-red-700 rounded-full text-sm font-semibold" data-id="${user.userId}">Deny</button>
                </div>
            `;
            ui.pendingUsersList.appendChild(userCard);
            userCard.querySelector('.approve-btn').addEventListener('click', async (ev) => {
                const uid = ev.currentTarget.dataset.id;
                // Optimistic UI update
                let all = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
                const idx = all.findIndex(x => x.userId === uid);
                if (idx > -1) {
                    all[idx].status = 'VERIFIED';
                    all[idx].isVerified = true;
                    localStorage.setItem(ALL_USERS_KEY, JSON.stringify(all));
                    renderPendingUsers();
                    renderAllUsers();
                    
                    await API.put(`/api/admin/approve-user/${uid}?adminSecret=${encodeURIComponent('hellowrld')}`, { action: 'approve' });
                    fetchAndSyncUsers();
                }
            });
            userCard.querySelector('.deny-btn').addEventListener('click', async (ev) => {
                const uid = ev.currentTarget.dataset.id;
                if (!confirm('Deny and remove this user?')) return;
                
                await API.put(`/api/admin/approve-user/${uid}?adminSecret=${encodeURIComponent('hellowrld')}`, { action: 'deny' });
                fetchAndSyncUsers();
            });
        });
    }

    function renderAllUsers() {
        ui.allUsersList.innerHTML = '';
        const allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]').filter(u => u.userRole !== 'Admin');
        ui.noUsersToManage.classList.toggle('hidden', allUsers.length > 0);
        allUsers.forEach(user => {
            const card = document.createElement('div');
            card.className = 'bg-white p-3 rounded-lg border border-gray-200 flex justify-between items-center';
            card.innerHTML = `
                <div>
                    <div class="font-bold">${user.name} <span class="text-sm text-gray-500">(${user.userRole})</span></div>
                    <div class="text-xs text-gray-600">Pin: ${user.pinCode} ‚Ä¢ Status: ${user.status}</div>
                </div>
                <div class="flex gap-2">
                    <button class="manage-delete text-sm text-red-600">Delete</button>
                </div>
            `;
            ui.allUsersList.appendChild(card);
            card.querySelector('.manage-delete').addEventListener('click', () => deleteAccount(user.userId, true));
        });
    }

    function renderPendingRequests() {
        ui.pendingRequestsList.innerHTML = '';
        const allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        const pendingRequests = allUsers.filter(u => u.isRequestActive && u.isPendingAdminApproval);
        ui.noPendingRequests.classList.toggle('hidden', pendingRequests.length > 0);
        pendingRequests.forEach(req => {
            const item = document.createElement('div');
            item.className = 'bg-white p-3 rounded-lg border border-gray-200 flex justify-between items-center';
            item.innerHTML = `
                <div>
                    <div class="font-bold text-red-600">${req.bloodTypeNeeded || 'Unknown'}</div>
                    <div class="text-sm text-gray-600">Pin: ${req.requestPinCode} ‚Ä¢ By: ${req.name}</div>
                </div>
                <div class="flex gap-2">
                    <button class="approve-request-btn py-2 px-3 bg-green-100 text-green-700 rounded-full text-sm font-semibold" data-id="${req.userId}" data-req-id="${req._requestId || ''}">Approve</button>
                    <button class="deny-request-btn py-2 px-3 bg-red-100 text-red-700 rounded-full text-sm font-semibold" data-id="${req.userId}" data-req-id="${req._requestId || ''}">Deny</button>
                </div>
            `;
            ui.pendingRequestsList.appendChild(item);

            item.querySelector('.approve-request-btn').addEventListener('click', async (ev) => {
                const userId = ev.currentTarget.dataset.id;
                const reqId = ev.currentTarget.dataset.reqId;
                
                // If we have a backend request ID, use it. Otherwise fallback to userId (simulation style)
                const targetId = reqId || userId;
                
                await API.put(`/api/admin/approve-request/${targetId}?adminSecret=${encodeURIComponent('hellowrld')}`, { action: 'approve' });
                showNotification('Request approval sent.', 'green');
                fetchAndSyncUsers();
            });
            item.querySelector('.deny-request-btn').addEventListener('click', async (ev) => {
                const userId = ev.currentTarget.dataset.id;
                const reqId = ev.currentTarget.dataset.reqId;
                const targetId = reqId || userId;
                
                await API.put(`/api/admin/approve-request/${targetId}?adminSecret=${encodeURIComponent('hellowrld')}`, { action: 'deny' });
                fetchAndSyncUsers();
            });
        });
    }

    function renderDonors(donorsArray, requestPinCode, bloodTypeNeeded) {
      try {
        const pin = requestPinCode || (userProfile && userProfile.requestPinCode) || '';
        const needed = bloodTypeNeeded || (userProfile && userProfile.bloodTypeNeeded) || '';
        let donors = Array.isArray(donorsArray) && donorsArray.length ? donorsArray : getDonorsInArea(pin, needed);

        if (pin && PIN_COORDINATES[pin]) {
          initMap(PIN_COORDINATES[pin]);
        } else {
          initMap();
        }

        if (donorMap) {
          donorMap.eachLayer(layer => {
            if (layer instanceof L.Marker) donorMap.removeLayer(layer);
          });
        }

        const listEl = document.getElementById('donors-list');
        listEl.innerHTML = '';
        if (!donors || donors.length === 0) {
          document.getElementById('no-donors').classList.remove('hidden');
          document.getElementById('matched-pin-display').textContent = pin || '...';
          return;
        }

        document.getElementById('no-donors').classList.add('hidden');
        document.getElementById('matched-pin-display').textContent = pin || '...';
        donors.forEach(d => {
          const coords = PIN_COORDINATES[d.pinCode] || [12.9716, 77.5946];
          const marker = L.marker(coords).addTo(donorMap);
          marker.bindPopup(`<b>${d.name}</b><br/>Type: ${d.bloodType || 'N/A'}<br/>Pin: ${d.pinCode}<br/>Phone: ${d.phone || 'N/A'}`);

          const card = document.createElement('div');
          card.className = 'bg-white p-4 rounded-lg border border-gray-200 flex justify-between items-center';
          card.innerHTML = `
            <div>
              <div class="font-bold">${d.name} <span class="text-sm text-gray-500">(${d.bloodType || 'N/A'})</span></div>
              <div class="text-xs text-gray-600">Pin: ${d.pinCode} ${d.age ? '‚Ä¢ ' + d.age + ' yrs' : ''}</div>
              <div class="text-xs text-gray-500">${d.status || ''}</div>
            </div>
            <div class="flex flex-col items-end">
              <a href="tel:${d.phone || ''}" class="text-sm text-blue-600 font-semibold">${d.phone ? 'Call' : ''}</a>
            </div>
          `;
          listEl.appendChild(card);
        });
      } catch (err) {
        console.error('renderDonors error', err);
        document.getElementById('donors-list').innerHTML = '';
        document.getElementById('no-donors').classList.remove('hidden');
      }
    }

    function renderDonorRequests(requestsArray, eligibility) {
      try {
        const listEl = document.getElementById('requests-list');
        listEl.innerHTML = '';
        if (!Array.isArray(requestsArray) || requestsArray.length === 0) {
          document.getElementById('no-requests').classList.remove('hidden');
          return;
        }
        document.getElementById('no-requests').classList.add('hidden');
        requestsArray.forEach(r => {
          const card = document.createElement('div');
          card.className = 'bg-white p-3 rounded-lg border border-gray-200 flex justify-between items-center';
          card.innerHTML = `
            <div>
              <div class="font-bold text-red-600">${r.bloodTypeNeeded || 'Unknown'}</div>
              <div class="text-sm text-gray-600">Pin: ${r.requestPinCode || r.pinCode || 'N/A'} ‚Ä¢ By: ${r.name || 'Unknown'}</div>
              <div class="text-xs text-gray-500">Status: ${r.status || (r.isPendingAdminApproval ? 'Pending' : 'Active')}</div>
            </div>
            <div class="flex flex-col items-end gap-2">
              ${eligibility && eligibility.eligible ? `<button class="respond-btn py-2 px-3 bg-green-100 text-green-700 rounded-full text-sm font-semibold" data-id="${r.userId || r.requesterId}">I Can Donate</button>` : `<div class="text-xs ${eligibility ? eligibility.color : 'text-gray-500'}">${eligibility ? eligibility.status : ''}</div>`}
            </div>
          `;
          listEl.appendChild(card);

          const respondBtn = card.querySelector('.respond-btn');
          if (respondBtn) {
            respondBtn.addEventListener('click', () => {
              const allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
              const idx = allUsers.findIndex(u => (u.userId === r.userId) || (u.userId === r.requesterId));
              if (idx > -1) {
                allUsers[idx].donorMatch = { donorId: userId, donorName: (userProfile && userProfile.name) || 'Anonymous', matchedAt: Date.now() };
                localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers));
                showNotification('You indicated you can donate ‚Äî admin will be notified (local).', 'green');
                API.put(`/api/notify-match/${r._id || r.requesterId}`, { donorId: userId }).catch(()=>{});
                renderDonorRequests(requestsArray, eligibility);
                renderMyRequests();
              } else {
                showNotification('Unable to record match locally.', 'red');
              }
            });
          }
        });
      } catch (err) { console.error('renderDonorRequests error', err); }
    }

    function renderMyRequests() {
      try {
        const myListEl = document.getElementById('my-requests-list');
        myListEl.innerHTML = '';
        const allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        const myRequests = allUsers.filter(u => (u.userId === userId && u.isRequestActive) || (userProfile && userProfile.userRole === 'Hospital' && u.userId === userId && u.isRequestActive));
        if (!myRequests || myRequests.length === 0) {
          document.getElementById('no-open-requests').classList.remove('hidden');
          return;
        }
        document.getElementById('no-open-requests').classList.add('hidden');
        myRequests.forEach(r => {
          const card = document.createElement('div');
          card.className = 'bg-white p-3 rounded-lg border border-gray-200 flex justify-between items-center';
          card.innerHTML = `
            <div>
              <div class="font-bold">${r.bloodTypeNeeded || r.bloodTypeNeeded || 'Unknown'} ‚Ä¢ Pin ${r.requestPinCode || r.pinCode || 'N/A'}</div>
              <div class="text-sm text-gray-600">Status: ${r.isPendingAdminApproval ? 'Pending' : (r.isRequestActive ? 'Active' : 'Closed')}</div>
            </div>
            <div class="flex gap-2">
              <button class="cancel-request text-sm text-red-600">Cancel</button>
            </div>
          `;
          myListEl.appendChild(card);

          card.querySelector('.cancel-request').addEventListener('click', () => {
            if (!confirm('Cancel this request?')) return;
            // API call to cancel (deny) the request
            API.put(`/api/admin/approve-request/${r._requestId || r.userId}?adminSecret=${encodeURIComponent('hellowrld')}`, { action: 'deny' });
            fetchAndSyncUsers();
          });
        });
      } catch (err) { console.error('renderMyRequests error', err); }
    }

    function initializeApp() {
        seedSampleData();
        loadProfile();
        if (userProfile && userProfile.userRole === 'Admin') {
            showAdminDashboard();
        } else if (userProfile && userProfile.status === 'VERIFIED') {
            showDashboard();
        } else if (userProfile && userProfile.status !== 'VERIFIED') {
             showUserBlocked();
        } else {
            showRoleSelection();
        }
        ui.lastDonationDateInput.max = new Date().toISOString().split('T')[0];
        document.querySelectorAll('#profile-form input[required], #profile-form select[required], #profile-form textarea[required]').forEach(input => {
             input.dataset.originalRequired = 'true';
        });
    }

    window.onload = initializeApp;
</script>
</body>
</html>