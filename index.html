<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blood Connect Pro (Bengaluru)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background:#f8f9fa; }
    .btn-primary { background:#e53e3e; color:white; transition: all .12s ease; }
    .btn-primary:hover { background:#c53030; transform: translateY(-1px); }
    .main-card { background:white; width:95%; max-width:1000px; box-shadow:0 10px 20px rgba(0,0,0,0.06); }
    #donorMap { height: 320px; border-radius: 0.6rem; border:2px solid #e53e3e; }
    .role-bubble-card { transition: all .18s ease; cursor:pointer; border-radius:1rem; box-shadow:0 8px 18px rgba(0,0,0,0.06); min-height:160px; }
    .donor-bubble { background:#fff1f1; border:3px solid #f87171; }
    .hospital-bubble { background:#f0f8ff; border:3px solid #60a5fa; }
    .admin-bubble { background:#f3f4f6; border:3px solid #9ca3af; }
    .hidden-for-donor { display:none !important; }
    .file-name { font-size: 0.9rem; color: #374151; }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-6 flex justify-center items-start">
    <div class="main-card rounded-2xl p-8 border-t-8 border-red-600">
      <header class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-red-700">ü©∏ Blood Connect Pro (Bengaluru)</h1>
        <p class="text-gray-600 mt-1">Local Emergency Donor Matching</p>
      </header>

      <div id="global-message-box" class="fixed inset-x-0 top-4 z-50 flex justify-center pointer-events-none">
        <div id="global-message-content" class="pointer-events-auto bg-white p-3 rounded shadow text-center"></div>
      </div>

      <!-- Role selection -->
      <div id="role-selection" class="space-y-6 text-center">
        <h2 class="text-2xl font-bold text-red-700">Select Your Role</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button data-role="Donor" class="select-role-btn role-bubble-card donor-bubble p-6">
            <div class="text-red-700 font-bold text-lg">I am a Donor</div>
            <div class="text-sm text-gray-600 mt-1">View urgent requests in your area</div>
          </button>
          <button data-role="Hospital" class="select-role-btn role-bubble-card hospital-bubble p-6">
            <div class="text-blue-700 font-bold text-lg">I am a Hospital</div>
            <div class="text-sm text-gray-600 mt-1">Create urgent blood requests</div>
          </button>
          <button id="select-admin-role-btn" class="role-bubble-card admin-bubble p-6">
            <div class="text-gray-800 font-bold text-lg">Administrator</div>
            <div class="text-sm text-gray-600 mt-1">Manage users and requests</div>
          </button>
        </div>
      </div>

      <!-- Auth selection -->
      <div id="auth-selection" class="hidden text-center space-y-4">
        <h2 class="text-2xl font-semibold">Welcome, <span id="auth-role-display"></span></h2>
        <div class="space-y-3">
          <button id="auth-login-btn" class="w-full py-3 rounded-xl btn-primary">Login</button>
          <button id="auth-register-btn" class="w-full py-3 rounded-xl border border-red-200 text-red-700">Register</button>
          <button id="auth-back-to-role" class="w-full text-sm text-gray-500">‚Üê Back</button>
        </div>
      </div>

      <!-- Login form -->
      <div id="user-login" class="hidden">
        <h3 class="text-lg font-semibold mb-3"><span id="login-role-display"></span> Login</h3>
        <form id="user-login-form" class="space-y-3">
          <input id="login-phone" placeholder="Phone (10 digits)" class="w-full p-3 border rounded" required />
          <button class="w-full py-3 rounded-xl btn-primary">Login</button>
          <button type="button" id="login-back-to-auth" class="w-full text-sm text-gray-500">‚Üê Back</button>
        </form>
      </div>

      <!-- Register / Profile -->
      <div id="profile-setup" class="hidden">
        <h3 class="text-lg font-semibold mb-3"><span id="registration-role"></span> Registration</h3>
        <form id="profile-form" class="space-y-3">
          <input type="hidden" id="userRoleHidden" value="Donor" />

          <input id="name" placeholder="Full name" class="w-full p-3 border rounded" required />
          <input id="phone" placeholder="Phone" class="w-full p-3 border rounded" required />

          <!-- Address (for both Donor & Hospital) -->
          <textarea id="address" placeholder="Full address (street/locality)" rows="2" class="w-full p-3 border rounded" required></textarea>

          <div id="donor-specific-fields" class="space-y-2">
            <!-- shown only when registering as Donor -->
            <div class="grid grid-cols-3 gap-2">
              <input id="age" type="number" placeholder="Age" class="p-3 border rounded" />
              <input id="weight" type="number" placeholder="Weight (kg)" class="p-3 border rounded" />
              <select id="gender" class="p-3 border rounded">
                <option value="">Gender</option><option>Male</option><option>Female</option><option>Other</option>
              </select>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <select id="bloodType" class="p-3 border rounded" required>
                <option value="">Blood type (required)</option>
                <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
              </select>
              <input id="pinCode" placeholder="Pin code (6 digits)" class="p-3 border rounded" required />
            </div>

            <div class="space-y-1">
              <label class="block text-sm font-medium text-gray-700">Upload medical document (PDF) ‚Äî simulated</label>
              <input type="file" id="medicalDocumentFile" accept="application/pdf" class="block w-full text-sm text-gray-500" />
              <div id="medical-file-name" class="file-name"></div>
            </div>
          </div>

          <div id="hospital-specific-fields" class="space-y-2 hidden">
            <!-- shown when registering as Hospital -->
            <div class="grid grid-cols-2 gap-2">
              <input id="hospital-pinCode" placeholder="Pin code (6 digits)" class="p-3 border rounded" required />
              <!-- Hospital has no bloodType -->
              <input id="hospital-contact-email" placeholder="Contact email (optional)" class="p-3 border rounded" />
            </div>
          </div>

          <div class="flex items-center space-x-2 p-3 bg-blue-50 rounded">
            <input type="checkbox" id="verification-check" required class="h-4 w-4 text-blue-600" />
            <label for="verification-check" class="text-sm text-blue-800">I verify the provided data is accurate.</label>
          </div>

          <button class="w-full py-3 rounded-xl btn-primary">Register</button>
          <button type="button" id="signup-back-to-role" class="w-full text-sm text-gray-500">‚Üê Back</button>
        </form>
      </div>

      <!-- Admin login -->
      <div id="admin-login" class="hidden">
        <h3 class="text-lg font-semibold mb-3">Admin Login</h3>
        <form id="admin-login-form" class="space-y-3">
          <input id="admin-pin" placeholder="Admin secret" class="w-full p-3 border rounded" />
          <button class="w-full py-3 rounded-xl btn-primary">Enter Admin</button>
          <button type="button" id="admin-back-to-role" class="w-full text-sm text-gray-500">‚Üê Back</button>
        </form>
      </div>

      <!-- Blocked (waiting verification) -->
      <div id="user-blocked" class="hidden p-4 bg-red-50 rounded">
        <h3 class="font-bold text-red-600">Account pending verification</h3>
        <p class="text-gray-600">Your account is awaiting admin approval.</p>
        <button id="blocked-logout-btn" class="mt-3 text-sm text-gray-500">Back to main</button>
      </div>

      <!-- Admin dashboard -->
      <div id="admin-dashboard" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Admin Dashboard</h3>
          <button id="admin-logout-btn" class="text-sm text-gray-600">Logout</button>
        </div>

        <div class="flex space-x-2 mb-4">
          <button id="admin-tab-users" class="py-2 px-3 border-b-2 border-blue-600 text-blue-600">Pending Users</button>
          <button id="admin-tab-management" class="py-2 px-3">All Users</button>
          <button id="admin-tab-requests" class="py-2 px-3">Pending Requests</button>
        </div>

        <div id="admin-view-users">
          <h4 class="font-semibold mb-2">Pending Users</h4>
          <div id="pending-users-list" class="space-y-2"></div>
        </div>

        <div id="admin-view-management" class="hidden">
          <h4 class="font-semibold mb-2">All Users</h4>
          <div id="all-users-list" class="space-y-2"></div>
        </div>

        <div id="admin-view-requests" class="hidden">
          <h4 class="font-semibold mb-2">Pending Requests</h4>
          <div id="pending-requests-list" class="space-y-2"></div>
        </div>
      </div>

      <!-- Main dashboard -->
      <div id="main-dashboard" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Dashboard (<span id="dashboard-role-display"></span>)</h3>
          <div class="space-x-2">
            <button id="edit-profile-btn" class="text-sm text-gray-600">Edit</button>
            <button id="logout-btn" class="text-sm text-gray-600">Logout</button>
          </div>
        </div>

        <!-- donor/hospital status -->
        <div class="bg-gray-50 p-4 rounded mb-4">
          <div class="flex justify-between">
            <div>
              <div class="text-sm text-gray-600">Status: <strong id="donor-status"></strong></div>
              <div class="text-xs text-gray-500">Pin: <code id="user-pin-display"></code> ‚Ä¢ Blood: <code id="user-blood-display"></code></div>
            </div>
          </div>
        </div>

        <!-- tabs -->
        <div class="flex space-x-2 mb-4">
          <button id="tab-request" class="hospital-only py-2 px-3 rounded text-red-600 border-b-2 border-red-600">Request Blood & Find Donors</button>
          <button id="tab-donor" class="py-2 px-3 rounded text-gray-600">Available Donor Requests</button>
        </div>

        <!-- Hospital-only request area -->
        <div id="view-request" class="hospital-only">
          <h4 class="font-semibold mb-2">Submit Urgent Blood Need</h4>
          <form id="request-form" class="space-y-3 p-4 bg-white border rounded">
            <div class="grid grid-cols-2 gap-2">
              <input id="request-pinCode" placeholder="Area pin code (where blood needed)" class="p-3 border rounded" required />
              <select id="bloodTypeNeeded" class="p-3 border rounded" required>
                <option value="">Blood Type Needed</option>
                <option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
              </select>
            </div>
            <button id="submit-request-btn" class="w-full py-3 rounded-xl btn-primary">Submit Request & Find Nearby Donors</button>
          </form>

          <div class="mt-4">
            <h5 class="font-semibold">Matching Donors Near Requested Area</h5>
            <div id="matched-pin-display" class="text-sm text-gray-600 mb-2">...</div>
            <div id="donorMap" class="mb-3"></div>
            <div id="donors-list" class="space-y-2"></div>
          </div>
        </div>

        <!-- Donor view: available requests -->
        <div id="view-donor">
          <h4 class="font-semibold mb-2">Emergency Requests Near You</h4>
          <div id="requests-list" class="space-y-2"></div>
        </div>
      </div>

      <div id="profile-management" class="hidden"></div>
    </div>
  </div>

<script>
/* ======= CONFIG ======= */
const BACKEND_URL = "https://blood-connect-api-67g9.onrender.com"; // keep your backend URL
const API_BASE = BACKEND_URL + "/api";
const ADMIN_SECRET = "999999"; // frontend admin secret (must match backend .env ADMIN_SECRET for admin API calls)

/* ======= API helpers ======= */
const API = {
  async post(path, body) {
    try {
      const res = await fetch(API_BASE + path, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const json = await res.json().catch(()=>null);
      return { ok: res.ok, status: res.status, json };
    } catch (e) { console.warn('POST error', e); return { ok:false }; }
  },
  async get(path) {
    try {
      const res = await fetch(API_BASE + path);
      const json = await res.json().catch(()=>null);
      return { ok: res.ok, status: res.status, json };
    } catch (e) { console.warn('GET error', e); return { ok:false }; }
  },
  async put(path, body) {
    try {
      const res = await fetch(API_BASE + path, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const json = await res.json().catch(()=>null);
      return { ok: res.ok, status: res.status, json };
    } catch (e) { console.warn('PUT error', e); return { ok:false }; }
  }
};

/* ======= Socket ======= */
let socket = null;
function initSocket() {
  if (!window.io) { console.warn('socket.io client missing'); return; }
  socket = io(BACKEND_URL, { transports:['websocket','polling'] });
  socket.on('connect', ()=>console.log('socket connected', socket.id));
  socket.on('newRequest', (d)=> { showNotification('New request created'); fetchAndSyncInternal(); });
  socket.on('userRegistered', (d)=> { showNotification('New user registered'); fetchAndSyncInternal(); });
  socket.on('userVerified', (d)=> { showNotification('User verification updated'); fetchAndSyncInternal(); });
  socket.on('requestApproved', (d)=> { showNotification('A request was approved'); fetchAndSyncInternal(); });
  socket.on('requestDenied', (d)=> { showNotification('A request was denied'); fetchAndSyncInternal(); });
}

/* ======= UI helpers ======= */
function showNotification(msg) {
  const box = document.getElementById('global-message-content');
  box.textContent = msg;
  box.parentElement.classList.remove('opacity-0');
  setTimeout(()=> { box.textContent = ''; }, 3500);
}
function qs(id){ return document.getElementById(id); }
function createElem(tag, className){ const e = document.createElement(tag); if(className) e.className = className; return e; }

/* ======= App state ======= */
const USER_KEY = 'blood_connect_user_profile';
let userProfile = null;

/* ======= PIN -> coordinates mapping (static for Bengaluru example) ======= */
const PIN_COORDINATES = {
  '560078': [12.903, 77.580], // JP Nagar
  '560076': [12.923, 77.585], // Jayanagar
  '560041': [12.915, 77.603], // BTM
  '560066': [12.978, 77.753], // Whitefield
  '560001': [12.980, 77.595], // CBD
  '560037': [12.985, 77.700],
  '560083': [12.890, 77.570]
};

/* ======= UI refs & initial wiring ======= */
const roleButtons = Array.from(document.querySelectorAll('.select-role-btn'));
const authSelection = qs('auth-selection');
const roleSelection = qs('role-selection');
const loginBox = qs('user-login');
const registerBox = qs('profile-setup');
const adminLoginBox = qs('admin-login');
const mainDashboard = qs('main-dashboard');
const adminDashboard = qs('admin-dashboard');
const donorView = qs('view-donor');
const requestView = qs('view-request');
const tabRequestBtn = qs('tab-request');
const tabDonorBtn = qs('tab-donor');
const requestForm = qs('request-form');

let currentSelectedRole = null;
roleButtons.forEach(btn => btn.addEventListener('click', () => {
  const role = btn.getAttribute('data-role') || (btn.id === 'select-admin-role-btn' ? 'Admin' : null);
  currentSelectedRole = role;
  qs('auth-role-display').textContent = role;
  roleSelection.classList.add('hidden');
  authSelection.classList.remove('hidden');

  // When Admin chosen, show admin-login instead of generic auth-selection
  if (role === 'Admin') {
    authSelection.classList.add('hidden');
    adminLoginBox.classList.remove('hidden');
  }
}));

qs('auth-back-to-role').addEventListener('click', ()=> {
  authSelection.classList.add('hidden');
  roleSelection.classList.remove('hidden');
});

/* Show login/register flows */
qs('auth-login-btn').addEventListener('click', ()=> {
  authSelection.classList.add('hidden');
  loginBox.classList.remove('hidden');
  qs('login-role-display').textContent = currentSelectedRole || 'User';
});
qs('auth-register-btn').addEventListener('click', ()=> {
  authSelection.classList.add('hidden');
  registerBox.classList.remove('hidden');
  qs('registration-role').textContent = currentSelectedRole || 'New User';
  qs('userRoleHidden').value = currentSelectedRole || 'Donor';
  toggleRegistrationFields(currentSelectedRole || 'Donor');
});
qs('login-back-to-auth').addEventListener('click', ()=> { loginBox.classList.add('hidden'); authSelection.classList.remove('hidden'); });
qs('signup-back-to-role').addEventListener('click', ()=> { registerBox.classList.add('hidden'); roleSelection.classList.remove('hidden'); });
qs('admin-back-to-role').addEventListener('click', ()=> { adminLoginBox.classList.add('hidden'); roleSelection.classList.remove('hidden'); });

/* Toggle registration fields depending on role */
function toggleRegistrationFields(role) {
  const donorFields = qs('donor-specific-fields');
  const hospitalFields = qs('hospital-specific-fields');

  if (role === "Hospital") {
    donorFields.classList.add("hidden");
    hospitalFields.classList.remove("hidden");
    qs("userRoleHidden").value = "Hospital";

    // Remove donor required fields
    qs("bloodType").removeAttribute("required");
    qs("pinCode").removeAttribute("required");

    // Add hospital required fields
    qs("hospital-pinCode").setAttribute("required", "true");

  } else {
    donorFields.classList.remove("hidden");
    hospitalFields.classList.add("hidden");
    qs("userRoleHidden").value = "Donor";

    // Add donor required fields
    qs("bloodType").setAttribute("required", "true");
    qs("pinCode").setAttribute("required", "true");

    // Remove hospital required fields
    qs("hospital-pinCode").removeAttribute("required");
  }
}



/* Upload medical document (simulated): show filename */
qs('medicalDocumentFile').addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (f) qs('medical-file-name').textContent = f.name;
  else qs('medical-file-name').textContent = '';
});

/* Login form submit (calls backend /api/auth/login) */
qs('user-login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const phone = qs('login-phone').value.trim();
  // call backend login
  const res = await API.post('/auth/login', { phone });
  if (!res.ok) {
    showNotification('Login failed: ' + (res.json?.error || res.status));
    return;
  }
  const user = res.json.user;
  // CHECK verification status: must be VERIFIED
  if (!user || user.status !== 'VERIFIED') {
    showNotification('Account not verified yet. Await admin approval.');
    // Optionally show blocked UI
    qs('user-blocked').classList.remove('hidden');
    return;
  }
  userProfile = user;
  localStorage.setItem(USER_KEY, JSON.stringify(userProfile));
  enterDashboard();
});

/* Register form submit (calls backend /api/auth/register) */
qs('profile-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const role = qs('userRoleHidden').value || 'Donor';
  // build payload according to role requirements
  const base = {
    userId: crypto.randomUUID(),
    name: qs('name').value.trim(),
    phone: qs('phone').value.trim(),
    userRole: role,
    address: qs('address').value.trim()
  };

  if (role === 'Donor') {
    // require certain fields for donor
    const age = parseInt(qs('age').value || '') || null;
    const weight = parseFloat(qs('weight').value || '') || null;
    const pinCode = (qs('pinCode').value || '').toString();
    const bloodType = qs('bloodType').value || null;
    // AGE & WEIGHT VALIDATION
if (!age || age < 18 || age > 65) {
  showNotification("Donor age must be between 18 and 65.");
  return;
}

if (!weight || weight < 50) {
  showNotification("Donor weight must be at least 50 kg.");
  return;
}

    if (!pinCode || !bloodType) {
      showNotification('Donor registration requires pin code and blood type.');
      return;
    }
    // medical document (simulate by sending filename)
    const fileInput = qs('medicalDocumentFile');
    let fileName = null;
    if (fileInput && fileInput.files && fileInput.files[0]) fileName = fileInput.files[0].name;
    const payload = Object.assign({}, base, {
      age, weight,
      pinCode,
      bloodType,
      gender: qs('gender').value || null,
      bloodReportLink: fileName || null,
      status: 'PENDING_VERIFICATION' // server also sets default; explicit here ensures pending
    });
    const res = await API.post('/auth/register', payload);
    if (!res.ok) { showNotification('Register failed: ' + (res.json?.error || res.status)); return; }
    showNotification('Registered ‚Äî awaiting admin approval.');
    // don't auto-login; admin must verify
    registerBox.classList.add('hidden');
    qs('user-blocked').classList.remove('hidden');
    return;
  } else if (role === 'Hospital') {
    // hospital fields: pinCode included, no bloodType
    const pinCode = (qs('hospital-pinCode').value || '').toString();
    if (!pinCode) { showNotification('Hospital registration requires pin code.'); return; }
    const payload = Object.assign({}, base, {
      pinCode,
      // hospitals do not upload docs here
      status: 'PENDING_VERIFICATION'
    });
    const res = await API.post('/auth/register', payload);
    if (!res.ok) { showNotification('Register failed: ' + (res.json?.error || res.status)); return; }
    showNotification('Hospital registered ‚Äî awaiting admin approval.');
    registerBox.classList.add('hidden');
    qs('user-blocked').classList.remove('hidden');
    return;
  } else {
    showNotification('Unknown role');
    return;
  }
});

/* Admin login (front-end UI gating). On enter, open admin dashboard if pin matches frontend ADMIN_SECRET */
qs('admin-login-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const pin = qs('admin-pin').value.trim();
  if (pin === ADMIN_SECRET) {
    // show admin UI
    roleSelection.classList.add('hidden');
    adminLoginBox.classList.add('hidden');
    adminDashboard.classList.remove('hidden');
    fetchAndRenderAdmin();
  } else {
    showNotification('Invalid admin key');
  }
});

/* Enter dashboard after login/registration */
function enterDashboard() {
  initSocket();
  authSelection.classList.add('hidden');
  loginBox.classList.add('hidden');
  registerBox.classList.add('hidden');
  qs('user-blocked').classList.add('hidden');
  adminDashboard.classList.add('hidden');
  mainDashboard.classList.remove('hidden');
  qs('dashboard-role-display').textContent = userProfile.userRole;
  qs('user-pin-display').textContent = userProfile.pinCode || (userProfile.requestPinCode || '');
  qs('user-blood-display').textContent = userProfile.bloodType || '';
  qs('donor-status').textContent = userProfile.status || '';

  // Apply hospital-only visibility rules:
  if (userProfile.userRole === 'Donor') {
    document.querySelectorAll('.hospital-only').forEach(el => el.classList.add('hidden-for-donor'));
    tabDonorBtn.classList.add('border-b-2','border-red-600');
    tabRequestBtn.classList.add('hidden-for-donor');
    donorView.classList.remove('hidden');
    requestView.classList.add('hidden');
  } else if (userProfile.userRole === 'Hospital') {
    document.querySelectorAll('.hospital-only').forEach(el => el.classList.remove('hidden-for-donor'));
    tabRequestBtn.classList.remove('hidden-for-donor');
    requestView.classList.remove('hidden');
    donorView.classList.remove('hidden');
  } else if (userProfile.userRole === 'Admin') {
    mainDashboard.classList.add('hidden');
    adminDashboard.classList.remove('hidden');
  }

  fetchAndSyncInternal();
}

/* Logout */
qs('logout-btn').addEventListener('click', ()=> {
  userProfile = null;
  localStorage.removeItem(USER_KEY);
  mainDashboard.classList.add('hidden');
  roleSelection.classList.remove('hidden');
  document.querySelectorAll('.hospital-only').forEach(el => el.classList.add('hidden-for-donor'));
});

/* Blocked logout */
qs('blocked-logout-btn').addEventListener('click', ()=> {
  qs('user-blocked').classList.add('hidden');
  roleSelection.classList.remove('hidden');
});

/* Tab switching */
tabRequestBtn.addEventListener('click', ()=> {
  if (tabRequestBtn.classList.contains('hidden-for-donor')) return;
  requestView.classList.remove('hidden');
  donorView.classList.add('hidden');
  tabRequestBtn.classList.add('border-b-2','border-red-600');
  tabDonorBtn.classList.remove('border-b-2','border-red-600');
});
tabDonorBtn.addEventListener('click', ()=> {
  donorView.classList.remove('hidden');
  requestView.classList.add('hidden');
  tabDonorBtn.classList.add('border-b-2','border-red-600');
  tabRequestBtn.classList.remove('border-b-2','border-red-600');
});

/* ----- Submit request (HOSPITAL only) ----- */
qs('request-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!userProfile || userProfile.userRole !== 'Hospital') {
    showNotification('Only hospitals can submit requests.');
    return;
  }
  const payload = {
    requesterId: userProfile.userId,
    name: userProfile.name,
    phone: userProfile.phone,
    userRole: 'Hospital', // backend requires Hospital
    pinCode: (qs('request-pinCode').value || '').toString(),
    bloodTypeNeeded: qs('bloodTypeNeeded').value,
    createdAt: new Date().toISOString()
  };
  const res = await API.post('/request', payload); // POST /api/request
  if (!res.ok) {
    showNotification('Request failed: ' + (res.json?.error || res.status));
    return;
  }
  showNotification('Request submitted successfully.');
  if (socket) socket.emit('newRequest', res.json.request);
  qs('request-form').reset();
  fetchAndSyncInternal();
});

/* ======= Data fetching & rendering ======= */
async function fetchAndSyncInternal() {
  const res = await API.get('/sync-storage');
  if (!res.ok) { showNotification('Sync failed'); return; }
  const users = res.json.users || [];
  const requests = res.json.requests || [];
  renderRequests(requests);
  renderAdminLists(users, requests);
  renderDonorMarkers(users);
}

/* Render requests for donors/hospitals */
function renderRequests(requests) {
  const list = qs('requests-list');
  list.innerHTML = '';
  if (!requests || requests.length === 0) {
    const p = createElem('div','p-3 bg-green-50 rounded text-gray-600'); p.textContent = 'No active matching requests at the moment.';
    list.appendChild(p);
    return;
  }
  // For donors: filter requests by their pin (if available)
  let filtered = requests;
  if (userProfile && userProfile.userRole === 'Donor' && userProfile.pinCode) {
    filtered = requests.filter(r => r.pinCode === userProfile.pinCode && (r.status === 'PENDING' || !r.status));
  }
  if (filtered.length === 0) {
    const p = createElem('div','p-3 bg-green-50 rounded text-gray-600'); p.textContent = 'No active requests in your area.';
    list.appendChild(p);
    return;
  }
  filtered.forEach(r => {
    const card = createElem('div','p-3 bg-white rounded shadow border');
    card.innerHTML = `<div class="flex justify-between items-start">
      <div>
        <div class="text-sm text-gray-500">Requested by: <strong>${escapeHTML(r.name || r.requesterName || 'Hospital')}</strong></div>
        <div class="text-lg font-semibold">${escapeHTML(r.bloodTypeNeeded || r.bloodType)} ‚Ä¢ Pin ${escapeHTML(r.pinCode)}</div>
        <div class="text-xs text-gray-500">Status: ${(r.status || 'PENDING')}</div>
      </div>
    </div>`;
        // HOSPITAL: show close button for own requests
    if (userProfile && userProfile.userRole === "Hospital" && userProfile.userId === r.requesterId) {
      const closeBtn = document.createElement("button");
      closeBtn.className = "mt-2 px-3 py-1 bg-red-600 text-white rounded text-sm";
      closeBtn.textContent = "Close Request";
      closeBtn.addEventListener("click", () => closeRequest(r._id));
      card.appendChild(closeBtn);
    }

    // DONOR: show call hospital button
    if (userProfile && userProfile.userRole === "Donor") {
      const callBtn = document.createElement("button");
      callBtn.className = "mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm";
      callBtn.textContent = "Call Hospital";
      callBtn.addEventListener("click", () => {
        simulateCall(r.name || r.requesterName || "Hospital", r.phone);
      });
      card.appendChild(callBtn);
    }
    list.appendChild(card);
  });
}

/* ======= Map: Group donors by pin and show one marker per pin ======= */
let leafletMap = null;
let leafletMarkers = [];
function initMap() {
  try {
    leafletMap = L.map('donorMap', { attributionControl: false }).setView([12.97,77.59], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(leafletMap);
  } catch (e) { console.warn('Leaflet init error', e); }
}
function clearMarkers() {
  leafletMarkers.forEach(m => leafletMap.removeLayer(m));
  leafletMarkers = [];
}
function renderDonorMarkers(users) {
  if (!leafletMap) initMap();
  clearMarkers();
  if (!users || users.length === 0) {
    // nothing to show
    return;
  }
  // only donors who are VERIFIED
  const donors = (users || []).filter(u => u.userRole === 'Donor' && u.status === 'VERIFIED' && u.pinCode);
  // group by pin
  const byPin = donors.reduce((acc, d) => {
    acc[d.pinCode] = acc[d.pinCode] || [];
    acc[d.pinCode].push(d);
    return acc;
  }, {});
  Object.keys(byPin).forEach(pin => {
    const group = byPin[pin];
    const coords = PIN_COORDINATES[pin];
    if (!coords) return; // skip pins we don't have coords for
    const marker = L.marker(coords).addTo(leafletMap);
    const popupHtml = `<div><strong>Pin ${escapeHTML(pin)}</strong><br/>Donors: ${group.length}<ul style="margin-top:8px;padding-left:16px">${group.map(d => `<li>${escapeHTML(d.name)} ‚Ä¢ ${escapeHTML(d.bloodType || '')} ‚Ä¢ ${escapeHTML(d.phone || '')}</li>`).join('')}</ul></div>`;
    marker.bindPopup(popupHtml);
    leafletMarkers.push(marker);
  });
}

/* Render donors list for a given pin & bloodType (used after hospital requests) */
async function renderDonorsFor(pin, bloodType) {
  const donorsList = qs('donors-list');
  donorsList.innerHTML = '';
  if (!pin || !bloodType) {
    donorsList.appendChild(createElem('div','p-3 text-gray-600 bg-yellow-50 rounded') ).textContent = 'Provide pin and blood type to find donors.';
    return;
  }
  // GET /api/donors?pin=560078&bloodType=A+
  const res = await API.get(`/donors?pin=${encodeURIComponent(pin)}&bloodType=${encodeURIComponent(bloodType)}`);
  if (!res.ok) {
    donorsList.appendChild(createElem('div','p-3 text-gray-600 bg-red-50 rounded')).textContent = 'Failed to fetch donors.';
    return;
  }
  const donors = res.json.donors || [];
  if (donors.length === 0) {
    donorsList.appendChild(createElem('div','p-3 text-gray-600 bg-yellow-50 rounded')).textContent = 'No verified donors found for this pin & blood type.';
    return;
  }
  donors.forEach(d => {
    const card = createElem('div','p-3 bg-white rounded shadow border flex justify-between');
    card.innerHTML = `<div>
      <div class="font-semibold">${escapeHTML(d.name || 'Donor')}</div>
      <div class="text-xs text-gray-500">${escapeHTML(d.bloodType || '')} ‚Ä¢ Pin ${escapeHTML(d.pinCode || '')}</div>
      <div class="text-xs text-gray-500 mt-1">Phone: ${escapeHTML(d.phone || '‚Äî')}</div>
    </div>`;
    donorsList.appendChild(card);
  });
  qs('matched-pin-display').textContent = pin;
}

/* Admin rendering helpers */
function renderAdminLists(users, requests) {
  // Pending users
  const pendingUsersList = qs('pending-users-list'); pendingUsersList.innerHTML = '';
  (users || []).filter(u => u.status === 'PENDING_VERIFICATION').forEach(u => {
    const card = createElem('div','p-3 bg-white rounded border flex justify-between items-center');
    card.innerHTML = `<div>
      <div class="font-semibold">${escapeHTML(u.name)}</div>
      <div class="text-xs text-gray-500">Phone: ${escapeHTML(u.phone || '')} ‚Ä¢ Role: ${escapeHTML(u.userRole)}</div>
    </div>`;
    const btns = createElem('div','flex space-x-2');
    const approveBtn = createElem('button','px-3 py-1 rounded bg-green-600 text-white text-sm'); approveBtn.textContent='Approve';
    approveBtn.addEventListener('click', ()=> adminApproveUser(u.userId));
    btns.appendChild(approveBtn);
    card.appendChild(btns);
    pendingUsersList.appendChild(card);
  });

  // All users
  const allUsersList = qs('all-users-list'); allUsersList.innerHTML = '';
  (users || []).forEach(u => {
    const card = createElem('div','p-3 bg-white rounded border');
    card.innerHTML = `<div class="font-semibold">${escapeHTML(u.name)} <span class="text-xs text-gray-500">(${escapeHTML(u.userRole)})</span></div>
      <div class="text-xs text-gray-500">Phone: ${escapeHTML(u.phone || '')} ‚Ä¢ Pin: ${escapeHTML(u.pinCode || '')} ‚Ä¢ Status: ${escapeHTML(u.status || '')}</div>`;
    allUsersList.appendChild(card);
  });

  // Pending requests
  const pendingReqsList = qs('pending-requests-list'); pendingReqsList.innerHTML = '';
  (requests || []).filter(r => (r.status === 'PENDING' || !r.status)).forEach(r => {
    const card = createElem('div','p-3 bg-white rounded border flex justify-between items-center');
    card.innerHTML = `<div>
      <div class="font-semibold">${escapeHTML(r.bloodTypeNeeded || r.bloodType)} ‚Ä¢ Pin ${escapeHTML(r.pinCode)}</div>
      <div class="text-xs text-gray-500">By: ${escapeHTML(r.name || r.requesterName || 'Hospital')}</div>
    </div>`;
    const btns = createElem('div','flex space-x-2');
    const approveBtn = createElem('button','px-3 py-1 rounded bg-green-600 text-white text-sm'); approveBtn.textContent='Approve';
    approveBtn.addEventListener('click', ()=> adminApproveRequest(r._id, 'approve'));
    const denyBtn = createElem('button','px-3 py-1 rounded bg-red-600 text-white text-sm'); denyBtn.textContent='Deny';
    denyBtn.addEventListener('click', ()=> adminApproveRequest(r._id, 'deny'));
    btns.appendChild(approveBtn); btns.appendChild(denyBtn);
    card.appendChild(btns);
    pendingReqsList.appendChild(card);
  });
}

/* Admin actions (call backend admin routes with adminSecret query param) */
async function adminApproveUser(userId) {
  const res = await API.put(`/admin/approve-user/${encodeURIComponent(userId)}?adminSecret=${encodeURIComponent(ADMIN_SECRET)}`, {});
  if (!res.ok) { showNotification('Approve user failed: ' + (res.json?.error || res.status)); return; }
  showNotification('User approved');
  fetchAndSyncInternal();
}
async function adminApproveRequest(requestId, action) {
  const res = await API.put(`/admin/approve-request/${encodeURIComponent(requestId)}?adminSecret=${encodeURIComponent(ADMIN_SECRET)}`, { action });
  if (!res.ok) { showNotification('Action failed: ' + (res.json?.error || res.status)); return; }
  showNotification('Action completed');
  fetchAndSyncInternal();
}
async function closeRequest(requestId) {
  const confirmClose = confirm("Are you sure you want to close this request?");
  if (!confirmClose) return;

  const res = await API.put(`/request/close/${encodeURIComponent(requestId)}`, {
    requesterId: userProfile.userId
  });

  if (!res.ok) {
    showNotification("Failed to close request.");
    return;
  }

  showNotification("Request closed successfully.");
  fetchAndSyncInternal();
}

async function fetchAndRenderAdmin() {
  // fetch pending via admin protected endpoint
  const usersRes = await API.get(`/admin/pending-users?adminSecret=${encodeURIComponent(ADMIN_SECRET)}`);
  if (usersRes.ok) {
    const users = usersRes.json.users || [];
    renderAdminLists(users, []);
  } else {
    showNotification('Could not load admin lists');
  }
}
function simulateCall(name, phone) {
  alert(`üìû Simulating call to ${name} (${phone})...`);
}


/* Utility: escape text for DOM insertion */
function escapeHTML(s) {
  if (!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ======= Initial load: check saved user profile & init map ======= */
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem(USER_KEY);
  if (saved) {
    try { userProfile = JSON.parse(saved); } catch(e){ userProfile=null; }
  }
  if (userProfile) enterDashboard();
  else {
    qs('loading-state')?.classList?.add('hidden');
    roleSelection.classList.remove('hidden');
  }
  initMap();
  initSocket();
  // ensure admin role button opens admin login
  const adminBtn = document.getElementById('select-admin-role-btn');
  if (adminBtn) {
    adminBtn.addEventListener('click', () => {
      currentSelectedRole = 'Admin';
      roleSelection.classList.add('hidden');
      adminLoginBox.classList.remove('hidden');
    });
  }
});

/* ---------- helpers to trigger donor search on hospital submit ---------- */
qs('submit-request-btn')?.addEventListener('click', (ev)=> {
  // allow form submit to run first, then fetch donors for given pin/type
  setTimeout(()=> {
    const pin = qs('request-pinCode').value.trim();
    const btype = qs('bloodTypeNeeded').value;
    if (pin && btype) renderDonorsFor(pin, btype);
  }, 200);
});

/* Expose fetch for debugging */
window.fetchAndSync = fetchAndSyncInternal;
window.renderDonorsFor = renderDonorsFor;
</script>
</body>
</html>
