<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Connect Pro (Bengaluru Area Donor Matching)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
   
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js" integrity="" crossorigin="anonymous"></script>
   
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .btn-primary { background-color: #e53e3e; transition: background-color 0.15s ease, transform 0.1s ease; }
        .btn-primary:hover { background-color: #c53030; transform: translateY(-1px); }
        .main-card { background-color: #ffffff; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        /* Map styling to ensure it renders correctly */
        #donorMap { height: 350px; } 
    </style>
</head>
<body>

    <div id="global-message-box" class="fixed top-0 inset-x-0 transition-all duration-500 ease-out z-50 transform -translate-y-full opacity-0">
        <div id="global-message-content" class="p-3 rounded-lg shadow-xl text-center font-medium max-w-lg mx-auto"></div>
    </div>
    
    <div class="min-h-screen flex items-start justify-center p-4">
        <div class="w-full max-w-4xl pt-10">

            <header class="text-center mb-10">
                <h1 class="text-4xl font-extrabold text-red-600 tracking-tight">ü©∏ Blood Connect Pro</h1>
                <p class="mt-2 text-lg text-gray-500">Bengaluru Area Donor Matching System</p>
            </header>

            <div id="loading-state" class="main-card p-6 rounded-xl text-center">
                <p class="text-gray-600">Loading application...</p>
            </div>

            <div id="role-selection" class="main-card p-8 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Choose Your Role</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button data-role="Donor" class="role-select-btn p-6 rounded-xl border-2 border-red-300 text-red-700 hover:bg-red-50 transition duration-150">
                        <h3 class="text-xl font-bold">Donor</h3>
                        <p class="text-sm mt-1">Ready to donate blood.</p>
                    </button>
                    <button data-role="Hospital" class="role-select-btn p-6 rounded-xl border-2 border-blue-300 text-blue-700 hover:bg-blue-50 transition duration-150">
                        <h3 class="text-xl font-bold">Hospital</h3>
                        <p class="text-sm mt-1">Submit urgent blood requests.</p>
                    </button>
                    <button data-role="Admin" class="role-select-btn p-6 rounded-xl border-2 border-gray-400 text-gray-700 hover:bg-gray-100 transition duration-150">
                        <h3 class="text-xl font-bold">Admin</h3>
                        <p class="text-sm mt-1">Verify users and approve requests.</p>
                    </button>
                </div>
            </div>

            <div id="auth-selection" class="main-card p-8 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800"><span id="auth-role-display" class="font-extrabold text-red-600"></span> Access</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button data-action="login" class="action-select-btn p-4 rounded-xl btn-primary text-white text-lg font-semibold">Login (Existing User)</button>
                    <button data-action="register" class="action-select-btn p-4 rounded-xl bg-gray-200 text-gray-800 text-lg font-semibold hover:bg-gray-300 transition duration-150">Register (New User)</button>
                </div>
            </div>

            <div id="user-login" class="main-card p-8 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800"><span id="login-role-display" class="font-extrabold text-red-600"></span> Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="login-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm p-2" placeholder="e.g. 9876543210" required>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white btn-primary">Login</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    <button id="back-to-auth-select-login" class="text-blue-500 hover:text-blue-700">‚Üê Back to Role Selection</button>
                </p>
            </div>

            <div id="admin-login" class="main-card p-8 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Admin Login</h2>
                <form id="admin-login-form" class="space-y-4">
                    <div>
                        <label for="admin-secret" class="block text-sm font-medium text-gray-700">Admin Secret</label>
                        <input type="password" id="admin-secret" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm p-2" required>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white btn-primary">Login</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    <button id="back-to-auth-select-admin" class="text-blue-500 hover:text-blue-700">‚Üê Back to Role Selection</button>
                </p>
            </div>

            <div id="profile-setup" class="main-card p-8 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Complete Your Profile</h2>
                <form id="profile-form" class="space-y-4">
                    <input type="hidden" id="role-input">
                    <p class="text-sm text-gray-600 text-center">Your account is created. Please fill in these details to continue.</p>
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Name / Hospital Name</label>
                        <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2" required>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number (Registered)</label>
                        <input type="tel" id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2" required readonly>
                    </div>
                    <div>
                        <label for="pinCode" class="block text-sm font-medium text-gray-700">Pin Code (Bengaluru Area)</label>
                        <input type="text" id="pinCode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2" placeholder="e.g. 560001" required>
                    </div>

                    <div id="donor-fields" class="space-y-4">
                        <div>
                            <label for="bloodType" class="block text-sm font-medium text-gray-700">Blood Type</label>
                            <select id="bloodType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md" required>
                                <option value="">Select Blood Type</option>
                                <option value="O+">O+</option><option value="O-">O-</option>
                                <option value="A+">A+</option><option value="A-">A-</option>
                                <option value="B+">B+</option><option value="B-">B-</option>
                                <option value="AB+">AB+</option><option value="AB-">AB-</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                                <input type="number" id="age" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2" min="18" max="65" required>
                            </div>
                            <div>
                                <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                                <input type="number" id="weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2" min="50" required>
                            </div>
                        </div>
                        <div>
                            <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                            <select id="gender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="lastDonationDate" class="block text-sm font-medium text-gray-700">Last Donation Date</label>
                            <input type="date" id="lastDonationDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2">
                        </div>
                    </div>
                    
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">Full Address</label>
                        <textarea id="address" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2" required></textarea>
                    </div>

                    <button type="submit" class="w-full py-3 px-4 rounded-xl shadow-md text-base font-bold text-white btn-primary">Complete Setup & Register</button>
                </form>
            </div>
            
            <div id="user-blocked" class="main-card p-8 rounded-xl hidden text-center">
                <h2 class="text-2xl font-bold mb-4 text-red-600">Verification Pending</h2>
                <p class="text-gray-700 mb-6">Your profile has been submitted and is currently **PENDING_VERIFICATION** by an administrator.</p>
                <p class="text-gray-500 text-sm">You will be able to access the dashboard once approved. Thank you for your patience!</p>
                <button id="logout-blocked" class="mt-6 py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-gray-500 hover:bg-gray-600 transition">Logout</button>
            </div>

            <div id="main-dashboard" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="dashboard-title" class="text-3xl font-bold text-gray-800">Dashboard</h2>
                    <button id="logout-dashboard" class="py-1 px-3 rounded-full text-xs font-medium text-white bg-red-500 hover:bg-red-600 transition">Logout</button>
                </div>
                
                <div class="flex border-b border-red-300 mb-6">
                    <button id="view-request-tab" class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-red-600 hover:text-red-800 transition">
                        Submit/My Requests
                    </button>
                    <button id="view-donor-tab" class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-red-600 hover:text-red-800 transition">
                        Find Matching Requests
                    </button>
                </div>

                <div id="view-request" class="hidden">
                    <div id="hospital-request-section">
                        <form id="request-form" class="space-y-4 mb-8 p-6 main-card rounded-xl">
                            <h3 class="text-xl font-bold mb-4 text-blue-700">Submit an Urgent Blood Request</h3>
                            
                            <label for="bloodTypeNeeded" class="block text-sm font-medium text-gray-700">Blood Type Needed (Select)</label>
                            <select id="bloodTypeNeeded" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md" required>
                                <option value="">Select Blood Type</option>
                                <option value="O+">O+</option><option value="O-">O-</option>
                                <option value="A+">A+</option><option value="A-">A-</option>
                                <option value="B+">B+</option><option value="B-">B-</option>
                                <option value="AB+">AB+</option><option value="AB-">AB-</option>
                            </select>

                            <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-xl shadow-md text-base font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300">Submit Request & Find Nearby Donors</button>
                        </form>
                    </div>

                    <div class="mt-8 pt-4 border-t border-gray-300">
                        <h4 class="text-lg font-bold mb-4 text-red-700">My Active Requests</h4>
                        <div id="my-requests-list" class="space-y-4">
                            <p class="text-gray-500 text-center p-6 bg-red-50 rounded-lg border border-red-200">Loading requests...</p>
                        </div>
                    </div>
                </div>

                <div id="view-donor" class="hidden">
                    <h3 class="text-2xl font-bold mb-6 text-red-700">Nearby Blood Requests Matching Your Type</h3>
                    
                    <div class="mt-4 pt-4 border-t border-gray-300"> 
                        <h4 class="text-lg font-bold mb-4 text-blue-700">Matching Hospitals Near Your Area (<span id="matched-pin-display">...</span>)</h4> 
                        <div id="donorMap" class="h-64 rounded-lg shadow-inner mb-4"></div> 
                        <div id="donors-list" class="space-y-4"> 
                            <p id="no-donors" class="text-gray-500 text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200">üîç Thank you for your readiness. Checking for compatible requests...</p> 
                        </div> 
                    </div>
                </div>
            </div>

            <div id="admin-dashboard" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
                    <button id="logout-admin" class="py-1 px-3 rounded-full text-xs font-medium text-white bg-red-500 hover:bg-red-600 transition">Logout</button>
                </div>

                <div class="flex border-b border-red-300 mb-6">
                    <button id="admin-tab-users" class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-red-600 hover:text-red-800 transition">
                        Pending Users
                    </button>
                    <button id="admin-tab-requests" class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-red-600 hover:text-red-800 transition">
                        Pending Requests
                    </button>
                    <button id="admin-tab-management" class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-red-600 hover:text-red-800 transition">
                        All Users/Management
                    </button>
                </div>

                <div id="admin-view-users" class="hidden">
                    <h4 class="text-xl font-bold mb-4 text-red-700">Users Pending Verification</h4>
                    <div id="pending-users-list" class="space-y-4">
                        <p class="text-gray-500 text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200">Loading pending users...</p>
                    </div>
                </div>

                <div id="admin-view-requests" class="hidden">
                    <h4 class="text-xl font-bold mb-4 text-red-700">Requests Pending Approval</h4>
                    <div id="pending-requests-list" class="space-y-4">
                        <p class="text-gray-500 text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200">Loading pending requests...</p>
                    </div>
                </div>

                <div id="admin-view-management" class="hidden">
                    <h4 class="text-xl font-bold mb-4 text-red-700">All Registered Users</h4>
                    <div id="all-users-list" class="space-y-4">
                        <p class="text-gray-500 text-center p-6 bg-blue-50 rounded-lg border border-blue-200">Loading all users...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
<script>
    // FIX: Use the correct Render URL
    const BACKEND_URL = 'https://blood-connect-backend.onrender.com'; 

    // --- UTILITIES ---

    const PIN_COORDINATES = {
        '560001': [12.9781, 77.6009], '560002': [12.9772, 77.5855], '560003': [12.9902, 77.5861],
        '560004': [12.9698, 77.5750], '560005': [12.9723, 77.5645], '560006': [12.9461, 77.5925],
        '560007': [12.9272, 77.6271], '560008': [13.0041, 77.5757], '560009': [12.9472, 77.6256],
        '560010': [12.9352, 77.5332], '560011': [12.9760, 77.6436], '560012': [13.0118, 77.5694],
        '560013': [12.9438, 77.5857], '560014': [12.9554, 77.5644], '560015': [12.9866, 77.5524],
        '560016': [12.9813, 77.5248], '560017': [13.0039, 77.6186], '560018': [12.9823, 77.5670],
        '560019': [12.9806, 77.5956], '560020': [12.9698, 77.6366]
    };

    const getNearbyPins = (pin) => {
        const nearby = [pin];
        const index = Object.keys(PIN_COORDINATES).indexOf(pin);
        // Simplistic nearby pins: previous and next in the list
        if (index > 0) nearby.push(Object.keys(PIN_COORDINATES)[index - 1]);
        if (index < Object.keys(PIN_COORDINATES).length - 1) nearby.push(Object.keys(PIN_COORDINATES)[index + 1]);
        return nearby;
    };

    // Blood type compatibility: determines if donorType can satisfy neededType
    const isCompatible = (donorType, neededType) => {
        const compatibility = {
            'O-': ['O-', 'O+', 'A-', 'A+', 'B-', 'B+', 'AB-', 'AB+'], 
            'O+': ['O+', 'A+', 'B+', 'AB+'],
            'A-': ['A-', 'A+', 'AB-', 'AB+'],
            'A+': ['A+', 'AB+'],
            'B-': ['B-', 'B+', 'AB-', 'AB+'],
            'B+': ['B+', 'AB+'],
            'AB-': ['AB-', 'AB+'],
            'AB+': ['AB+'],
        };
        
        const sanitizedDonorType = (donorType || '').toUpperCase();
        const sanitizedNeededType = (neededType || '').toUpperCase();

        if (!compatibility[sanitizedDonorType]) {
            return false;
        }
        // Check if the donor type can donate to the needed type.
        return compatibility[sanitizedDonorType].includes(sanitizedNeededType);
    };

    let userProfile = null;
    let userId = null;
    let currentSelectedRole = null;
    let socket = null;
    let donorMap = null; 
    const USER_PROFILE_KEY = 'blood_connect_user_profile';
    const ALL_USERS_KEY = 'blood_connect_all_users';
    const DONATION_COOLDOWN_DAYS = 90;
    const adminSecret = 'hellowrld'; 


    // API Wrapper
    const API = {
        async post(path, body) {
            try {
                const response = await fetch(BACKEND_URL + path, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return response.json();
            } catch (error) {
                console.error('API POST error:', error);
                showNotification('Connection error or invalid data.', 'red');
                return null;
            }
        },
        async get(path) {
            try {
                const response = await fetch(BACKEND_URL + path);
                return response.json();
            } catch (error) {
                console.error('API GET error:', error);
                showNotification('Connection error.', 'red');
                return null;
            }
        },
        async put(path, body = {}) {
            try {
                const response = await fetch(BACKEND_URL + path, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return response.json();
            } catch (error) {
                console.error('API PUT error:', error);
                showNotification('Connection error.', 'red');
                return null;
            }
        }
    };

    // --- UI/STATE MANAGEMENT ---
    
    // FIX: Comprehensive UI object definition
    const ui = {
        loading: document.getElementById('loading-state'),
        roleSelection: document.getElementById('role-selection'),
        authSelection: document.getElementById('auth-selection'),
        authRoleDisplay: document.getElementById('auth-role-display'),
        userLogin: document.getElementById('user-login'),
        adminLogin: document.getElementById('admin-login'),
        profileSetup: document.getElementById('profile-setup'),
        mainDashboard: document.getElementById('main-dashboard'),
        userBlocked: document.getElementById('user-blocked'),
        dashboardTitle: document.getElementById('dashboard-title'),
        adminDashboard: document.getElementById('admin-dashboard'),
        // Dashboard views
        viewRequestTab: document.getElementById('view-request-tab'),
        viewDonorTab: document.getElementById('view-donor-tab'),
        viewRequest: document.getElementById('view-request'),
        viewDonor: document.getElementById('view-donor'),
        requestForm: document.getElementById('request-form'), // Now correctly defined
        // Admin views
        adminTabUsers: document.getElementById('admin-tab-users'),
        adminTabManagement: document.getElementById('admin-tab-management'),
        adminTabRequests: document.getElementById('admin-tab-requests'),
        adminViewUsers: document.getElementById('admin-view-users'),
        adminViewManagement: document.getElementById('admin-view-management'),
        adminViewRequests: document.getElementById('admin-view-requests'),
        pendingUsersList: document.getElementById('pending-users-list'),
        allUsersList: document.getElementById('all-users-list'),
        pendingRequestsList: document.getElementById('pending-requests-list'),
        // Form inputs
        nameInput: document.getElementById('name'),
        phoneInput: document.getElementById('phone'),
        pinCodeInput: document.getElementById('pinCode'),
        bloodTypeInput: document.getElementById('bloodType'),
        ageInput: document.getElementById('age'),
        weightInput: document.getElementById('weight'),
        genderInput: document.getElementById('gender'),
        addressInput: document.getElementById('address'),
        lastDonationDateInput: document.getElementById('lastDonationDate'),
        // Note: bloodReportFile, statusDisplay are not used in this version but are kept for completeness 
    };

    // Mapping initialization helper
    function initMap(center = [12.9716, 77.5946]) { // Default to Bengaluru center
        if (donorMap) donorMap.remove();
        donorMap = L.map('donorMap').setView(center, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(donorMap);
        
        // Add a marker for the current pin code
        const pin = userProfile?.pinCode;
        if (pin && PIN_COORDINATES[pin]) {
             const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            L.marker(PIN_COORDINATES[pin], { icon: redIcon }).bindPopup(`<b>Your Home Area (Donor):</b><br>Pin ${pin}`).addTo(donorMap);
        }
    }


    const showNotification = (message, type) => {
        const box = document.getElementById('global-message-box');
        const content = document.getElementById('global-message-content');
        
        box.classList.remove('-translate-y-full', 'opacity-0');
        box.classList.add('translate-y-0', 'opacity-100');
        
        content.textContent = message;
        content.className = 'p-3 rounded-lg shadow-xl text-center font-medium max-w-lg mx-auto';
        
        if (type === 'green') {
            content.classList.add('bg-green-500', 'text-white');
        } else if (type === 'red') {
            content.classList.add('bg-red-500', 'text-white');
        } else if (type === 'blue') {
            content.classList.add('bg-blue-500', 'text-white');
        } else {
            content.classList.add('bg-gray-700', 'text-white');
        }

        setTimeout(() => {
            box.classList.remove('translate-y-0', 'opacity-100');
            box.classList.add('-translate-y-full', 'opacity-0');
        }, 4000);
    };

    const saveProfile = (profile) => {
        userProfile = profile;
        userId = profile ? profile.userId : null;
        if (profile) {
            localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profile));
        } else {
            localStorage.removeItem(USER_PROFILE_KEY);
        }
    };

    const loadProfile = () => {
        const profileData = localStorage.getItem(USER_PROFILE_KEY);
        if (profileData) {
            userProfile = JSON.parse(profileData);
            userId = userProfile.userId;
            
            if (userProfile.bloodType) {
                userProfile.bloodType = userProfile.bloodType.toUpperCase();
            }
        }
    };

    const hideAllViews = () => {
        [ui.loading, ui.roleSelection, ui.userLogin, ui.adminLogin, ui.adminDashboard, ui.userBlocked, ui.profileSetup, ui.mainDashboard, ui.authSelection].forEach(view => {
            view.classList.add('hidden');
        });
    };

    const logoutUser = () => {
        saveProfile(null);
        showRoleSelection();
    };

    const showRoleSelection = () => {
        hideAllViews();
        currentSelectedRole = null;
        ui.roleSelection.classList.remove('hidden');
    };

    function showAuthSelection(role) {
        hideAllViews();
        currentSelectedRole = role;
        ui.authRoleDisplay.textContent = role;
        ui.authSelection.classList.remove('hidden');
    }

    function showUserLogin() {
        hideAllViews();
        document.getElementById('login-role-display').textContent = currentSelectedRole;
        ui.userLogin.classList.remove('hidden');
    }

    function showAdminLogin() {
        hideAllViews();
        ui.adminLogin.classList.remove('hidden');
    }

    function showUserBlocked() {
        hideAllViews();
        ui.userBlocked.classList.remove('hidden');
    }
    
    // --- MAIN DASHBOARD VIEW ---

    function showDashboard() {
        hideAllViews();
        ui.mainDashboard.classList.remove('hidden');
        ui.dashboardTitle.textContent = `${userProfile.name}'s Dashboard`;

        // FIX: Control the view and tabs based on role to block request submission
        if (userProfile.userRole === 'Donor') {
            ui.viewRequestTab.classList.add('hidden'); // Hide the request creation tab
            const hospitalSection = document.getElementById('hospital-request-section');
            if (hospitalSection) hospitalSection.classList.add('hidden'); // Hide the form section
            setActiveView(ui.viewDonorTab, ui.viewDonor); // Force Donor to the 'Find Requests' view
        } else { // Hospital
            ui.viewRequestTab.classList.remove('hidden'); 
            const hospitalSection = document.getElementById('hospital-request-section');
            if (hospitalSection) hospitalSection.classList.remove('hidden');
            // If Hospital, default to the Request view
            setActiveView(ui.viewRequestTab, ui.viewRequest);
        }

        updateDashboardData();
    }
    
    function setActiveView(tabElement, viewElement) {
        [ui.viewRequestTab, ui.viewDonorTab].forEach(t => t.classList.remove('bg-red-600', 'text-white', 'border-transparent'));
        [ui.viewRequestTab, ui.viewDonorTab].forEach(t => t.classList.add('text-red-600', 'bg-white', 'border-red-200'));

        tabElement.classList.add('bg-red-600', 'text-white', 'border-transparent');
        tabElement.classList.remove('text-red-600', 'bg-white', 'border-red-200');

        [ui.viewRequest, ui.viewDonor].forEach(view => view.classList.add('hidden'));
        viewElement.classList.remove('hidden');

        if (viewElement === ui.viewDonor) {
            updateDashboardData();
            // Map logic initialization
            const pin = userProfile?.pinCode;
            if (pin && PIN_COORDINATES[pin]) {
                initMap(PIN_COORDINATES[pin]);
            } else {
                initMap([12.9716, 77.5946]); // Default Bengaluru center
            }
        }
    }
    
    // Admin dashboard functions (showAdminDashboard, setActiveAdminTab, renderAdminRequests, renderAllUsers, renderPendingUsers are assumed to be here)

    // --- DATA FETCHING & SYNCHRONIZATION ---

    async function fetchAndSyncUsers() {
        try {
            const resp = await API.get('/api/sync-storage');
            if (resp && resp.users) {
                localStorage.setItem(ALL_USERS_KEY, JSON.stringify(resp.users));
                localStorage.setItem('blood_connect_all_requests', JSON.stringify(resp.requests)); 
                console.log(`Synced ${resp.users.length} users and ${resp.requests.length} requests from backend.`);

                // Update local user profile in case status changed
                if (userId) {
                    const updatedUser = resp.users.find(u => u.userId === userId);
                    if (updatedUser) {
                        saveProfile(updatedUser);
                    }
                }
            }
            updateDashboardData();
        } catch (error) {
            console.error('Sync failed:', error);
            showNotification('Failed to sync data from the server.', 'red');
        }
    }

    function updateDashboardData() {
        const allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '[]');
        const allRequests = JSON.parse(localStorage.getItem('blood_connect_all_requests') || '[]');
        
        if (userProfile && userProfile.userRole === 'Admin') {
            // Assumed Admin functions: renderPendingUsers(allUsers); renderAdminRequests(allRequests); renderAllUsers(allUsers);
        } else if (userProfile) {
            renderMyRequests(allRequests);
            renderDonorRequests(allRequests); // Donor view relies on this
        }
    }

    // --- DASHBOARD RENDERING ---

    function renderDonorRequests(requestsArray) {
        try {
            const donorType = (userProfile.bloodType || '').toUpperCase(); 
            const donorPin = userProfile.pinCode;
            const listEl = document.getElementById('donors-list');
            const noDonorsEl = document.getElementById('no-donors');
            const matchedPinEl = document.getElementById('matched-pin-display');

            if (!donorType || !donorPin) {
                listEl.innerHTML = `<p class="text-gray-500 text-center p-6 bg-red-50 rounded-lg border border-red-200">‚ö†Ô∏è Please complete your profile with your blood type and pin code to see matching requests.</p>`;
                matchedPinEl.textContent = 'N/A';
                return;
            }

            matchedPinEl.textContent = donorPin;
            const nearbyPins = getNearbyPins(donorPin);
            
            // FIX: Filter requests to only show APPROVED, compatible, and nearby requests
            let matchingRequests = (requestsArray || []).filter(request => {
                const bloodMatch = isCompatible(donorType, (request.bloodTypeNeeded || '').toUpperCase());
                
                const requestPin = String(request.pinCode); 
                const pinMatch = nearbyPins.includes(requestPin);

                const isApproved = request.status === 'APPROVED'; // CRITICAL FIX: Only show approved requests
                
                return isApproved && bloodMatch && pinMatch;
            });

            // Sort by pin code match (exact match first) and then by time
            matchingRequests.sort((a, b) => {
                const aIsExact = a.pinCode === donorPin;
                const bIsExact = b.pinCode === donorPin;
                if (aIsExact && !bIsExact) return -1;
                if (!aIsExact && bIsExact) return 1;
                return (new Date(b.updatedAt || b.createdAt) || 0) - (new Date(a.updatedAt || a.createdAt) || 0); 
            });

            
            listEl.innerHTML = '';
            
            if (matchingRequests.length === 0) {
                noDonorsEl.classList.remove('hidden');
                listEl.appendChild(noDonorsEl);
                noDonorsEl.textContent = `‚úÖ No approved requests for ${donorType} near Pin ${donorPin} right now. Thank you for being ready!`;
                
                if (donorMap) { // Clear markers if no requests
                    donorMap.eachLayer(layer => {
                        if (layer instanceof L.Marker && layer.options.icon.options.iconUrl.includes('blue')) { 
                            donorMap.removeLayer(layer); 
                        }
                    });
                }
                return;
            }

            noDonorsEl.classList.add('hidden');

            matchingRequests.forEach(request => {
                const card = document.createElement('div');
                const isExactPin = request.pinCode === donorPin;
                const matchStatus = isExactPin ? 'Exact Pin Match' : 'Nearby Pin Match';
                card.className = `p-4 rounded-xl shadow-md border-l-4 ${isExactPin ? 'border-red-600 bg-red-50' : 'border-yellow-600 bg-yellow-50'}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="space-y-1">
                            <h4 class="text-lg font-bold text-gray-800">${request.name} <span class="text-sm font-normal text-gray-500">(${request.pinCode})</span></h4>
                            <p class="text-sm text-red-700 font-semibold">ü©∏ NEED: ${request.bloodTypeNeeded}</p>
                            <p class="text-xs text-gray-500">üìç ${matchStatus}</p>
                            <p class="text-xs text-gray-500">üìû Call: ${request.phone}</p>
                        </div>
                        <div class="text-xs text-gray-500 text-right">
                            <span class="block">${new Date(request.updatedAt || request.createdAt).toLocaleDateString()}</span>
                            <span class="block">${new Date(request.updatedAt || request.createdAt).toLocaleTimeString()}</span>
                        </div>
                    </div>
                `;
                listEl.appendChild(card);
            });
            
            // Map rendering of requests
            if (donorMap) {
                 // Clear existing request markers
                 donorMap.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer.options.icon.options.iconUrl.includes('blue')) { 
                        donorMap.removeLayer(layer); 
                    }
                 });

                matchingRequests.forEach(request => {
                    const coords = PIN_COORDINATES[request.pinCode];
                    if (coords) {
                        const blueIcon = new L.Icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                        });
                        L.marker(coords, { icon: blueIcon })
                            .bindPopup(`<b>${request.name}</b><br>Needs ${request.bloodTypeNeeded}<br>Pin ${request.pinCode}`)
                            .addTo(donorMap);
                    }
                });
            }

        } catch (err) { console.error('renderDonorRequests error', err); }
    }

    // Assumed renderMyRequests function (Hospitals Only)
    function renderMyRequests(requestsArray) {
        const myListEl = document.getElementById('my-requests-list');
        if (!myListEl) return;
        myListEl.innerHTML = '';
        
        if (userProfile.userRole === 'Donor') return; // Donors cannot create requests

        const myRequests = (requestsArray || []).filter(r => r.requesterId === userId).sort((a, b) => (new Date(b.createdAt) || 0) - (new Date(a.createdAt) || 0));

        if (myRequests.length === 0) {
            myListEl.innerHTML = `<p class="text-gray-500 text-center p-6 bg-red-50 rounded-lg border border-red-200">No requests submitted yet.</p>`;
            return;
        }

        try {
            myRequests.forEach(r => {
                const statusColor = r.status === 'APPROVED' ? 'bg-green-100 text-green-700' : 
                                    r.status === 'DENIED' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700';
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl shadow-md border-l-4 ${r.status === 'APPROVED' ? 'border-green-600' : r.status === 'DENIED' ? 'border-red-600' : 'border-yellow-600'}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-lg font-bold text-gray-800">Need: ${r.bloodTypeNeeded}</p>
                            <p class="text-sm text-gray-500">Status: <span class="${statusColor} py-0.5 px-2 rounded-full font-semibold">${r.status}</span></p>
                        </div>
                        <div class="flex gap-2">
                            <button class="cancel-request text-sm text-red-600" data-request-id="${r._id}">Cancel</button>
                        </div>
                    </div>
                `;
                myListEl.appendChild(card);

                card.querySelector('.cancel-request').addEventListener('click', (e) => {
                    if (!confirm('Cancel this request?')) return;
                    const reqId = e.currentTarget.dataset.requestId;
                    // API call to cancel (deny) the request
                    API.put(`/api/admin/approve-request/${reqId}?adminSecret=${encodeURIComponent(adminSecret)}`, { action: 'deny' });
                    fetchAndSyncUsers();
                });
            });
        } catch (err) { console.error('renderMyRequests error', err); }
    }

    // Admin rendering functions are assumed to be here (renderPendingUsers, renderAdminRequests, renderAllUsers)


    // --- EVENT LISTENERS ---

    // Role Selection
    document.querySelectorAll('.role-select-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            showAuthSelection(e.currentTarget.dataset.role);
        });
    });

    // Auth Selection
    document.querySelectorAll('.action-select-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const action = e.currentTarget.dataset.action;
            if (currentSelectedRole === 'Admin') {
                showAdminLogin();
            } else if (action === 'login') {
                showUserLogin();
            } else if (action === 'register') {
                hideAllViews();
                document.getElementById('role-input').value = currentSelectedRole;
                // Pre-populate name, phone for register (optional but helpful)
                // ui.nameInput.value = ''; ui.phoneInput.value = ''; ui.pinCodeInput.value = ''; 
                document.getElementById('donor-fields').classList.toggle('hidden', currentSelectedRole === 'Hospital');
                
                // Clear and enable form fields
                ui.profileForm.reset();
                ui.phoneInput.readOnly = false;
                
                ui.profileSetup.classList.remove('hidden');
            }
        });
    });

    // Login Form Submission
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const phone = document.getElementById('login-phone').value.trim();
        if (!phone) return showNotification('Please enter a phone number.', 'red');

        const resp = await API.post('/api/auth/login', { phone: phone });
        
        if (resp && resp.user) {
            if (resp.user.userRole !== currentSelectedRole) {
                return showNotification(`Error: Phone is registered as a ${resp.user.userRole}. Please log in using the correct role.`, 'red');
            }
            saveProfile(resp.user);
            showNotification(`Welcome back, ${resp.user.name}.`, 'green');
            if (resp.user.userRole === 'Admin') {
                showAdminDashboard();
            } else if (resp.user.status === 'VERIFIED') {
                showDashboard();
            } else {
                showUserBlocked();
            }
        } else {
            showNotification('Login failed. User not found. Please register.', 'red');
        }
    });

    // Admin Login Form Submission
    document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const secret = document.getElementById('admin-secret').value;
        if (secret === adminSecret) {
            saveProfile({ userId: 'ADMIN', name: 'Admin User', userRole: 'Admin', status: 'VERIFIED' });
            showNotification('Admin login successful.', 'green');
            showAdminDashboard();
        } else {
            showNotification('Invalid Admin Secret.', 'red');
        }
    });

    // Profile Setup Form Submission (Registration)
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const role = document.getElementById('role-input').value;
        const body = {
            name: ui.nameInput.value.trim(),
            phone: ui.phoneInput.value.trim(),
            userRole: role,
            pinCode: ui.pinCodeInput.value.trim(),
            address: ui.addressInput.value.trim(),
            status: 'PENDING_VERIFICATION'
        };

        if (role === 'Donor') {
            body.bloodType = ui.bloodTypeInput.value.trim().toUpperCase();
            body.age = parseInt(ui.ageInput.value);
            body.weight = parseInt(ui.weightInput.value);
            body.gender = ui.genderInput.value.trim();
            
            const lastDonationDate = ui.lastDonationDateInput.value;
            if (lastDonationDate) {
                body.lastDonationTime = new Date(lastDonationDate).getTime();
            }
            // Basic Donor validation (add more as needed)
            if (!body.bloodType || isNaN(body.age) || isNaN(body.weight)) {
                 return showNotification('Please fill all required donor fields.', 'red');
            }
        }
        
        const resp = await API.post('/api/auth/register', body);

        if (resp && resp.user) {
            saveProfile(resp.user);
            showNotification('Registration successful! Awaiting admin approval.', 'green');
            showUserBlocked();
        } else {
            showNotification(resp?.error || 'Registration failed.', 'red');
        }
    });

    // Back Buttons
    document.getElementById('back-to-auth-select-login').addEventListener('click', showRoleSelection);
    document.getElementById('back-to-auth-select-admin').addEventListener('click', showRoleSelection);

    // Logout Buttons
    document.getElementById('logout-dashboard').addEventListener('click', logoutUser);
    document.getElementById('logout-blocked').addEventListener('click', logoutUser);
    document.getElementById('logout-admin').addEventListener('click', logoutUser);


    // Dashboard Tabs
    ui.viewRequestTab.addEventListener('click', () => setActiveView(ui.viewRequestTab, ui.viewRequest));
    ui.viewDonorTab.addEventListener('click', () => setActiveView(ui.viewDonorTab, ui.viewDonor));


    // Request Submission (Hospitals Only)
    ui.requestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const bloodTypeNeeded = document.getElementById('bloodTypeNeeded').value;
        
        const pin = userProfile.pinCode;

        if (userProfile.status !== 'VERIFIED') {
            showNotification("Request cannot be submitted. Your account is not yet verified by an administrator.", 'red');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Request & Find Nearby Donors';
            return;
        }
        
        // FIX: Frontend check to block Donor requests
        if (userProfile.userRole !== 'Hospital') {
             showNotification("Only Hospitals can submit blood requests.", 'red');
             submitBtn.disabled = false;
             submitBtn.textContent = 'Submit Request & Find Nearby Donors';
             return;
        }

        const requestBody = {
            requesterId: userProfile.userId,
            name: userProfile.name,
            phone: userProfile.phone,
            userRole: userProfile.userRole,
            pinCode: pin, 
            bloodTypeNeeded: bloodTypeNeeded,
            status: 'PENDING'
        };

        const resp = await API.post('/api/request', requestBody);

        if (resp && resp.request) {
            showNotification('Request sent and awaiting admin approval.', 'green');
        } else {
            showNotification(resp?.error || 'Request failed.', 'red');
        }
        
        fetchAndSyncUsers();
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Request & Find Nearby Donors';
    });


    // --- SOCKET.IO ---

    function initSocket() {
        if (socket) return;
        socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });
        socket.on('connect', () => console.log('Socket connected:', socket.id));

        socket.on('newRequest', (data) => {
            console.log('socket newRequest', data);
            // This is generally a PENDING request, so we only update the admin list or let approval trigger the notification
            // showNotification('New emergency request received (from server).', 'blue'); 
            fetchAndSyncUsers();
        });

        // FIX: Critical listeners for real-time updates for Donors
        socket.on('requestApproved', (data) => {
            console.log('socket requestApproved', data);
            // Check if this approved request is relevant to the current user (optional, but good practice)
            if (userProfile && userProfile.userRole === 'Donor') {
                const donorType = (userProfile.bloodType || '').toUpperCase();
                const nearbyPins = getNearbyPins(userProfile.pinCode);

                if (isCompatible(donorType, (data.bloodTypeNeeded || '').toUpperCase()) && nearbyPins.includes(data.pinCode)) {
                    showNotification('New matching blood request approved in your area!', 'green');
                }
            }
            fetchAndSyncUsers(); // Reload data immediately
        });
        
        socket.on('requestDenied', (data) => {
            console.log('socket requestDenied', data);
            fetchAndSyncUsers(); // Reload data immediately
        });
        
        // Other listeners
        socket.on('userRegistered', fetchAndSyncUsers);
        socket.on('userVerified', fetchAndSyncUsers);
    }
    
    // --- ADMIN FUNCTIONS (Assumed to be here) ---
    // function showAdminDashboard() { ... }
    // function setActiveAdminTab(tab, view) { ... }
    // function renderPendingUsers(users) { ... }
    // function renderAdminRequests(requests) { ... }
    // function renderAllUsers(users) { ... }
    // function seedSampleData() { ... } // Assuming this is present for initial setup

    // --- INITIALIZATION ---
    function initializeApp() {
        // seedSampleData(); // Keep this if you use sample data
        loadProfile();
       
        if (userProfile && userProfile.userRole === 'Admin') {
            // showAdminDashboard(); // Uncomment if you add Admin logic
            // For now, if no admin logic:
             showNotification('Admin logic is currently commented out for brevity. Logging out.', 'blue');
             logoutUser(); 
        } else if (userProfile && userProfile.status === 'VERIFIED') {
            showDashboard();
        } else if (userProfile && userProfile.status !== 'VERIFIED') {
             showUserBlocked();
        } else {
            showRoleSelection();
        }
         
        // Set max date for donation input
        if (ui.lastDonationDateInput) {
            ui.lastDonationDateInput.max = new Date().toISOString().split('T')[0];
        }
       
        // Assumed logic for form validation is here
        // document.querySelectorAll('#profile-form input[required], #profile-form select[required], #profile-form textarea[required]').forEach(input => {
        //      input.dataset.originalRequired = 'true';
        // });
        
        initSocket(); // Initialize socket connection
        fetchAndSyncUsers(); // Initial data load
    }
    
    initializeApp(); 

</script>

</body>
</html>