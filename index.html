<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blood Connect Pro (Bengaluru)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background:#f8f9fa; }
    .btn-primary { background:#e53e3e; color:white; transition: all .12s ease; }
    .btn-primary:hover { background:#c53030; transform: translateY(-1px); }
    .main-card { background:white; width:95%; max-width:1000px; box-shadow:0 10px 20px rgba(0,0,0,0.06); }
    #donorMap { height: 320px; border-radius: 0.6rem; border:2px solid #e53e3e; }
    .role-bubble-card { transition: all .18s ease; cursor:pointer; border-radius:1rem; box-shadow:0 8px 18px rgba(0,0,0,0.06); min-height:160px; }
    .donor-bubble { background:#fff1f1; border:3px solid #f87171; }
    .hospital-bubble { background:#f0f8ff; border:3px solid #60a5fa; }
    .admin-bubble { background:#f3f4f6; border:3px solid #9ca3af; }
    .hidden-for-donor { display:none !important; }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-6 flex justify-center items-start">
    <div class="main-card rounded-2xl p-8 border-t-8 border-red-600">
      <header class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-red-700">ü©∏ Blood Connect Pro (Bengaluru)</h1>
        <p class="text-gray-600 mt-1">Local Emergency Donor Matching</p>
      </header>

      <div id="global-message-box" class="fixed inset-x-0 top-4 z-50 flex justify-center pointer-events-none">
        <div id="global-message-content" class="pointer-events-auto bg-white p-3 rounded shadow text-center"></div>
      </div>

      <!-- Role selection -->
      <div id="role-selection" class="space-y-6 text-center">
        <h2 class="text-2xl font-bold text-red-700">Select Your Role</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button data-role="Donor" class="select-role-btn role-bubble-card donor-bubble p-6">
            <div class="text-red-700 font-bold text-lg">I am a Donor</div>
            <div class="text-sm text-gray-600 mt-1">View urgent requests in your area</div>
          </button>
          <button data-role="Hospital" class="select-role-btn role-bubble-card hospital-bubble p-6">
            <div class="text-blue-700 font-bold text-lg">I am a Hospital</div>
            <div class="text-sm text-gray-600 mt-1">Create urgent blood requests</div>
          </button>
          <button id="select-admin-role-btn" class="role-bubble-card admin-bubble p-6">
            <div class="text-gray-800 font-bold text-lg">Administrator</div>
            <div class="text-sm text-gray-600 mt-1">Manage users and requests</div>
          </button>
        </div>
      </div>

      <!-- Auth selection -->
      <div id="auth-selection" class="hidden text-center space-y-4">
        <h2 class="text-2xl font-semibold">Welcome, <span id="auth-role-display"></span></h2>
        <div class="space-y-3">
          <button id="auth-login-btn" class="w-full py-3 rounded-xl btn-primary">Login</button>
          <button id="auth-register-btn" class="w-full py-3 rounded-xl border border-red-200 text-red-700">Register</button>
          <button id="auth-back-to-role" class="w-full text-sm text-gray-500">‚Üê Back</button>
        </div>
      </div>

      <!-- Login form -->
      <div id="user-login" class="hidden">
        <h3 class="text-lg font-semibold mb-3"><span id="login-role-display"></span> Login</h3>
        <form id="user-login-form" class="space-y-3">
          <input id="login-phone" placeholder="Phone (10 digits)" class="w-full p-3 border rounded" required />
          <button class="w-full py-3 rounded-xl btn-primary">Login</button>
          <button type="button" id="login-back-to-auth" class="w-full text-sm text-gray-500">‚Üê Back</button>
        </form>
      </div>

      <!-- Register / Profile -->
      <div id="profile-setup" class="hidden">
        <h3 class="text-lg font-semibold mb-3"><span id="registration-role"></span> Registration</h3>
        <form id="profile-form" class="space-y-3">
          <input type="hidden" id="userRoleHidden" value="Donor" />
          <input id="name" placeholder="Full name" class="w-full p-3 border rounded" required />
          <input id="phone" placeholder="Phone" class="w-full p-3 border rounded" required />
          <div class="grid grid-cols-2 gap-2">
            <input id="pinCode" placeholder="Pin code (6 digits)" class="w-full p-3 border rounded" required />
            <select id="bloodType" class="w-full p-3 border rounded">
              <option value="">Blood type (optional)</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
            </select>
          </div>
          <button class="w-full py-3 rounded-xl btn-primary">Register</button>
          <button type="button" id="signup-back-to-role" class="w-full text-sm text-gray-500">‚Üê Back</button>
        </form>
      </div>

      <!-- Admin login -->
      <div id="admin-login" class="hidden">
        <h3 class="text-lg font-semibold mb-3">Admin Login</h3>
        <form id="admin-login-form" class="space-y-3">
          <input id="admin-pin" placeholder="Admin secret" class="w-full p-3 border rounded" />
          <button class="w-full py-3 rounded-xl btn-primary">Enter Admin</button>
          <button type="button" id="admin-back-to-role" class="w-full text-sm text-gray-500">‚Üê Back</button>
        </form>
      </div>

      <!-- Blocked (waiting verification) -->
      <div id="user-blocked" class="hidden p-4 bg-red-50 rounded">
        <h3 class="font-bold text-red-600">Account pending verification</h3>
        <p class="text-gray-600">Your account is awaiting admin verification.</p>
        <button id="blocked-logout-btn" class="mt-3 text-sm text-gray-500">Back to main</button>
      </div>

      <!-- Admin dashboard -->
      <div id="admin-dashboard" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Admin Dashboard</h3>
          <button id="admin-logout-btn" class="text-sm text-gray-600">Logout</button>
        </div>

        <div class="flex space-x-2 mb-4">
          <button id="admin-tab-users" class="py-2 px-3 border-b-2 border-blue-600 text-blue-600">Pending Users</button>
          <button id="admin-tab-management" class="py-2 px-3">All Users</button>
          <button id="admin-tab-requests" class="py-2 px-3">Pending Requests</button>
        </div>

        <div id="admin-view-users">
          <h4 class="font-semibold mb-2">Pending Users</h4>
          <div id="pending-users-list" class="space-y-2"></div>
        </div>

        <div id="admin-view-management" class="hidden">
          <h4 class="font-semibold mb-2">All Users</h4>
          <div id="all-users-list" class="space-y-2"></div>
        </div>

        <div id="admin-view-requests" class="hidden">
          <h4 class="font-semibold mb-2">Pending Requests</h4>
          <div id="pending-requests-list" class="space-y-2"></div>
        </div>
      </div>

      <!-- Main dashboard -->
      <div id="main-dashboard" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Dashboard (<span id="dashboard-role-display"></span>)</h3>
          <div class="space-x-2">
            <button id="edit-profile-btn" class="text-sm text-gray-600">Edit</button>
            <button id="logout-btn" class="text-sm text-gray-600">Logout</button>
          </div>
        </div>

        <!-- donor status -->
        <div class="bg-gray-50 p-4 rounded mb-4">
          <div class="flex justify-between">
            <div>
              <div class="text-sm text-gray-600">Donor Status: <strong id="donor-status"></strong></div>
              <div class="text-xs text-gray-500">Pin: <code id="user-pin-display"></code> ‚Ä¢ Blood: <code id="user-blood-display"></code></div>
            </div>
          </div>
        </div>

        <!-- tabs -->
        <div class="flex space-x-2 mb-4">
          <button id="tab-request" class="hospital-only py-2 px-3 rounded text-red-600 border-b-2 border-red-600">Request Blood & Find Donors</button>
          <button id="tab-donor" class="py-2 px-3 rounded text-gray-600">Available Donor Requests</button>
        </div>

        <!-- Hospital-only request area -->
        <div id="view-request" class="hospital-only">
          <h4 class="font-semibold mb-2">Submit Urgent Blood Need</h4>
          <form id="request-form" class="space-y-3 p-4 bg-white border rounded">
            <div class="grid grid-cols-2 gap-2">
              <input id="request-pinCode" placeholder="Area pin code (where blood needed)" class="p-3 border rounded" required />
              <select id="bloodTypeNeeded" class="p-3 border rounded" required>
                <option value="">Blood Type Needed</option>
                <option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
              </select>
            </div>
            <button id="submit-request-btn" class="w-full py-3 rounded-xl btn-primary">Submit Request & Find Nearby Donors</button>
          </form>

          <div class="mt-4">
            <h5 class="font-semibold">Matching Donors Near Requested Area</h5>
            <div id="matched-pin-display" class="text-sm text-gray-600 mb-2">...</div>
            <div id="donorMap" class="mb-3"></div>
            <div id="donors-list" class="space-y-2"></div>
          </div>
        </div>

        <!-- Donor view: available requests -->
        <div id="view-donor">
          <h4 class="font-semibold mb-2">Emergency Requests Near You</h4>
          <div id="requests-list" class="space-y-2"></div>
        </div>
      </div>

      <div id="profile-management" class="hidden"></div>
    </div>
  </div>

<script>
/* ======= CONFIG ======= */
const BACKEND_URL = "https://blood-connect-api-67g9.onrender.com"; // update if needed
const API_BASE = BACKEND_URL + "/api";
const ADMIN_SECRET = "hellowrld"; // from your .env (frontend uses it when admin performs actions) - backend validates its process.env.ADMIN_SECRET

/* ======= API helpers ======= */
const API = {
  async post(path, body) {
    try {
      const res = await fetch(API_BASE + path, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const json = await res.json().catch(()=>null);
      return { ok: res.ok, status: res.status, json };
    } catch (e) { console.warn('POST error', e); return { ok:false }; }
  },
  async get(path) {
    try {
      const res = await fetch(API_BASE + path);
      const json = await res.json().catch(()=>null);
      return { ok: res.ok, status: res.status, json };
    } catch (e) { console.warn('GET error', e); return { ok:false }; }
  },
  async put(path, body) {
    try {
      const res = await fetch(API_BASE + path, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const json = await res.json().catch(()=>null);
      return { ok: res.ok, status: res.status, json };
    } catch (e) { console.warn('PUT error', e); return { ok:false }; }
  }
};

/* ======= Socket ======= */
let socket = null;
function initSocket() {
  if (!window.io) { console.warn('socket.io client missing'); return; }
  socket = io(BACKEND_URL, { transports:['websocket','polling'] });
  socket.on('connect', ()=>console.log('socket connected', socket.id));
  socket.on('newRequest', (d)=> { showNotification('New request created'); fetchAndSync(); });
  socket.on('userRegistered', (d)=> { showNotification('New user registered'); fetchAndSync(); });
  socket.on('userVerified', (d)=> { showNotification('User verification updated'); fetchAndSync(); });
  socket.on('requestApproved', (d)=> { showNotification('A request was approved'); fetchAndSync(); });
  socket.on('requestDenied', (d)=> { showNotification('A request was denied'); fetchAndSync(); });
}

/* ======= UI helpers ======= */
function showNotification(msg) {
  const box = document.getElementById('global-message-content');
  box.textContent = msg;
  box.parentElement.classList.remove('opacity-0');
  setTimeout(()=> { box.textContent = ''; }, 3500);
}
function qs(id){ return document.getElementById(id); }
function createElem(tag, className){ const e = document.createElement(tag); if(className) e.className = className; return e; }

/* ======= App state ======= */
const USER_KEY = 'blood_connect_user_profile';
let userProfile = null;

/* ======= UI refs & initial wiring ======= */
const roleButtons = Array.from(document.querySelectorAll('.select-role-btn'));
const authSelection = qs('auth-selection');
const roleSelection = qs('role-selection');
const loginBox = qs('user-login');
const registerBox = qs('profile-setup');
const adminLoginBox = qs('admin-login');
const mainDashboard = qs('main-dashboard');
const adminDashboard = qs('admin-dashboard');
const donorView = qs('view-donor');
const requestView = qs('view-request');
const tabRequestBtn = qs('tab-request');
const tabDonorBtn = qs('tab-donor');
const requestForm = qs('request-form');

/* Role selection */
let currentSelectedRole = null;
roleButtons.forEach(btn => btn.addEventListener('click', () => {
  const role = btn.getAttribute('data-role') || (btn.id === 'select-admin-role-btn' ? 'Admin' : null);
  currentSelectedRole = role;
  qs('auth-role-display').textContent = role;
  roleSelection.classList.add('hidden');
  authSelection.classList.remove('hidden');
}));

qs('auth-back-to-role').addEventListener('click', ()=> {
  authSelection.classList.add('hidden');
  roleSelection.classList.remove('hidden');
});

/* Login / Register flows (using backend) */
qs('auth-login-btn').addEventListener('click', ()=> {
  authSelection.classList.add('hidden');
  loginBox.classList.remove('hidden');
  qs('login-role-display').textContent = currentSelectedRole || 'User';
});
qs('auth-register-btn').addEventListener('click', ()=> {
  authSelection.classList.add('hidden');
  registerBox.classList.remove('hidden');
  qs('registration-role').textContent = currentSelectedRole || 'New User';
  qs('userRoleHidden').value = currentSelectedRole || 'Donor';
});
qs('login-back-to-auth').addEventListener('click', ()=> { loginBox.classList.add('hidden'); authSelection.classList.remove('hidden'); });
qs('signup-back-to-role').addEventListener('click', ()=> { registerBox.classList.add('hidden'); roleSelection.classList.remove('hidden'); });
qs('admin-back-to-role').addEventListener('click', ()=> { adminLoginBox.classList.add('hidden'); roleSelection.classList.remove('hidden'); });

/* Login form submit (calls backend /api/auth/login) */
qs('user-login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const phone = qs('login-phone').value.trim();
  const role = currentSelectedRole || 'Donor';
  // call backend login
  const res = await API.post('/auth/login', { phone });
  if (!res.ok) {
    showNotification('Login failed: ' + (res.json?.error || res.status));
    return;
  }
  const user = res.json.user;
  // If server returns user, persist
  userProfile = user;
  localStorage.setItem(USER_KEY, JSON.stringify(userProfile));
  enterDashboard();
});

/* Register form submit (calls backend /api/auth/register) */
qs('profile-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    userId: crypto.randomUUID(),
    name: qs('name').value.trim(),
    phone: qs('phone').value.trim(),
    userRole: qs('userRoleHidden').value || 'Donor',
    pinCode: (qs('pinCode').value || '').toString(),
    bloodType: qs('bloodType').value || null
  };
  const res = await API.post('/auth/register', payload);
  if (!res.ok) {
    showNotification('Register failed: ' + (res.json?.error || res.status));
    return;
  }
  const user = res.json.user;
  userProfile = user;
  localStorage.setItem(USER_KEY, JSON.stringify(userProfile));
  // If user requires verification (default PENDING_VERIFICATION) show blocked
  if (user.status === 'PENDING_VERIFICATION') {
    registerBox.classList.add('hidden');
    qs('user-blocked').classList.remove('hidden');
    return;
  }
  enterDashboard();
});

/* Admin login (quick demo uses adminSecret locally to open admin UI) */
qs('admin-login-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const pin = qs('admin-pin').value.trim();
  // This is just for showing the admin UI (the server validates admin API calls server-side)
  if (pin === ADMIN_SECRET) {
    roleSelection.classList.add('hidden');
    adminLoginBox.classList.add('hidden');
    adminDashboard.classList.remove('hidden');
    fetchAndRenderAdmin();
  } else {
    showNotification('Invalid admin secret');
  }
});

/* Enter dashboard after login/registration */
function enterDashboard() {
  initSocket();
  authSelection.classList.add('hidden');
  loginBox.classList.add('hidden');
  registerBox.classList.add('hidden');
  qs('user-blocked').classList.add('hidden');
  adminDashboard.classList.add('hidden');
  mainDashboard.classList.remove('hidden');
  qs('dashboard-role-display').textContent = userProfile.userRole;
  qs('user-pin-display').textContent = userProfile.pinCode || '';
  qs('user-blood-display').textContent = userProfile.bloodType || '';
  qs('donor-status').textContent = userProfile.status || '';

  // Apply hospital-only visibility rules:
  if (userProfile.userRole === 'Donor') {
    document.querySelectorAll('.hospital-only').forEach(el => el.classList.add('hidden-for-donor'));
    tabDonorBtn.classList.add('border-b-2','border-red-600');
    tabRequestBtn.classList.add('hidden-for-donor');
    donorView.classList.remove('hidden');
    requestView.classList.add('hidden');
  } else if (userProfile.userRole === 'Hospital') {
    document.querySelectorAll('.hospital-only').forEach(el => el.classList.remove('hidden-for-donor'));
    tabRequestBtn.classList.remove('hidden-for-donor');
    requestView.classList.remove('hidden');
    donorView.classList.remove('hidden');
  } else if (userProfile.userRole === 'Admin') {
    mainDashboard.classList.add('hidden');
    adminDashboard.classList.remove('hidden');
  }

  fetchAndSync();
}

/* Logout */
qs('logout-btn').addEventListener('click', ()=> {
  userProfile = null;
  localStorage.removeItem(USER_KEY);
  mainDashboard.classList.add('hidden');
  roleSelection.classList.remove('hidden');
  document.querySelectorAll('.hospital-only').forEach(el => el.classList.add('hidden-for-donor'));
});

/* Blocked logout */
qs('blocked-logout-btn').addEventListener('click', ()=> {
  qs('user-blocked').classList.add('hidden');
  roleSelection.classList.remove('hidden');
});

/* Tab switching */
tabRequestBtn.addEventListener('click', ()=> {
  if (tabRequestBtn.classList.contains('hidden-for-donor')) return;
  requestView.classList.remove('hidden');
  donorView.classList.add('hidden');
  tabRequestBtn.classList.add('border-b-2','border-red-600');
  tabDonorBtn.classList.remove('border-b-2','border-red-600');
});
tabDonorBtn.addEventListener('click', ()=> {
  donorView.classList.remove('hidden');
  requestView.classList.add('hidden');
  tabDonorBtn.classList.add('border-b-2','border-red-600');
  tabRequestBtn.classList.remove('border-b-2','border-red-600');
});

/* ----- Submit request (HOSPITAL only) ----- */
qs('request-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!userProfile || userProfile.userRole !== 'Hospital') {
    showNotification('Only hospitals can submit requests.');
    return;
  }
  const payload = {
    requesterId: userProfile.userId,
    name: userProfile.name,
    phone: userProfile.phone,
    userRole: 'Hospital', // backend requires Hospital
    pinCode: (qs('request-pinCode').value || '').toString(),
    bloodTypeNeeded: qs('bloodTypeNeeded').value,
    createdAt: new Date().toISOString()
  };
  // POST to /api/request (note: api.js uses router.post('/request', ...))
  const res = await API.post('/request', payload);
  if (!res.ok) {
    showNotification('Request failed: ' + (res.json?.error || res.status));
    return;
  }
  showNotification('Request submitted successfully.');
  // emit socket event to server if available (server will broadcast to others anyway)
  if (socket) socket.emit('newRequest', res.json.request);
  qs('request-form').reset();
  fetchAndSync();
});

/* ======= Data fetching & rendering ======= */
async function fetchAndSync() {
  // call /api/sync-storage to get { users, requests }
  const res = await API.get('/sync-storage');
  if (!res.ok) {
    showNotification('Sync failed: ' + res.status);
    // fallback: try to fetch requests only
    await fetchRequestsOnly();
    return;
  }
  const users = res.json.users || [];
  const requests = res.json.requests || [];
  // render requests list for donors & admin
  renderRequests(requests);
  // if last used matched pin show donors (no geo coords in backend)
  // refresh admin lists if admin
  renderAdminLists(users, requests);
}

async function fetchRequestsOnly() {
  // fallback: try to fetch donors or requests through other endpoints if available
  const resAll = await API.get('/sync-storage');
  if (resAll.ok) {
    renderRequests(resAll.json.requests || []);
    renderAdminLists(resAll.json.users || [], resAll.json.requests || []);
  } else {
    showNotification('Unable to load requests.');
  }
}

function renderRequests(requests) {
  const list = qs('requests-list');
  list.innerHTML = '';
  if (!requests || requests.length === 0) {
    const p = createElem('div','p-3 bg-green-50 rounded text-gray-600'); p.textContent = 'No active matching requests at the moment.';
    list.appendChild(p);
    return;
  }
  // For donors: filter requests by their pin (if available)
  let filtered = requests;
  if (userProfile && userProfile.userRole === 'Donor' && userProfile.pinCode) {
    filtered = requests.filter(r => r.pinCode === userProfile.pinCode && (r.status === 'PENDING' || !r.status));
  }
  if (filtered.length === 0) {
    const p = createElem('div','p-3 bg-green-50 rounded text-gray-600'); p.textContent = 'No active requests in your area.';
    list.appendChild(p);
    return;
  }
  filtered.forEach(r => {
    const card = createElem('div','p-3 bg-white rounded shadow border');
    card.innerHTML = `<div class="flex justify-between items-start">
      <div>
        <div class="text-sm text-gray-500">Requested by: <strong>${escapeHTML(r.name || r.requesterName || 'Hospital')}</strong></div>
        <div class="text-lg font-semibold">${escapeHTML(r.bloodTypeNeeded || r.bloodType)} ‚Ä¢ Pin ${escapeHTML(r.pinCode)}</div>
        <div class="text-xs text-gray-500">Status: ${(r.status || 'PENDING')}</div>
      </div>
    </div>`;
    list.appendChild(card);
  });
}

/* Render donors list (for hospital after submitting a pin & bloodTypeNeeded) */
async function renderDonorsFor(pin, bloodType) {
  const donorsList = qs('donors-list');
  donorsList.innerHTML = '';
  if (!pin || !bloodType) {
    donorsList.appendChild(createElem('div','p-3 text-gray-600 bg-yellow-50 rounded') ).textContent = 'Provide pin and blood type to find donors.';
    return;
  }
  // GET /api/donors?pin=560078&bloodType=A+
  const res = await API.get(`/donors?pin=${encodeURIComponent(pin)}&bloodType=${encodeURIComponent(bloodType)}`);
  if (!res.ok) {
    donorsList.appendChild(createElem('div','p-3 text-gray-600 bg-red-50 rounded')).textContent = 'Failed to fetch donors.';
    return;
  }
  const donors = res.json.donors || [];
  if (donors.length === 0) {
    donorsList.appendChild(createElem('div','p-3 text-gray-600 bg-yellow-50 rounded')).textContent = 'No verified donors found for this pin & blood type.';
    return;
  }

  // Render each donor
  donors.forEach(d => {
    const card = createElem('div','p-3 bg-white rounded shadow border flex justify-between');
    card.innerHTML = `<div>
      <div class="font-semibold">${escapeHTML(d.name || 'Donor')}</div>
      <div class="text-xs text-gray-500">${escapeHTML(d.bloodType || '')} ‚Ä¢ Pin ${escapeHTML(d.pinCode || '')}</div>
      <div class="text-xs text-gray-500 mt-1">Phone: ${escapeHTML(d.phone || '‚Äî')}</div>
    </div>`;
    donorsList.appendChild(card);
  });

  // Show matched pin
  qs('matched-pin-display').textContent = pin;
  // If you want to show them on the map, you'd need to extend backend with coords. For now we show no markers.
}

/* Admin rendering helpers */
function renderAdminLists(users, requests) {
  // Pending users
  const pendingUsersList = qs('pending-users-list');
  pendingUsersList.innerHTML = '';
  (users || []).filter(u => u.status === 'PENDING_VERIFICATION').forEach(u => {
    const card = createElem('div','p-3 bg-white rounded border flex justify-between items-center');
    card.innerHTML = `<div>
      <div class="font-semibold">${escapeHTML(u.name)}</div>
      <div class="text-xs text-gray-500">Phone: ${escapeHTML(u.phone || '')} ‚Ä¢ Role: ${escapeHTML(u.userRole)}</div>
    </div>`;
    const btns = createElem('div','flex space-x-2');
    const approveBtn = createElem('button','px-3 py-1 rounded bg-green-600 text-white text-sm'); approveBtn.textContent='Approve';
    approveBtn.addEventListener('click', ()=> adminApproveUser(u.userId));
    btns.appendChild(approveBtn);
    card.appendChild(btns);
    pendingUsersList.appendChild(card);
  });

  // All users
  const allUsersList = qs('all-users-list'); allUsersList.innerHTML = '';
  (users || []).forEach(u => {
    const card = createElem('div','p-3 bg-white rounded border');
    card.innerHTML = `<div class="font-semibold">${escapeHTML(u.name)} <span class="text-xs text-gray-500">(${escapeHTML(u.userRole)})</span></div>
      <div class="text-xs text-gray-500">Phone: ${escapeHTML(u.phone || '')} ‚Ä¢ Pin: ${escapeHTML(u.pinCode || '')} ‚Ä¢ Status: ${escapeHTML(u.status || '')}</div>`;
    allUsersList.appendChild(card);
  });

  // Pending requests
  const pendingReqsList = qs('pending-requests-list'); pendingReqsList.innerHTML = '';
  (requests || []).filter(r => (r.status === 'PENDING' || !r.status)).forEach(r => {
    const card = createElem('div','p-3 bg-white rounded border flex justify-between items-center');
    card.innerHTML = `<div>
      <div class="font-semibold">${escapeHTML(r.bloodTypeNeeded || r.bloodType)} ‚Ä¢ Pin ${escapeHTML(r.pinCode)}</div>
      <div class="text-xs text-gray-500">By: ${escapeHTML(r.name || r.requesterName || 'Hospital')}</div>
    </div>`;
    const btns = createElem('div','flex space-x-2');
    const approveBtn = createElem('button','px-3 py-1 rounded bg-green-600 text-white text-sm'); approveBtn.textContent='Approve';
    approveBtn.addEventListener('click', ()=> adminApproveRequest(r._id, 'approve'));
    const denyBtn = createElem('button','px-3 py-1 rounded bg-red-600 text-white text-sm'); denyBtn.textContent='Deny';
    denyBtn.addEventListener('click', ()=> adminApproveRequest(r._id, 'deny'));
    btns.appendChild(approveBtn); btns.appendChild(denyBtn);
    card.appendChild(btns);
    pendingReqsList.appendChild(card);
  });
}

/* Admin actions (call backend admin routes with adminSecret query param) */
async function adminApproveUser(userId) {
  const res = await API.put(`/admin/approve-user/${encodeURIComponent(userId)}?adminSecret=${encodeURIComponent(ADMIN_SECRET)}`, {});
  if (!res.ok) { showNotification('Approve user failed'); return; }
  showNotification('User approved');
  fetchAndSync();
}
async function adminApproveRequest(requestId, action) {
  const res = await API.put(`/admin/approve-request/${encodeURIComponent(requestId)}?adminSecret=${encodeURIComponent(ADMIN_SECRET)}`, { action });
  if (!res.ok) { showNotification('Action failed'); return; }
  showNotification('Action completed');
  fetchAndSync();
}
async function fetchAndRenderAdmin() {
  // fetch pending via admin protected endpoint (server expects adminSecret)
  const usersRes = await API.get(`/admin/pending-users?adminSecret=${encodeURIComponent(ADMIN_SECRET)}`);
  if (usersRes.ok) {
    const users = usersRes.json.users || [];
    renderAdminLists(users, []);
  } else {
    showNotification('Could not load admin lists');
  }
}

/* Utility: escape text for DOM insertion */
function escapeHTML(s) {
  if (!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ======= Initial load: check saved user profile ======= */
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem(USER_KEY);
  if (saved) {
    try { userProfile = JSON.parse(saved); } catch(e){ userProfile=null; }
  }
  if (userProfile) enterDashboard();
  else {
    // show role selection
    qs('loading-state')?.classList?.add('hidden');
    roleSelection.classList.remove('hidden');
  }
  // init a simple map container (no markers without coords)
  try {
    const map = L.map('donorMap', { attributionControl: false }).setView([12.97,77.59], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
  } catch (e) { console.warn('Leaflet init error', e); }
  initSocket();
});

/* Fetch donors when hospital changes pin/bloodType or after request */
qs('submit-request-btn')?.addEventListener('click', ()=> {
  const pin = qs('request-pinCode').value.trim();
  const bloodType = qs('bloodTypeNeeded').value;
  if (pin && bloodType) renderDonorsFor(pin, bloodType);
});

/* Sync fetch helper */
async function fetchAndSync() {
  await fetchAndSyncInternal();
}
async function fetchAndSyncInternal() {
  const res = await API.get('/sync-storage');
  if (!res.ok) {
    showNotification('Could not fetch data from server.');
    return;
  }
  const users = res.json.users || [];
  const requests = res.json.requests || [];
  renderRequests(requests);
  renderAdminLists(users, requests);
  // If hospital and latest submitted pin/blood present, fetch donors for that pin
  const pin = qs('request-pinCode').value.trim();
  const btype = qs('bloodTypeNeeded').value;
  if (pin && btype && userProfile && userProfile.userRole === 'Hospital') {
    await renderDonorsFor(pin, btype);
  }
}

/* Expose since some handlers call it */
window.fetchAndSync = fetchAndSync;
window.renderDonorsFor = renderDonorsFor;
</script>
</body>
</html>