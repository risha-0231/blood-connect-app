<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Connect Pro (Bengaluru Area Donor Matching)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
   
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js" integrity="" crossorigin="anonymous"></script>
   
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .btn-primary { background-color: #e53e3e; transition: background-color 0.15s ease, transform 0.1s ease; }
        .btn-primary:hover { background-color: #c53030; transform: translateY(-1px); }
        .main-card { background-color: #ffffff; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border-radius: 0.75rem; padding: 1.5rem; }
        .blood-type-label { display: inline-block; padding: 0.25rem 0.75rem; font-weight: 700; border-radius: 9999px; text-align: center; }
        .type-A-pos { background-color: #f59e0b; color: #fff; }
        .type-A-neg { background-color: #d97706; color: #fff; }
        .type-B-pos { background-color: #10b981; color: #fff; }
        .type-B-neg { background-color: #059669; color: #fff; }
        .type-O-pos { background-color: #3b82f6; color: #fff; }
        .type-O-neg { background-color: #2563eb; color: #fff; }
        .type-AB-pos { background-color: #a855f7; color: #fff; }
        .type-AB-neg { background-color: #7c3aed; color: #fff; }
        #map { height: 300px; border-radius: 0.5rem; margin-top: 1rem; }
        .tab-button.active { border-bottom: 3px solid #e53e3e; font-weight: 700; color: #e53e3e; }
        .tab-button { transition: all 0.15s ease; padding-bottom: 0.5rem; }
        .modal { display: none; background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>

    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">
        <div id="main-content" class="main-card w-full lg:max-w-4xl">
            <h1 class="text-3xl font-extrabold text-red-600 mb-6 text-center">Blood Connect Pro</h1>
            <div id="view-container">
                <!-- Views will be rendered here -->
            </div>
            
            <!-- Global Notification Area -->
            <div id="notification-area" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 z-50 modal flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <div id="modal-body"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg transition hover:bg-gray-300">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 btn-primary text-white rounded-lg">Confirm</button>
            </div>
        </div>
    </div>
    
<script>
    // --- Global Variables ---
    const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:4000/api' : '/api';
    const ADMIN_SECRET = 'hellowrld'; // WARNING: Hardcoded for demo/admin access
    let userProfile = null;
    let allUsers = [];
    let allRequests = [];
    let socket;

    // --- Utility Functions ---

    // A map to get the correct Tailwind color class for each blood type
    const bloodTypeToClass = {
        'A+': 'type-A-pos', 'A-': 'type-A-neg',
        'B+': 'type-B-pos', 'B-': 'type-B-neg',
        'O+': 'type-O-pos', 'O-': 'type-O-neg',
        'AB+': 'type-AB-pos', 'AB-': 'type-AB-neg',
    };

    // Helper to render blood type label
    function getBloodTypeLabel(type) {
        const cls = bloodTypeToClass[type] || 'bg-gray-500 text-white';
        return `<span class="blood-type-label ${cls}">${type}</span>`;
    }

    // Helper for making API calls
    const API = {
        async post(url, data) {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            return res.json();
        },
        async get(url) {
            const res = await fetch(url);
            return res.json();
        },
        async put(url, data = {}) {
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            return res.json();
        }
    };

    // Notification UI
    function showNotification(message, color = 'red') {
        const area = document.getElementById('notification-area');
        const notification = document.createElement('div');
        let bgColor, textColor;

        switch (color) {
            case 'green':
                bgColor = 'bg-green-500';
                textColor = 'text-white';
                break;
            case 'blue':
                bgColor = 'bg-blue-500';
                textColor = 'text-white';
                break;
            case 'red':
            default:
                bgColor = 'bg-red-500';
                textColor = 'text-white';
                break;
        }

        notification.className = `p-3 rounded-lg shadow-lg ${bgColor} ${textColor} text-sm max-w-xs transition-opacity duration-300 opacity-0 transform translate-x-10`;
        notification.textContent = message;

        area.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.classList.remove('opacity-0', 'translate-x-10');
            notification.classList.add('opacity-100', 'translate-x-0');
        }, 10);

        // Animate out and remove
        setTimeout(() => {
            notification.classList.remove('opacity-100', 'translate-x-0');
            notification.classList.add('opacity-0', 'translate-x-10');
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    // Custom Modal / Confirmation Dialog
    function showCustomConfirm(title, message, onConfirm) {
        const modal = document.getElementById('modal-container');
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = `<p class="text-gray-600">${message}</p>`;

        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');

        const confirmHandler = () => {
            modal.style.display = 'none';
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
            onConfirm(true);
        };
        const cancelHandler = () => {
            modal.style.display = 'none';
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
            onConfirm(false);
        };

        confirmBtn.textContent = 'Yes, Proceed';
        cancelBtn.textContent = 'Cancel';
        
        confirmBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', cancelHandler);
        
        modal.style.display = 'flex';
    }


    // --- State Management ---
    function saveProfile(profile) {
        userProfile = profile;
        localStorage.setItem('userProfile', JSON.stringify(profile));
    }

    function loadProfile() {
        const storedProfile = localStorage.getItem('userProfile');
        if (storedProfile) {
            userProfile = JSON.parse(storedProfile);
        }
    }

    function clearProfile() {
        userProfile = null;
        localStorage.removeItem('userProfile');
        initializeApp();
    }
    
    // --- Data Synchronization ---
    async function fetchAndSyncUsers() {
        try {
            const data = await API.get(`${API_BASE}/sync-storage`);
            if (data.users && data.requests) {
                allUsers = data.users;
                allRequests = data.requests;
                // Re-render the current view to reflect new data
                if (userProfile && userProfile.userRole === 'Admin') {
                    renderAdminPendingUsers(); 
                    renderAdminRequests();
                } else if (userProfile && userProfile.status === 'VERIFIED') {
                    // Update userProfile from the synced data
                    const updatedProfile = allUsers.find(u => u.userId === userProfile.userId);
                    if (updatedProfile) {
                        saveProfile(updatedProfile);
                    }
                    renderDonors(getMatchingDonors(allRequests, allUsers, userProfile));
                    renderMyRequests();
                }
            }
        } catch (error) {
            console.error('Failed to sync data:', error);
            showNotification('Failed to load data from server. Please refresh.', 'red');
        }
    }


    // --- UI Elements (Placeholders for easier access) ---
    const ui = {};

    function setupUIReferences() {
        ui.viewContainer = document.getElementById('view-container');
        ui.mainContent = document.getElementById('main-content');
        ui.profileForm = document.getElementById('profile-form');
        ui.dashboardTabs = document.getElementById('dashboard-tabs');
        ui.userRole = document.getElementById('userRole');
        ui.bloodType = document.getElementById('bloodType');
        ui.pinCode = document.getElementById('pinCode');
        ui.lastDonationDateInput = document.getElementById('lastDonationDate');
        ui.requestBloodType = document.getElementById('requestBloodType');
        ui.requestPinCode = document.getElementById('requestPinCode');
    }

    // --- RENDER VIEWS ---

    function showRoleSelection() {
        ui.viewContainer.innerHTML = `
            <div class="text-center p-8 bg-gray-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Welcome to Blood Connect Pro</h2>
                <p class="mb-8 text-gray-600">Please choose your role to register or log in.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button onclick="showRegistration('Donor')" class="w-full sm:w-1/2 p-4 text-lg bg-red-600 text-white rounded-xl shadow-lg hover:bg-red-700 transition">
                        I am a Donor
                    </button>
                    <button onclick="showRegistration('Hospital')" class="w-full sm:w-1/2 p-4 text-lg bg-blue-600 text-white rounded-xl shadow-lg hover:bg-blue-700 transition">
                        I am a Hospital
                    </button>
                </div>
            </div>
        `;
    }

    function showRegistration(role) {
        const requiredIfDonor = role === 'Donor' ? 'required' : '';
        const donorOnlyFields = role === 'Donor' ? `
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="bloodType" class="block text-sm font-medium text-gray-700">Blood Type *</label>
                    <select id="bloodType" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" ${requiredIfDonor}>
                        <option value="">Select</option>
                        <option value="A+">A+</option><option value="A-">A-</option>
                        <option value="B+">B+</option><option value="B-">B-</option>
                        <option value="O+">O+</option><option value="O-">O-</option>
                        <option value="AB+">AB+</option><option value="AB-">AB-</option>
                    </select>
                </div>
                <div>
                    <label for="lastDonationDate" class="block text-sm font-medium text-gray-700">Last Donation Date</label>
                    <input type="date" id="lastDonationDate" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700">Age *</label>
                    <input type="number" id="age" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" min="18" max="65" ${requiredIfDonor}>
                </div>
                <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg) *</label>
                    <input type="number" id="weight" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" min="50" ${requiredIfDonor}>
                </div>
                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-700">Gender *</label>
                    <select id="gender" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" ${requiredIfDonor}>
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="col-span-full">
                <label for="bloodReportLink" class="block text-sm font-medium text-gray-700">Blood Report Link (Optional)</label>
                <input type="url" id="bloodReportLink" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" placeholder="https://drive.google.com/link">
            </div>
        ` : '';

        ui.viewContainer.innerHTML = `
            <div class="max-w-xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center text-${role === 'Donor' ? 'red' : 'blue'}-600">
                    ${role} Registration
                </h2>
                <form id="profile-form" class="space-y-4">
                    <input type="hidden" id="userRole" value="${role}">
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Name / Hospital Name *</label>
                            <input type="text" id="name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" required>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number (Login Key) *</label>
                            <input type="tel" id="phone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="pinCode" class="block text-sm font-medium text-gray-700">Pincode (e.g., 560001) *</label>
                            <input type="text" id="pinCode" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" pattern="[0-9]{6}" title="Must be a 6-digit number" required>
                        </div>
                        <div class="col-span-1">
                            <label for="address" class="block text-sm font-medium text-gray-700">Address *</label>
                            <input type="text" id="address" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" required>
                        </div>
                    </div>
                    
                    ${donorOnlyFields}

                    <button type="submit" class="w-full py-3 mt-4 btn-primary text-white rounded-lg text-lg transition">
                        Register
                    </button>

                    <button type="button" onclick="showLogin()" class="w-full py-3 text-sm text-gray-600 hover:text-red-600 transition">
                        Already Registered? Log In
                    </button>
                    <button type="button" onclick="showRoleSelection()" class="w-full py-3 text-sm text-gray-600 hover:text-red-600 transition">
                        &larr; Back to Role Selection
                    </button>
                </form>
            </div>
        `;
        setupUIReferences();
        if (ui.lastDonationDateInput) {
             ui.lastDonationDateInput.max = new Date().toISOString().split('T')[0];
        }
        document.getElementById('profile-form').onsubmit = handleRegistration;
    }

    function showLogin() {
        ui.viewContainer.innerHTML = `
            <div class="max-w-md mx-auto p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Log In</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="loginPhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="loginPhone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" required>
                    </div>
                    <button type="submit" class="w-full py-3 mt-4 btn-primary text-white rounded-lg text-lg transition">
                        Log In
                    </button>
                    <button type="button" onclick="showRoleSelection()" class="w-full py-3 text-sm text-gray-600 hover:text-red-600 transition">
                        &larr; Back to Registration
                    </button>
                </form>
            </div>
        `;
        document.getElementById('login-form').onsubmit = handleLogin;
    }

    function showDashboard() {
        ui.viewContainer.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Welcome, ${userProfile.name}</h2>
                <button onclick="clearProfile()" class="text-sm text-gray-500 hover:text-red-500 transition">Log Out</button>
            </div>
            
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="flex-shrink-0 text-blue-700">
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            Your status: <span class="font-semibold">${userProfile.status}</span>. Role: <span class="font-semibold">${userProfile.userRole}</span>.
                        </p>
                    </div>
                </div>
            </div>

            <div class="flex border-b border-gray-200 mb-4" id="dashboard-tabs">
                <button class="tab-button p-2 mr-4 text-gray-600 active" data-target="donors-tab">
                    ${userProfile.userRole === 'Donor' ? 'Active Requests' : 'Find Donors'}
                </button>
                <button class="tab-button p-2 mr-4 text-gray-600" data-target="my-requests-tab">
                    ${userProfile.userRole === 'Donor' ? 'My Donor Status' : 'My Requests'}
                </button>
                <button class="tab-button p-2 text-gray-600" data-target="profile-tab">
                    My Profile
                </button>
            </div>

            <!-- Tab Content -->
            <div id="donors-tab" class="tab-content">
                <div id="donor-actions" class="mb-4">
                    ${userProfile.userRole === 'Hospital' ? `
                        <button onclick="showRequestModal()" class="btn-primary text-white px-4 py-2 rounded-lg shadow-md transition">
                            Request Blood
                        </button>
                    ` : `
                        <p class="text-sm text-gray-500 italic">As a Donor, you can view the active blood requests from Hospitals in this area.</p>
                    `}
                </div>
                <div id="donors-list" class="space-y-4">
                    <!-- Donors or Active Requests will be listed here -->
                    <p class="text-center text-gray-500">Loading donor matches or active requests...</p>
                </div>
            </div>

            <div id="my-requests-tab" class="tab-content hidden">
                <div id="my-requests-list" class="space-y-4">
                    <!-- My Requests (Hospital) or Donor Status (Donor) will be listed here -->
                </div>
            </div>

            <div id="profile-tab" class="tab-content hidden">
                <div id="profile-details" class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <p><strong>Role:</strong> ${userProfile.userRole}</p>
                    <p><strong>Phone:</strong> ${userProfile.phone}</p>
                    <p><strong>Pincode:</strong> ${userProfile.pinCode}</p>
                    ${userProfile.userRole === 'Donor' ? `
                        <p><strong>Blood Type:</strong> ${getBloodTypeLabel(userProfile.bloodType)}</p>
                        <p><strong>Last Donation:</strong> ${userProfile.lastDonationTime ? new Date(userProfile.lastDonationTime).toLocaleDateString() : 'N/A'}</p>
                        <p><strong>Age/Weight:</strong> ${userProfile.age} / ${userProfile.weight} kg</p>
                        <p><strong>Report Link:</strong> ${userProfile.bloodReportLink || 'N/A'}</p>
                    ` : ''}
                </div>
            </div>
        `;
        setupUIReferences();
        setupTabs();
        fetchAndSyncUsers();
    }
    
    function showUserBlocked() {
         ui.viewContainer.innerHTML = `
            <div class="text-center p-8 bg-yellow-50 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-yellow-700">Account Pending Verification</h2>
                <p class="mb-6 text-gray-600">
                    Thank you for registering. Your account is currently in the **${userProfile.status}** state.
                    Please wait for an administrator to verify your profile before you can access the dashboard.
                </p>
                <p class="text-sm text-gray-500">Status will update automatically once approved.</p>
                <button onclick="clearProfile()" class="mt-6 text-sm text-gray-500 hover:text-red-500 transition">Log Out</button>
            </div>
        `;
    }
    
    function showAdminDashboard() {
        ui.viewContainer.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
                <button onclick="clearProfile()" class="text-sm text-gray-500 hover:text-red-500 transition">Log Out</button>
            </div>

            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded-lg shadow-sm">
                <p class="text-sm text-red-700 font-semibold">
                    ADMIN MODE: You have access to all system data and control features.
                </p>
            </div>

            <div class="flex border-b border-gray-200 mb-4" id="admin-tabs">
                <button class="tab-button p-2 mr-4 text-gray-600 active" data-target="pending-users-tab">
                    Pending Users
                </button>
                <button class="tab-button p-2 text-gray-600" data-target="all-requests-tab">
                    Manage Requests
                </button>
            </div>

            <!-- Tab Content: Pending Users -->
            <div id="pending-users-tab" class="tab-content">
                <h3 class="text-xl font-semibold mb-4">Users Pending Verification</h3>
                <div id="pending-users-list" class="space-y-4">
                    <p class="text-center text-gray-500">Loading pending users...</p>
                </div>
            </div>

            <!-- Tab Content: Manage Requests -->
            <div id="all-requests-tab" class="tab-content hidden">
                 <h3 class="text-xl font-semibold mb-4">All Blood Requests</h3>
                <div id="admin-requests-list" class="space-y-4">
                    <p class="text-center text-gray-500">Loading requests...</p>
                </div>
            </div>
        `;
        setupUIReferences();
        setupTabs();
        fetchAndSyncUsers();
    }


    // --- HANDLERS AND LOGIC ---

    function setupTabs() {
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                contents.forEach(c => c.classList.add('hidden'));
                const targetId = tab.getAttribute('data-target');
                document.getElementById(targetId).classList.remove('hidden');
                
                // Trigger re-render of relevant content on tab switch
                if (targetId === 'all-requests-tab') renderAdminRequests();
                if (targetId === 'pending-users-tab') renderAdminPendingUsers();
                if (targetId === 'donors-tab' && userProfile.userRole === 'Hospital') {
                     renderDonors(getMatchingDonors(allRequests, allUsers, userProfile));
                } else if (targetId === 'donors-tab' && userProfile.userRole === 'Donor') {
                     renderDonors(getDonorViewRequests(allRequests, allUsers));
                } else if (targetId === 'my-requests-tab') {
                    renderMyRequests();
                }
            });
        });
        
        // Initial render of the first tab's content
        const activeTabTarget = tabs[0].getAttribute('data-target');
        if (activeTabTarget === 'donors-tab' && userProfile.userRole === 'Hospital') {
             renderDonors(getMatchingDonors(allRequests, allUsers, userProfile));
        } else if (activeTabTarget === 'donors-tab' && userProfile.userRole === 'Donor') {
             renderDonors(getDonorViewRequests(allRequests, allUsers));
        } else if (activeTabTarget === 'my-requests-tab') {
            renderMyRequests();
        }
    }
    
    function getMatchingDonors(requests, users, profile) {
        if (profile.userRole !== 'Hospital') return [];

        const activeRequest = requests.find(r => r.requesterId === profile.userId && r.status === 'APPROVED');
        if (!activeRequest) return [];

        const matchingDonors = users.filter(u => 
            u.userRole === 'Donor' &&
            u.status === 'VERIFIED' &&
            u.pinCode === activeRequest.pinCode &&
            u.bloodType === activeRequest.bloodTypeNeeded &&
            !u.isRequestActive // Exclude donors who have an active request status (though they shouldn't)
        );
        return matchingDonors;
    }

    function getDonorViewRequests(requests, users) {
        if (userProfile.userRole !== 'Donor') return [];
        
        // Find all approved requests in the donor's pin code
        const activeRequests = requests.filter(r => 
            r.status === 'APPROVED' &&
            r.pinCode === userProfile.pinCode
        );

        // Enhance with requester name
        return activeRequests.map(req => {
            const requester = users.find(u => u.userId === req.requesterId);
            return {
                ...req,
                requesterName: requester ? requester.name : 'Unknown Hospital',
                requesterPhone: requester ? requester.phone : 'N/A'
            };
        });
    }

    // Renders either donor list (Hospital) or active requests list (Donor)
    function renderDonors(data) {
        const listEl = document.getElementById('donors-list');
        if (!listEl) return;
        listEl.innerHTML = '';
        
        if (userProfile.userRole === 'Hospital') {
            // HOSPITAL VIEW: List matching donors
            if (!userProfile.isRequestActive) {
                listEl.innerHTML = `<p class="text-center text-gray-500 p-4 bg-yellow-50 rounded-lg">You must have an <strong>APPROVED</strong> request to view matching donors in your area.</p>`;
                return;
            }

            if (data.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500">No verified donors matching your needs (${userProfile.bloodTypeNeeded} in Pincode ${userProfile.pinCode}) were found.</p>`;
                return;
            }

            data.forEach(donor => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border border-gray-100 flex justify-between items-center';
                card.innerHTML = `
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${donor.name}</p>
                        <p class="text-sm text-gray-500">Pincode: ${donor.pinCode} | Phone: ${donor.phone}</p>
                        <p class="text-sm text-gray-500">Last Donated: ${donor.lastDonationTime ? new Date(donor.lastDonationTime).toLocaleDateString() : 'N/A'}</p>
                    </div>
                    ${getBloodTypeLabel(donor.bloodType)}
                `;
                listEl.appendChild(card);
            });

        } else if (userProfile.userRole === 'Donor') {
            // DONOR VIEW: List active blood requests in the donor's pincode
            if (data.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 p-4 bg-green-50 rounded-lg">No active, approved blood requests were found in your area (${userProfile.pinCode}).</p>`;
                return;
            }
            
             data.forEach(req => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border border-gray-100';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-semibold text-red-600">${req.requesterName}</p>
                            <p class="text-sm text-gray-500">Pincode: ${req.pinCode} | Contact: ${req.requesterPhone}</p>
                        </div>
                        ${getBloodTypeLabel(req.bloodTypeNeeded)}
                    </div>
                    <p class="text-sm mt-2 text-gray-600">Blood Type Needed: <span class="font-bold">${req.bloodTypeNeeded}</span></p>
                `;
                listEl.appendChild(card);
            });
        }
    }


    // Renders the user's specific requests (Hospital) or status (Donor)
    function renderMyRequests() {
        const myListEl = document.getElementById('my-requests-list');
        if (!myListEl) return;
        myListEl.innerHTML = '';
        
        if (userProfile.userRole === 'Donor') {
            // DONOR STATUS
             myListEl.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg shadow-inner space-y-2">
                    <p class="text-lg font-semibold text-blue-800">Your Current Donor Status</p>
                    <p><strong>Pincode:</strong> ${userProfile.pinCode}</p>
                    <p><strong>Blood Type:</strong> ${getBloodTypeLabel(userProfile.bloodType)}</p>
                    <p><strong>Verification:</strong> <span class="font-bold text-${userProfile.status === 'VERIFIED' ? 'green' : 'orange'}-600">${userProfile.status}</span></p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow-sm mt-4">
                    <p class="text-sm text-yellow-800">
                        When an approved request matches your details, you will see a notification! Your profile is essential for helping others in your area.
                    </p>
                </div>
            `;
            return;
        }


        // HOSPITAL REQUESTS
        const myRequest = allRequests.find(r => r.requesterId === userProfile.userId);

        if (!myRequest) {
            myListEl.innerHTML = `
                <div class="text-center p-6 bg-gray-50 rounded-lg shadow-inner">
                    <p class="text-gray-600 mb-4">You currently do not have any active blood requests.</p>
                    <button onclick="showRequestModal()" class="btn-primary text-white px-4 py-2 rounded-lg shadow-md transition">
                        Create New Request
                    </button>
                </div>
            `;
            return;
        }

        const statusColor = { 'PENDING': 'orange-500', 'APPROVED': 'green-600', 'DENIED': 'red-500' }[myRequest.status] || 'gray-500';

        myListEl.innerHTML = `
            <div class="bg-white p-5 rounded-lg shadow-xl border border-gray-200">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-xl font-bold text-gray-800">Current Blood Request</h3>
                    <span class="text-sm font-semibold text-${statusColor} bg-${statusColor.split('-')[0]}-100 px-3 py-1 rounded-full">
                        Status: ${myRequest.status}
                    </span>
                </div>
                
                <p class="text-gray-700 mb-2"><strong>Blood Type Needed:</strong> ${getBloodTypeLabel(myRequest.bloodTypeNeeded)}</p>
                <p class="text-gray-600 mb-4"><strong>Pincode:</strong> ${myRequest.pinCode}</p>
                
                ${myRequest.status === 'APPROVED' ? `
                    <div class="bg-green-50 p-3 rounded-lg text-green-700 text-sm mb-4">
                        <p class="font-semibold">Request is LIVE!</p>
                        <p>Matching donors in your pincode are being notified.</p>
                    </div>
                    <button onclick="cancelMyRequest('${myRequest._id}')" class="text-sm text-red-600 hover:text-red-800 transition">
                        Close/Cancel Request
                    </button>
                ` : myRequest.status === 'PENDING' ? `
                    <div class="bg-yellow-50 p-3 rounded-lg text-yellow-700 text-sm mb-4">
                        <p class="font-semibold">Pending Admin Approval</p>
                        <p>Please wait for an administrator to approve this request.</p>
                    </div>
                    <button onclick="cancelMyRequest('${myRequest._id}')" class="text-sm text-red-600 hover:text-red-800 transition">
                        Cancel Request
                    </button>
                ` : `
                    <div class="bg-red-50 p-3 rounded-lg text-red-700 text-sm mb-4">
                        <p class="font-semibold">Request Denied or Cancelled</p>
                        <p>You can create a new request if needed.</p>
                    </div>
                `}
            </div>
        `;
    }

    function renderAdminPendingUsers() {
        const listEl = document.getElementById('pending-users-list');
        if (!listEl) return;
        listEl.innerHTML = '';
        
        const pendingUsers = allUsers.filter(u => u.status === 'PENDING_VERIFICATION');
        
        if (pendingUsers.length === 0) {
            listEl.innerHTML = `<p class="text-center text-gray-500">No users are currently pending verification.</p>`;
            return;
        }

        pendingUsers.forEach(user => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow border border-gray-100 flex justify-between items-center';
            card.innerHTML = `
                <div>
                    <p class="text-lg font-semibold text-gray-800">${user.name} (${user.userRole})</p>
                    <p class="text-sm text-gray-500">Phone: ${user.phone} | Pincode: ${user.pinCode}</p>
                    ${user.userRole === 'Donor' ? `<p class="text-sm text-gray-500">Blood: ${getBloodTypeLabel(user.bloodType)} | Age: ${user.age} | Weight: ${user.weight}kg</p>` : ''}
                </div>
                <button data-userid="${user.userId}" class="approve-user-btn bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition">
                    Approve
                </button>
            `;
            listEl.appendChild(card);
            
            card.querySelector('.approve-user-btn').addEventListener('click', (e) => {
                const userId = e.target.dataset.userid;
                 showCustomConfirm('Confirm Approval', `Are you sure you want to approve user ${user.name}?`, (confirmed) => {
                    if (confirmed) {
                        API.put(`${API_BASE}/admin/approve-user/${userId}?adminSecret=${ADMIN_SECRET}`);
                        // Data sync will handle re-render
                    }
                });
            });
        });
    }
    
    function renderAdminRequests() {
        const listEl = document.getElementById('admin-requests-list');
        if (!listEl) return;
        listEl.innerHTML = '';

        if (allRequests.length === 0) {
            listEl.innerHTML = `<p class="text-center text-gray-500">No requests in the system.</p>`;
            return;
        }

        const sortedRequests = [...allRequests].sort((a, b) => {
            if (a.status === 'PENDING' && b.status !== 'PENDING') return -1;
            if (a.status !== 'PENDING' && b.status === 'PENDING') return 1;
            return 0;
        });

        sortedRequests.forEach(req => {
            const requester = allUsers.find(u => u.userId === req.requesterId);
            const requesterName = requester ? requester.name : 'Unknown Hospital';
            const requesterPhone = requester ? requester.phone : 'N/A';
            
            const statusColor = { 'PENDING': 'orange', 'APPROVED': 'green', 'DENIED': 'red' }[req.status] || 'gray';
            const isPending = req.status === 'PENDING';
            
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow border border-gray-100';
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${requesterName}</p>
                        <p class="text-sm text-gray-500">Pincode: ${req.pinCode} | Phone: ${requesterPhone}</p>
                        <p class="text-sm text-gray-500 mt-1">
                            Status: <span class="font-bold text-${statusColor}-600">${req.status}</span>
                            | Requested: ${new Date(req.createdAt).toLocaleDateString()}
                        </p>
                    </div>
                    ${getBloodTypeLabel(req.bloodTypeNeeded)}
                </div>
                
                ${isPending ? `
                    <div class="mt-4 pt-3 border-t flex gap-3">
                        <button data-requestid="${req._id}" data-action="approve" class="admin-request-btn bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition">Approve</button>
                        <button data-requestid="${req._id}" data-action="deny" class="admin-request-btn bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition">Deny</button>
                    </div>
                ` : `
                    <div class="mt-4 pt-3 border-t text-sm text-gray-500 italic">
                        Action already taken.
                    </div>
                `}
            `;
            listEl.appendChild(card);
            
            if (isPending) {
                card.querySelectorAll('.admin-request-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const requestId = e.target.dataset.requestid;
                        const action = e.target.dataset.action;
                        const actionText = action === 'approve' ? 'Approve' : 'Deny';
                        
                        showCustomConfirm(`${actionText} Request`, `Are you sure you want to ${actionText.toLowerCase()} the request from ${requesterName}?`, (confirmed) => {
                             if (confirmed) {
                                API.put(`${API_BASE}/admin/approve-request/${requestId}?adminSecret=${ADMIN_SECRET}`, { action: action });
                                // Data sync will handle re-render
                            }
                        });
                    });
                });
            }
        });
    }

    // --- FORM SUBMISSIONS ---

    async function handleRegistration(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            userRole: form.userRole.value,
            name: form.name.value,
            phone: form.phone.value,
            pinCode: form.pinCode.value,
            address: form.address.value,
            status: 'PENDING_VERIFICATION', // All new users start here
        };

        if (data.userRole === 'Donor') {
            data.bloodType = form.bloodType.value;
            data.age = parseInt(form.age.value);
            data.weight = parseInt(form.weight.value);
            data.gender = form.gender.value;
            data.lastDonationTime = form.lastDonationDate.value ? new Date(form.lastDonationDate.value).getTime() : 0;
            data.bloodReportLink = form.bloodReportLink.value;
        }

        const result = await API.post(`${API_BASE}/auth/register`, data);

        if (result.error) {
            showNotification(result.error);
        } else {
            saveProfile(result.user);
            showNotification(`Registration successful! Please wait for admin verification.`, 'blue');
            showUserBlocked();
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const phone = document.getElementById('loginPhone').value;
        const result = await API.post(`${API_BASE}/auth/login`, { phone });

        if (result.error) {
            showNotification(result.error);
        } else {
            saveProfile(result.user);
            initializeApp();
        }
    }
    
    // --- HOSPITAL ACTIONS ---

    function showRequestModal() {
        const modal = document.getElementById('modal-container');
        document.getElementById('modal-title').textContent = 'Create Blood Request';
        document.getElementById('modal-body').innerHTML = `
            <form id="request-form" class="space-y-4">
                <div>
                    <label for="requestBloodType" class="block text-sm font-medium text-gray-700">Blood Type Needed *</label>
                    <select id="requestBloodType" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" required>
                        <option value="">Select</option>
                        <option value="A+">A+</option><option value="A-">A-</option>
                        <option value="B+">B+</option><option value="B-">B-</option>
                        <option value="O+">O+</option><option value="O-">O-</option>
                        <option value="AB+">AB+</option><option value="AB-">AB-</option>
                    </select>
                </div>
                <div>
                    <label for="requestPinCode" class="block text-sm font-medium text-gray-700">Pincode *</label>
                    <input type="text" id="requestPinCode" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" pattern="[0-9]{6}" title="Must be a 6-digit number" value="${userProfile.pinCode}" required readonly>
                </div>
            </form>
        `;

        const requestForm = document.getElementById('request-form');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');
        
        // Hide default buttons
        confirmBtn.style.display = 'none';
        cancelBtn.textContent = 'Close';

        // Add form submission listener
        requestForm.addEventListener('submit', handleRequestSubmit);
        
        // Use a generic close handler
        cancelBtn.onclick = () => {
            modal.style.display = 'none';
            requestForm.removeEventListener('submit', handleRequestSubmit);
        };
        
        // Replace confirm button with submit for the form
        const submitBtn = document.createElement('button');
        submitBtn.type = 'submit';
        submitBtn.textContent = 'Submit Request';
        submitBtn.className = 'px-4 py-2 btn-primary text-white rounded-lg';
        
        confirmBtn.parentNode.insertBefore(submitBtn, confirmBtn);
        submitBtn.addEventListener('click', (e) => {
            e.preventDefault();
            requestForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        });
        
        // Re-setup UI refs to get the new elements
        setupUIReferences();
        
        modal.style.display = 'flex';
    }
    
    async function handleRequestSubmit(e) {
        e.preventDefault();
        const modal = document.getElementById('modal-container');
        const form = document.getElementById('request-form');

        const requestData = {
            requesterId: userProfile.userId,
            name: userProfile.name,
            phone: userProfile.phone,
            userRole: userProfile.userRole,
            pinCode: form.requestPinCode.value,
            bloodTypeNeeded: form.requestBloodType.value,
        };

        const result = await API.post(`${API_BASE}/request`, requestData);

        if (result.error) {
            showNotification(result.error);
        } else {
            showNotification(`Request submitted for ${requestData.bloodTypeNeeded} in ${requestData.pinCode}. Waiting for admin approval.`, 'blue');
             // Update local profile to reflect active request
             const updatedProfile = {
                ...userProfile,
                isRequestActive: true,
                bloodTypeNeeded: requestData.bloodTypeNeeded,
                requestPinCode: requestData.pinCode,
            };
            saveProfile(updatedProfile);
            fetchAndSyncUsers(); // Re-sync to get the new request object
        }
        
        // Clean up modal
        modal.style.display = 'none';
        form.removeEventListener('submit', handleRequestSubmit);
        document.getElementById('modal-confirm-btn').remove(); // remove the temporary submit button
    }
    
    function cancelMyRequest(requestId) {
        showCustomConfirm('Cancel Request', 'Are you sure you want to cancel your active blood request? This action cannot be undone.', async (confirmed) => {
            if (confirmed) {
                const result = await API.put(`${API_BASE}/admin/approve-request/${requestId}?adminSecret=${ADMIN_SECRET}`, { action: 'deny' });

                if (result.error) {
                    showNotification(result.error);
                    return;
                }

                showNotification(`Your request has been officially closed.`, 'blue');
                fetchAndSyncUsers();
            }
        });
    }

    // --- SOCKET.IO ---
    function initializeSocket() {
        // Assume socket.io is running on the same host/port as the API base for simplicity
        socket = io(window.location.protocol + '//' + window.location.host, { path: '/socket.io' }); 

        socket.on('connect', () => {
            console.log('Socket Connected:', socket.id);
        });
        
        socket.on('disconnect', () => {
            console.log('Socket Disconnected');
        });

        socket.on('userVerified', (data) => {
            if (userProfile && userProfile.userId === data.userId) {
                showNotification(`ðŸŽ‰ Your account has been VERIFIED!`, 'green');
                // Force a sync to update the local profile status
                fetchAndSyncUsers();
            }
            if (userProfile && userProfile.userRole === 'Admin') {
                fetchAndSyncUsers();
            }
        });

        socket.on('newRequest', (data) => {
            if (userProfile && userProfile.userRole === 'Donor' && userProfile.pinCode === data.pinCode) {
                 showNotification(`ðŸš¨ New Blood Request in your area (${data.pinCode})! Blood Type: ${data.bloodTypeNeeded}`, 'red');
            }
            if (userProfile && userProfile.userRole === 'Admin') {
                fetchAndSyncUsers();
            }
        });
        
        socket.on('requestApproved', (data) => {
            if (userProfile) {
                // If I am the requesting hospital
                if (allRequests.some(r => r._id === data.requestId && r.requesterId === userProfile.userId)) {
                    showNotification(`âœ… Your request for ${data.bloodType} has been APPROVED!`, 'green');
                }
                
                // If I am a donor who matches the request
                if (userProfile.userRole === 'Donor' && data.donorIds.includes(userProfile.userId)) {
                    showNotification(`ðŸ©¸ MATCH FOUND! A verified request for ${data.bloodType} is active in your area. Check Active Requests tab.`, 'red');
                }
                
                // Admin needs to re-render
                 if (userProfile.userRole === 'Admin') {
                    fetchAndSyncUsers();
                }
            }
        });
        
        socket.on('requestDenied', (data) => {
             if (userProfile && allRequests.some(r => r._id === data.requestId && r.requesterId === userProfile.userId)) {
                showNotification(`âŒ Your request has been DENIED or cancelled.`, 'red');
                // The hospital needs to re-sync to clear their active request status
            }
            if (userProfile && userProfile.userRole === 'Admin') {
                fetchAndSyncUsers();
            }
        });

    }


    // --- START APPLICATION ---
    function initializeApp() {
        initializeSocket();
        loadProfile();
       
        if (userProfile && userProfile.userRole === 'Admin') {
            showAdminDashboard();
        } else if (userProfile && userProfile.status === 'VERIFIED') {
            showDashboard();
        } else if (userProfile && userProfile.status !== 'VERIFIED') {
             showUserBlocked();
        }
          else {
            showRoleSelection();
        }
         
        // Set up global UI refs (some will be null until views are rendered)
        setupUIReferences();
        
        // Set max date for last donation date
        if (ui.lastDonationDateInput) {
            ui.lastDonationDateInput.max = new Date().toISOString().split('T')[0];
        }
    }

    window.onload = initializeApp;
</script>
</body>
</html>